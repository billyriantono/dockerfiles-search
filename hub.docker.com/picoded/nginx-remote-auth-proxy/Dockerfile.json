{
  "MetaArgs": null,
  "Stages": [
    {
      "Name": "",
      "BaseName": "nginx:alpine",
      "SourceCode": "FROM            nginx:alpine",
      "Platform": "",
      "From": {
        "Image": "nginx:alpine"
      },
      "Commands": [
        {
          "Maintainer": "TIONG JIA MING \u003cjiaming@picoded.com\u003e",
          "Name": "maintainer"
        },
        {
          "CmdLine": [
            "mkdir /entrypoint;"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "Name": "expose",
          "Ports": [
            "80"
          ]
        },
        {
          "Env": [
            {
              "Key": "FORWARD_HOST",
              "Value": "webhost"
            }
          ],
          "Name": "env"
        },
        {
          "Env": [
            {
              "Key": "FORWARD_PORT",
              "Value": "80"
            }
          ],
          "Name": "env"
        },
        {
          "Env": [
            {
              "Key": "FORWARD_PROT",
              "Value": "\"http\""
            }
          ],
          "Name": "env"
        },
        {
          "Env": [
            {
              "Key": "AUTH_URL",
              "Value": "http://authhost/account/authentication-code"
            }
          ],
          "Name": "env"
        },
        {
          "Env": [
            {
              "Key": "LOGIN_URL",
              "Value": "http://loginserver/loginpage"
            }
          ],
          "Name": "env"
        },
        {
          "Env": [
            {
              "Key": "LOGIN_URL_MODE",
              "Value": "\"proxy\""
            }
          ],
          "Name": "env"
        },
        {
          "Env": [
            {
              "Key": "PROXY_READ_TIMEOUT",
              "Value": "600"
            }
          ],
          "Name": "env"
        },
        {
          "Env": [
            {
              "Key": "MAX_BODY_SIZE",
              "Value": "100M"
            }
          ],
          "Name": "env"
        },
        {
          "Env": [
            {
              "Key": "MAX_BUFFER_SIZE",
              "Value": "10M"
            }
          ],
          "Name": "env"
        },
        {
          "Env": [
            {
              "Key": "DNS",
              "Value": "\"\""
            }
          ],
          "Name": "env"
        },
        {
          "Env": [
            {
              "Key": "AUTH_BYPASS_REGEX",
              "Value": "\"\""
            }
          ],
          "Name": "env"
        },
        {
          "Env": [
            {
              "Key": "DNS_VALID_TIMEOUT",
              "Value": "1s"
            }
          ],
          "Name": "env"
        },
        {
          "CmdLine": [
            "echo '#!/bin/sh'                                                                                          \u003e /entrypoint/primer.sh \u0026\u0026 \techo '# Fetch the DNS resolver'                                                                            \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'RESOLVER=\"$DNS\"'                                                                                     \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'if [ -z \"$RESOLVER\" ]; then'                                                                         \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo '    RESOLVER=$(cat /etc/resolv.conf | grep \"nameserver\" | awk \"{print \\$2}\")'                        \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'fi'                                                                                                  \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'if [ -n \"$DNS_VALID_TIMEOUT\" ]; then'                                                                \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo '    RESOLVER=\"$RESOLVER valid=$DNS_VALID_TIMEOUT\"'                                                   \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'fi'                                                                                                  \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"resolver $RESOLVER ;\" \u003e /etc/nginx/resolvers.conf'                                             \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo ''                                                                                                    \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo '# Writes and setup the password'                                                                     \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"${HTPASSWD}\" \u003e /etc/nginx/auth.htpasswd'                                                       \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo ''                                                                                                    \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo '# Goes into the nginx config folder'                                                                 \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'cd /etc/nginx/conf.d/'                                                                               \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo ''                                                                                                    \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo '# Setup the server config'                                                                           \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"# http level config\"                                                          \u003e default.conf'  \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"client_max_body_size ${MAX_BODY_SIZE};\"                                       \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"\"                                                                             \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"server {\"                                                                     \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"   listen 80 default_server;\"                                                 \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"   client_max_body_size ${MAX_BODY_SIZE};\"                                    \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"   # Dynamic IP DNS workaround\"                                               \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"   include /etc/nginx/resolvers.conf;\"                                        \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"   # Handle any 401 errors, direct to /error401\"                              \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"   error_page 401 /error401;\"                                                 \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"\"                                                                             \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"   # Redirect user to login page\"                                             \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"   location = /error401 {\"                                                    \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"     internal;\"                                                               \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"     set \\$escape_uri \\$request_uri;\"                                         \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'if [  \"${LOGIN_URL_MODE}\" == \"redirect\" ]; then                                     \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo '   echo \"     return ${LOGIN_URL}?sourceurl=\\$original_url;\"                        \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'else                                                                                \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo '   echo \"     proxy_set_header Host \\$host;\"                                        \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo '   echo \"     proxy_set_header X-Forwarded-For \\$proxy_add_x_forwarded_for;\"        \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo '   echo \"     proxy_set_header X-REAL-IP \\$remote_addr;\"                            \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo '   echo \"     proxy_pass ${LOGIN_URL}?sourceurl=\\$escape_uri;\"                      \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'fi                                                                                  \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"   }\"                                                                         \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"\"                                                                             \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"   # All endpoints to hit here\"                                               \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"   location / {\"                                                              \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"     set \\$original_url \\$scheme://\\$http_host\\$request_uri;\"                 \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"     # Performs subrequest to check if allow\"                                 \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"     auth_request /auth;\"                                                     \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"     auth_request_set \\$auth_status \\$upstream_status;\"                       \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"\"                                                                             \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"     # Forward to the respective url\"                                         \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"     set \\$upstream \\\"${FORWARD_PROT}://${FORWARD_HOST}:${FORWARD_PORT}\\\";\"   \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"     proxy_set_header Host \\$host;\"                                           \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"     proxy_pass \\$upstream;\"                                                  \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"     proxy_read_timeout   ${PROXY_READ_TIMEOUT};\"                             \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"   }\"                                                                         \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"\"                                                                             \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'if [  -n \"${AUTH_BYPASS_REGEX}\" ]; then                                             \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo '   echo \"   location ~ ${AUTH_BYPASS_REGEX} {\"                                      \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo '   echo \"     # Forward to the respective url\"                                      \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo '   echo \"     set \\$upstream \\\"${FORWARD_PROT}://${FORWARD_HOST}:${FORWARD_PORT}\\\";\"\u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo '   echo \"     proxy_set_header Host \\$host;\"                                        \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo '   echo \"     proxy_pass \\$upstream;\"                                               \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo '   echo \"     proxy_read_timeout   ${PROXY_READ_TIMEOUT};\"                          \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo '   echo \"   }\"                                                                      \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'fi                                                                                  \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"\"                                                                             \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"   # Internal routing, check with API server if user is logged in\"            \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"   location = /auth {\"                                                        \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"     internal;\"                                                               \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"     proxy_pass_request_body off;\"                                            \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"     proxy_set_header Content-Length \\\"\\\";\"                                   \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"     proxy_set_header X-Original-URI \\$request_uri;\"                          \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"     proxy_set_header Host \\$http_host;\"                                      \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"     # Force Nginx to resolve DNS everytime;\"                                 \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"     set \\$auth_url ${AUTH_URL};\"                                             \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"     proxy_pass \\$auth_url;\"                                                  \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"   }\"                                                                         \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'echo \"}\"                                                                            \u003e\u003e default.conf' \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo ''                                                                                                    \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo '# Goes back to root folder'                                                                          \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'cd /'                                                                                                \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo ''                                                                                                    \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo '# Chain the execution commands'                                                                      \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \techo 'exec \"$@\"'                                                                                           \u003e\u003e /entrypoint/primer.sh \u0026\u0026 \tchmod +x /entrypoint/primer.sh \u0026\u0026 \t/entrypoint/primer.sh;"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "CmdLine": [
            "/entrypoint/primer.sh"
          ],
          "Name": "entrypoint",
          "PrependShell": false
        },
        {
          "CmdLine": [
            "nginx -g \"daemon off;\""
          ],
          "Name": "cmd",
          "PrependShell": true
        }
      ]
    }
  ]
}