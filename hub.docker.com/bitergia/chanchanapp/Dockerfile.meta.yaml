MetaArgs: null
Stages:
- BaseName: bitergia/ubuntu-trusty:latest
  Commands:
  - Maintainer: Alvaro del Castillo <acs@bitergia.com>
    Name: maintainer
  - Env:
    - Key: DEBIAN_FRONTEND
      Value: noninteractive
    Name: env
  - Env:
    - Key: DEPLOY_USER
      Value: bitergia
    Name: env
  - Env:
    - Key: DEPLOY_USER_DIR
      Value: /home/${DEPLOY_USER}
    Name: env
  - Env:
    - Key: SCRIPTS_DIR
      Value: ${DEPLOY_USER_DIR}/scripts
    Name: env
  - Env:
    - Key: CC_APP_SERVER_PATH
      Value: ${DEPLOY_USER_DIR}/fiware-chanchan/server
    Name: env
  - Env:
    - Key: CC_APP_CLIENT_PATH
      Value: ${DEPLOY_USER_DIR}/fiware-chanchan/client
    Name: env
  - Env:
    - Key: CC_HOSTNAME
      Value: chanchan.${HOSTNAME}
    Name: env
  - Env:
    - Key: CC_OAUTH_CREDENTIALS
      Value: /tmp/appoauth.txt
    Name: env
  - Env:
    - Key: CC_APP_URL
      Value: http://${CC_HOSTNAME}
    Name: env
  - Env:
    - Key: CC_APP_CALLBACK
      Value: ${CC_APP_URL}/login
    Name: env
  - CmdLine:
    - mkdir ${DEPLOY_USER_DIR}/scripts
    Name: run
    PrependShell: true
  - Chown: ""
    Name: add
    SourcesAndDest:
    - update_hosts.sh
    - ${DEPLOY_USER_DIR}/scripts/update_hosts.sh
  - Chown: ""
    Name: add
    SourcesAndDest:
    - configure-virtualhost.sh
    - ${DEPLOY_USER_DIR}/scripts/configure-virtualhost.sh
  - CmdLine:
    - apt-get update &&     apt-get -y install --no-install-recommends         bash         git
      git-core         tree ccze         psmisc         nodejs nodejs-legacy npm         apache2
      libapache2-mod-passenger         mysql-client         &&     apt-get clean &&     find
      /var/lib/apt/lists -type f -delete
    Name: run
    PrependShell: true
  - CmdLine:
    - mkdir fix-node-passenger &&     cd fix-node-passenger &&     apt-get update
      &&     apt-get install -qy dpkg-dev &&     sed -e 's/^deb /deb-src /g' /etc/apt/sources.list
      >> /etc/apt/sources.list.d/debsrc.list &&     apt-get update &&     apt-get
      source ruby-passenger &&     version=$( ls ruby-passenger*.orig.tar.gz | sed
      -e 's/^ruby-passenger_\(.*\).orig.tar.gz$/\1/' ) &&     cp -r ${PWD}/ruby-passenger-${version}/node_lib
      /usr/share/passenger/ &&     cd .. &&     rm -rf fix-node-passenger
    Name: run
    PrependShell: true
  - CmdLine:
    - a2enmod ssl && a2enmod passenger &&     a2dissite 000-default &&     service
      apache2 restart
    Name: run
    PrependShell: true
  - Name: user
    User: ${DEPLOY_USER}
  - Name: workdir
    Path: ${DEPLOY_USER_DIR}
  - CmdLine:
    - git clone https://github.com/Bitergia/fiware-chanchan.git fiware-chanchan
    Name: run
    PrependShell: true
  - CmdLine:
    - cd fiware-chanchan &&     if [ "${GIT_REV_CHANCHAN}" != "master" ]; then git
      checkout ${GIT_REV_CHANCHAN}; fi
    Name: run
    PrependShell: true
  - CmdLine:
    - cd ${CC_APP_SERVER_PATH} &&     npm install --loglevel warn
    Name: run
    PrependShell: true
  - CmdLine:
    - cd ${CC_APP_CLIENT_PATH} &&     export CI=true &&     npm install --loglevel
      warn
    Name: run
    PrependShell: true
  - Chown: ""
    Name: add
    SourcesAndDest:
    - idas-scripts
    - ${DEPLOY_USER_DIR}/scripts/idas-scripts
  - Chown: ""
    Name: add
    SourcesAndDest:
    - configure-chanchan.sh
    - ${DEPLOY_USER_DIR}/scripts/configure-chanchan.sh
  - Name: user
    User: root
  - CmdLine:
    - ${SCRIPTS_DIR}/configure-virtualhost.sh
    Name: run
    PrependShell: true
  - Env:
    - Key: CCLUSTER
      Value: configure-chanchanapp-cluster
    Name: env
  - Chown: ""
    Name: add
    SourcesAndDest:
    - ${CCLUSTER}
    - ${DEPLOY_USER_DIR}/scripts/${CCLUSTER}
  - CmdLine:
    - sudo cp ${SCRIPTS_DIR}/${CCLUSTER} /etc/init.d/${CCLUSTER} &&     sudo chmod
      +x /etc/init.d/${CCLUSTER} &&     sudo update-rc.d ${CCLUSTER} defaults 99 99
    Name: run
    PrependShell: true
  From:
    Image: bitergia/ubuntu-trusty:latest
  Name: ""
  Platform: ""
  SourceCode: FROM bitergia/ubuntu-trusty:latest
