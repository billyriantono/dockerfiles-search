FROM rocker/rstudio:3.5

# Build arguments
# Build date and git commit are dynamically generated by a build hook
ARG BUILD_DATE
ARG VCS_REF
ARG SEURAT_VER=3.0

# OCI Annotations (https://github.com/opencontainers/image-spec/blob/master/annotations.md)
LABEL org.opencontainers.image.created = "${BUILD_DATE}"
LABEL org.opencontainers.image.authors = "Brian Skjerven <brian.skjerven@pawsey.org.au"
LABEL org.opencontainers.image.revision = "${VCS_REF}"
LABEL org.opencontainers.image.version = "${SEURAT_VER}"
LABEL org.opencontainers.image.licenses = "MIT"
LABEL org.opencontainers.image.title = "Seurat"
LABEL org.opencontainers.image.description = "This Docker image provides RStudio (v3.5) with the \
  single cell analysis package Seurat installed"
#LABEL org.opencontainers.image.url
#LABEL org.opencontainers.image.documentation
#LABEL org.opencontainers.image.source
#LABEL org.opencontainers.image.ref.name

# Install required packages and clean up
RUN apt-get update -qq && apt-get -y --no-install-recommends install \
      build-essential \
      libpng-dev \
      libz-dev \
      && apt-get clean all \
      && rm -rf /var/lib/apt/lists/*

# Add compiler options for R package builds
RUN mkdir -p $HOME/.R
COPY Makevars /root/.R/Makevars

# Update and install scPipe (and dependencies)
RUN Rscript -e "install.packages('devtools')" \
      -e "install.packages('data.table')" \
      -e "devtools::install_github(repo='satijalab/seurat', ref = 'release/${SEURAT_VER}')" \
      && rm -rf /tmp/downloaded_packages
