MetaArgs: null
Stages:
- BaseName: debian:stretch
  Commands:
  - Maintainer: Marek Obuchowicz
    Name: maintainer
  - Env:
    - Key: APACHE2_HTTP
      Value: REDIRECT
    - Key: ICINGA2_FEATURE_GRAPHITE
      Value: "false"
    - Key: ICINGA2_FEATURE_GRAPHITE_HOST
      Value: graphite
    - Key: ICINGA2_FEATURE_GRAPHITE_PORT
      Value: "2003"
    - Key: ICINGA2_FEATURE_GRAPHITE_URL
      Value: http://graphite
    - Key: ICINGA2_USER_FULLNAME
      Value: '"Icinga2"'
    - Key: ICINGA2_FEATURE_DIRECTOR
      Value: '"true"'
    - Key: ICINGA2_FEATURE_DIRECTOR_KICKSTART
      Value: '"true"'
    - Key: ICINGA2_FEATURE_DIRECTOR_USER
      Value: '"icinga2-director"'
    - Key: DEBIAN_FRONTEND
      Value: '"noninteractive"'
    Name: env
  - CmdLine:
    - apt-get -qy update      && apt-get upgrade -qy      && apt-get install -qy --no-install-recommends           apache2           apt-transport-https           bc           ca-certificates           curl           dirmngr           dnsutils           gnupg           openjdk-8-jre-headless           jq           lsb-release           mailutils           mariadb-client           mariadb-server           php-curl           php-ldap           php-mysql           procps           pwgen           snmp           ssmtp           sudo           supervisor           unzip           wget      &&
      curl -s https://packages.icinga.com/icinga.key | apt-key add -      && echo
      "deb http://packages.icinga.org/debian icinga-$(lsb_release -cs) main" > /etc/apt/sources.list.d/icinga2.list      &&
      apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 10779AB4      && echo
      "deb https://raw.githubusercontent.com/nisabek/icinga2-slack-notifications/master/reprepro
      general main" > /etc/apt/sources.list.d/icinga2-slack.list      && apt-get update      &&
      apt-get install -y --no-install-recommends           icinga2           icinga2-ido-mysql           icinga2-slack-notifications           icingacli           icingaweb2           monitoring-plugins           nagios-nrpe-plugin           nagios-snmp-plugins           nagios-plugins-contrib      &&
      apt-get -qy install python-pip python-six python-pyasn1 python-requests python-pbr
      python-redis python-pika python-awsauth      && pip install awscli      && pip
      install python-jenkins      && pip install 'elasticsearch>=5.0.0,<6.0.0'      &&
      apt-get -qy remove python-pip      && apt-get -qy autoremove      && apt-get
      clean      && rm -rf /var/lib/apt/lists/*
    Name: run
    PrependShell: true
  - CmdLine:
    - wget -O /usr/lib/nagios/plugins/check_cloudwatch_metrics https://raw.githubusercontent.com/rizvir/check_cloudwatch_metrics/master/check_cloudwatch_metrics      &&
      chmod 755 /usr/lib/nagios/plugins/check_cloudwatch_metrics
    Name: run
    PrependShell: true
  - CmdLine:
    - wget -O /tmp/opsgenie.deb https://s3-us-west-2.amazonaws.com/opsgeniedownloads/repo/opsgenie-icinga2_2.15.0_all.deb      &&
      dpkg -i /tmp/opsgenie.deb      && rm -f /tmp/opsgenie.deb
    Name: run
    PrependShell: true
  - Key: GITREF_ICINGAWEB2
    Name: arg
    Value: master
  - Key: GITREF_DIRECTOR
    Name: arg
    Value: master
  - Key: GITREF_MODGRAPHITE
    Name: arg
    Value: master
  - Key: GITREF_MODAWS
    Name: arg
    Value: master
  - Key: GITREF_MODELASTICSEARCH
    Name: arg
    Value: master
  - Key: GITREF_MODBUSINESSPROCESS
    Name: arg
    Value: master
  - Key: GITREF_MODCUBE
    Name: arg
    Value: master
  - CmdLine:
    - mkdir -p /usr/local/share/icingaweb2/modules/     && wget -q --no-cookies -O
      - "https://github.com/Icinga/icingaweb2/archive/${GITREF_ICINGAWEB2}.tar.gz"     |
      tar xz --strip-components=2 --directory=/usr/local/share/icingaweb2/modules
      -f - icingaweb2-${GITREF_ICINGAWEB2}/modules/monitoring icingaweb2-${GITREF_ICINGAWEB2}/modules/doc     &&
      mkdir -p /usr/local/share/icingaweb2/modules/director/     && wget -q --no-cookies
      -O - "https://github.com/Icinga/icingaweb2-module-director/archive/${GITREF_DIRECTOR}.tar.gz"     |
      tar xz --strip-components=1 --directory=/usr/local/share/icingaweb2/modules/director
      --exclude=.gitignore -f -     && mkdir -p /usr/local/share/icingaweb2/modules/graphite     &&
      wget -q --no-cookies -O - "https://github.com/Icinga/icingaweb2-module-graphite/archive/${GITREF_MODGRAPHITE}.tar.gz"     |
      tar xz --strip-components=1 --directory=/usr/local/share/icingaweb2/modules/graphite
      -f - icingaweb2-module-graphite-${GITREF_MODGRAPHITE}/     && mkdir -p /usr/local/share/icingaweb2/modules/elasticsearch     &&
      wget -q --no-cookies -O - "https://github.com/Icinga/icingaweb2-module-elasticsearch/archive/${GITREF_MODELASTICSEARCH}.tar.gz"     |
      tar xz --strip-components=1 --directory=/usr/local/share/icingaweb2/modules/elasticsearch
      -f - icingaweb2-module-elasticsearch-${GITREF_MODGRAPHITE}/     && mkdir -p
      /usr/local/share/icingaweb2/modules/businessprocess     && wget -q --no-cookies
      -O - "https://github.com/Icinga/icingaweb2-module-businessprocess/archive/${GITREF_MODBUSINESSPROCESS}.tar.gz"     |
      tar xz --strip-components=1 --directory=/usr/local/share/icingaweb2/modules/businessprocess
      -f - icingaweb2-module-businessprocess-${GITREF_MODBUSINESSPROCESS}/     &&
      mkdir -p /usr/local/share/icingaweb2/modules/cube     && wget -q --no-cookies
      -O - "https://github.com/Icinga/icingaweb2-module-cube/archive/${GITREF_MODCUBE}.tar.gz"     |
      tar xz --strip-components=1 --directory=/usr/local/share/icingaweb2/modules/cube
      -f - icingaweb2-module-cube-${GITREF_MODCUBE}/     && mkdir -p /usr/local/share/icingaweb2/modules/aws     &&
      wget -q --no-cookies -O - "https://github.com/korekontrol/icingaweb2-module-aws/archive/${GITREF_MODAWS}.tar.gz"     |
      tar xz --strip-components=1 --directory=/usr/local/share/icingaweb2/modules/aws
      -f - icingaweb2-module-aws-${GITREF_MODAWS}/     && wget -q --no-cookies "https://github.com/aws/aws-sdk-php/releases/download/2.8.30/aws.zip"     &&
      unzip -d /usr/local/share/icingaweb2/modules/aws/library/vendor/aws aws.zip     &&
      rm aws.zip     && true
    Name: run
    PrependShell: true
  - Chown: ""
    Name: add
    SourcesAndDest:
    - content/
    - /
  - CmdLine:
    - true     && sed -i 's/vars\.os.*/vars.os = "Docker"/' /etc/icinga2/conf.d/hosts.conf     &&
      mv /etc/icingaweb2/ /etc/icingaweb2.dist     && mkdir /etc/icingaweb2     &&
      mv /etc/icinga2/ /etc/icinga2.dist     && mkdir /etc/icinga2     && usermod
      -aG icingaweb2 www-data     && usermod -aG nagios www-data     && rm -rf         /var/lib/mysql/*     &&
      chmod u+s,g+s         /bin/ping         /bin/ping6         /usr/lib/nagios/plugins/check_icmp
    Name: run
    PrependShell: true
  - Name: expose
    Ports:
    - "443"
    - "5665"
    - "80"
  - CmdLine:
    - /opt/run
    Name: entrypoint
    PrependShell: false
  From:
    Image: debian:stretch
  Name: ""
  Platform: ""
  SourceCode: FROM debian:stretch
