MetaArgs: null
Stages:
- BaseName: ubuntu:18.04
  Commands:
  - Maintainer: Lanka Software Foundation <support@opensource.lk>
    Name: maintainer
  - Key: DEBIAN_FRONTEND
    Name: arg
    Value: noninteractive
  - Env:
    - Key: TELEGRAF_VERSION
      Value: 1.8.1-1
    Name: env
  - CmdLine:
    - apt-get update --fix-missing && apt-get -y purge exim4*
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get -y upgrade
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get -y install apt-utils
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get -y install net-tools
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get install -y iputils-ping
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get -y install mailutils
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get -y install lsof
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get -y install telnet
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get -y install nano
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get -y install letsencrypt openssl
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get -y install postfix postfix-ldap postfix-pcre postfix-policyd-spf-python
      libsasl2-modules
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get install -y rsyslog fetchmail libdbi-perl libdbd-pg-perl libdbd-mysql-perl
      liblockfile-simple-perl
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get -y install dovecot-core dovecot-imapd dovecot-pop3d dovecot-lmtpd dovecot-mysql
      dovecot-ldap dnsutils
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get install -y dovecot-sieve dovecot-managesieved
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get install -y ldap-utils curl
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get install -y gnupg software-properties-common
    Name: run
    PrependShell: true
  - CmdLine:
    - adduser --system --no-create-home --group --home /etc/zeyple --disabled-login
      zeyple
    Name: run
    PrependShell: true
  - CmdLine:
    - 'mkdir -p /etc/zeyple/keys && chmod 700 /etc/zeyple/keys && chown zeyple: /etc/zeyple/keys'
    Name: run
    PrependShell: true
  - Chown: ""
    Name: add
    SourcesAndDest:
    - ./configs/zeyple/zeyple.py
    - /usr/local/bin/zeyple.py
  - CmdLine:
    - 'chmod 744 /usr/local/bin/zeyple.py && chown zeyple: /usr/local/bin/zeyple.py'
    Name: run
    PrependShell: true
  - Chown: ""
    Name: add
    SourcesAndDest:
    - https://raw.github.com/infertux/zeyple/master/zeyple/zeyple.conf.example
    - /etc/zeyple.conf
  - CmdLine:
    - 'touch /var/log/zeyple.log && chown zeyple: /var/log/zeyple.log'
    Name: run
    PrependShell: true
  - CmdLine:
    - chown -R zeyple /etc/zeyple /usr/local/bin/zeyple.py
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - ./configs/Dovecot
    - /etc/dovecot/
  - CmdLine:
    - chgrp dovecot /etc/dovecot/dovecot-sql.conf.ext
    Name: run
    PrependShell: true
  - CmdLine:
    - chmod o= /etc/dovecot/dovecot-sql.conf.ext
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - ./configs/Postfix
    - /etc/postfix/
  - CmdLine:
    - chmod o= /etc/postfix/ldap/*.cf
    Name: run
    PrependShell: true
  - CmdLine:
    - chgrp postfix /etc/postfix/ldap/*.cf
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - ./configs/sieve
    - /var/mail/sieve
  - CmdLine:
    - groupadd -g 5000 vmail && useradd -g vmail -u 5000 vmail -d /var/mail
    Name: run
    PrependShell: true
  - CmdLine:
    - chown -R vmail:vmail /var/mail
    Name: run
    PrependShell: true
  - CmdLine:
    - chown -R postfix /etc/postfix
    Name: run
    PrependShell: true
  - CmdLine:
    - chmod -R o-rwx /etc/postfix
    Name: run
    PrependShell: true
  - CmdLine:
    - chmod -R 755 /etc/postfix
    Name: run
    PrependShell: true
  - CmdLine:
    - chown -R vmail:dovecot /etc/dovecot
    Name: run
    PrependShell: true
  - CmdLine:
    - chmod -R o-rwx /etc/dovecot
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - ./configs/Rspamd/rspamd.sh
    - /
  - CmdLine:
    - chmod +x ./rspamd.sh
    Name: run
    PrependShell: true
  - CmdLine:
    - ./rspamd.sh
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - ./configs/Rspamd
    - /etc/rspamd/
  - CmdLine:
    - mkdir -p /var/lib/rspamd/dkim
    Name: run
    PrependShell: true
  - CmdLine:
    - rspamadm dkim_keygen -b 1024 -s 2018 -d $DOMAIN -k /var/lib/rspamd/dkim/2018.key
      > /var/lib/rspamd/dkim/2018.txt
    Name: run
    PrependShell: true
  - CmdLine:
    - chown -R _rspamd:_rspamd /var/lib/rspamd/dkim
    Name: run
    PrependShell: true
  - CmdLine:
    - chmod 440 /var/lib/rspamd/dkim/*
    Name: run
    PrependShell: true
  - CmdLine:
    - cp -R /etc/rspamd/local.d/dkim_signing.conf /etc/rspamd/local.d/arc.conf
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - ./configs/sieve
    - /sieve
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - ./configs/init_sys.sh
    - /bin/
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - ./configs/.env
    - /bin/
  - CmdLine:
    - chmod +x /bin/init_sys.sh
    Name: run
    PrependShell: true
  - CmdLine:
    - chmod 755 /bin/.env
    Name: run
    PrependShell: true
  - Chown: ""
    Name: add
    SourcesAndDest:
    - ./configs/pod_start.sh
    - /bin/pod_start.sh
  - CmdLine:
    - chmod +x /bin/pod_start.sh
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - ./configs/logAnalyze/pflogsumm
    - /usr/local/bin/pflogsumm
  - CmdLine:
    - chown bin:bin /usr/local/bin/pflogsumm
    Name: run
    PrependShell: true
  - CmdLine:
    - chmod 755 /usr/local/bin/pflogsumm
    Name: run
    PrependShell: true
  - CmdLine:
    - apt -y install clamav-daemon clamav
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - ./configs/clamAV/antivirus.conf
    - /etc/rspamd/override.d/
  - CmdLine:
    - "wget https://dl.influxdata.com/telegraf/releases/telegraf_${TELEGRAF_VERSION}_amd64.deb
      && \tdpkg -i telegraf_${TELEGRAF_VERSION}_amd64.deb && rm telegraf_${TELEGRAF_VERSION}_amd64.deb"
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - ./configs/telegraf/telegraf.conf
    - /etc/telegraf/telegraf.conf
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - ./configs/telegraf/init.sh
    - /etc/init.d/telegraf
  - CmdLine:
    - apt-get clean &&  rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - ./configs/telegraf/entrypoint.sh
    - entrypoint.sh
  - CmdLine:
    - chmod 755 entrypoint.sh
    Name: run
    PrependShell: true
  - CmdLine:
    - init_sys.sh
    Name: run
    PrependShell: true
  - CmdLine:
    - tail
    - -f
    - /dev/null
    Name: entrypoint
    PrependShell: false
  From:
    Image: ubuntu:18.04
  Name: ""
  Platform: ""
  SourceCode: From ubuntu:18.04
