MetaArgs: null
Stages:
- BaseName: alpine:3.4
  Commands:
  - Maintainer: Nathon Fowlie <nathon.fowlie@gmail.com>
    Name: maintainer
  - Name: expose
    Ports:
    - "443"
  - Name: workdir
    Path: /tmp
  - Key: SAN
    Name: arg
    Value: '"DNS:localhost,IP:127.0.0.1"'
  - Key: SUBJECT
    Name: arg
    Value: '"/C=AU/ST=NSW/L=Sydney/O=Localhost/CN=localhost"'
  - Key: CN
    Name: arg
    Value: '"localhost"'
  - CmdLine:
    - "apk update && apk upgrade && apk add openssl     && mkdir -p /etc/ssl/private
      \t&& mkdir -p /etc/ssl/cer     && chmod -R 640 /etc/ssl/private \t&& chmod -R
      644 /etc/ssl/cer"
    Name: run
    PrependShell: true
  - Chown: ""
    Name: add
    SourcesAndDest:
    - files/ssl/openssl.cnf
    - openssl.cnf
  - CmdLine:
    - "touch rootCA.pass ${CN}_in.pass ${CN}_out.pass     && chmod 600 rootCA.pass
      ${CN}_in.pass ${CN}_out.pass     && dd if=/dev/urandom bs=1 count=20 2>/dev/null
      | base64 >> rootCA.pass     && dd if=/dev/urandom bs=1 count=20 2>/dev/null
      | base64 >> ${CN}_out.pass     && dd if=/dev/urandom bs=1 count=20 2>/dev/null
      | base64 >> ${CN}_in.pass     && openssl genrsa -aes256 -out /etc/ssl/private/rootCA.key
      -passout file:rootCA.pass 4096 \t&& openssl req -x509 -new -extensions v3_ca
      -key /etc/ssl/private/rootCA.key -sha256 -days 365 -out /etc/ssl/cer/rootCA.crt
      -passin file:rootCA.pass -subj /C=AU/ST=NSW/L=Sydney/O=Localhost/CN=localhost
      \    && env 'subjectAltName=${SAN}' openssl req -new -nodes -x509 -newkey rsa:4096
      -keyout /etc/ssl/private/localhost.key -out /etc/ssl/cer/localhost.crt -days
      365 -passin file:${CN}_in.pass -passout file:${CN}_out.pass -subj ${SUBJECT}
      -config openssl.cnf \t&& rm *.pass *.cnf"
    Name: run
    PrependShell: true
  - Chown: ""
    Name: add
    SourcesAndDest:
    - files/data
    - /data
  - CmdLine:
    - "apk add nginx     && mkdir -p /etc/nginx/conf.d \t&& chmod -R 755 /data/www/public_html
      \t&& mkdir -p /run/nginx"
    Name: run
    PrependShell: true
  - Chown: ""
    Name: add
    SourcesAndDest:
    - files/etc/nginx/nginx.conf
    - /etc/nginx/nginx.conf
  - Chown: ""
    Name: add
    SourcesAndDest:
    - files/etc/nginx/conf.d/localhost.conf
    - /etc/nginx/conf.d/localhost.conf
  - CmdLine:
    - /usr/sbin/nginx
    Name: entrypoint
    PrependShell: false
  From:
    Image: alpine:3.4
  Name: ""
  Platform: ""
  SourceCode: FROM alpine:3.4
