{
  "MetaArgs": null,
  "Stages": [
    {
      "Name": "",
      "BaseName": "debian:stretch",
      "SourceCode": "FROM debian:stretch",
      "Platform": "",
      "From": {
        "Image": "debian:stretch"
      },
      "Commands": [
        {
          "CmdLine": [
            "apt-get update"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "CmdLine": [
            "apt-get install --yes       git-core       python       python-pip       python-virtualenv"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "Key": "APP_USER",
          "Name": "arg",
          "Value": "\"demo-user\""
        },
        {
          "Key": "APP_GROUP",
          "Name": "arg",
          "Value": "\"demo-user\""
        },
        {
          "Key": "APP_HOME_DIR",
          "Name": "arg",
          "Value": "\"/home/demo-user\""
        },
        {
          "CmdLine": [
            "set -x \u0026\u0026     groupadd \"$APP_GROUP\" \u0026\u0026     useradd       --comment \"Demo app system account\"       --home-dir \"$APP_HOME_DIR\"       --create-home       --system       --gid \"$APP_GROUP\"       \"$APP_USER\""
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "Key": "NGINX_GROUP",
          "Name": "arg",
          "Value": "\"www-data\""
        },
        {
          "Chown": "",
          "From": "",
          "Name": "copy",
          "SourcesAndDest": [
            "nginx.conf",
            "/etc/nginx/sites-enabled/nginx.conf"
          ]
        },
        {
          "CmdLine": [
            "set -x \u0026\u0026     apt-get install --yes       nginx       sudo \u0026\u0026     rm /etc/nginx/sites-enabled/default \u0026\u0026     usermod --append --groups \"$NGINX_GROUP\" \"$APP_USER\" \u0026\u0026     echo \"$APP_USER ALL=(ALL:ALL) NOPASSWD: /usr/sbin/nginx\" \u003e\u003e /etc/sudoers"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "Key": "APP_ROOT",
          "Name": "arg",
          "Value": "\"/srv/demo-app\""
        },
        {
          "CmdLine": [
            "mkdir --parents \"$APP_ROOT\" \u0026\u0026     chown       --no-dereference       --recursive       \"${APP_USER}:${NGINX_GROUP}\" \"$APP_ROOT\""
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "Name": "user",
          "User": "\"$APP_USER\""
        },
        {
          "Name": "workdir",
          "Path": "\"$APP_ROOT\""
        },
        {
          "Key": "DEMO_APP_REPO",
          "Name": "arg",
          "Value": "\"https://github.com/mtlynch/flask_upload_demo\""
        },
        {
          "CmdLine": [
            "set -x \u0026\u0026     git clone \"$DEMO_APP_REPO\" . \u0026\u0026     virtualenv VIRTUAL \u0026\u0026     . VIRTUAL/bin/activate \u0026\u0026     pip install --requirement requirements.txt"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "Name": "expose",
          "Ports": [
            "5000"
          ]
        },
        {
          "CmdLine": [
            "set -x \u0026\u0026     sudo nginx \u0026\u0026     virtualenv VIRTUAL \u0026\u0026     . VIRTUAL/bin/activate \u0026\u0026     gunicorn       demo.app:app       --bind 127.0.0.1:5000       --log-level info"
          ],
          "Name": "cmd",
          "PrependShell": true
        }
      ]
    }
  ]
}