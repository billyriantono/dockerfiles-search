MetaArgs: null
Stages:
- BaseName: ubuntu
  Commands:
  - Maintainer: Jon Schipp <jonschipp@gmail.com>
    Name: maintainer
  - Env:
    - Key: VIRTUSER
      Value: demo
    Name: env
  - CmdLine:
    - apt-get update -qq
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get install -y build-essential checkinstall automake autoconf                        pkg-config
      libtool libpcre3-dev libpcre3 libdumbnet1                        libdumbnet-dev
      libesmtp-dev libpcap-dev libgeoip-dev                        libjson0 libjson0-dev
      libcurl4-openssl-dev
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get install -y git vim emacs nano tcpdump gawk rsyslog
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get install -y --no-install-recommends man-db
    Name: run
    PrependShell: true
  - CmdLine:
    - git clone https://github.com/rsyslog/libestr && cd libestr &&               autoreconf
      -vfi && ./configure && make && make install && ldconfig
    Name: run
    PrependShell: true
  - CmdLine:
    - git clone https://github.com/rsyslog/liblognorm && cd liblognorm &&               autoreconf
      -vfi && ./configure --disable-docs && make install && ldconfig
    Name: run
    PrependShell: true
  - CmdLine:
    - adduser --disabled-password --gecos "" $VIRTUSER
    Name: run
    PrependShell: true
  - CmdLine:
    - adduser --disabled-password --gecos "" --home / --shell /usr/sbin/nologin sagan
    Name: run
    PrependShell: true
  - CmdLine:
    - su -l -c 'git clone https://github.com/beave/sagan' $VIRTUSER
    Name: run
    PrependShell: true
  - CmdLine:
    - su -l -c 'cd sagan && ./configure --enable-geoip --enable-esmtp --enable-libpcap
      && make' $VIRTUSER
    Name: run
    PrependShell: true
  - CmdLine:
    - git clone https://github.com/beave/sagan-rules /usr/local/etc/sagan-rules
    Name: run
    PrependShell: true
  - CmdLine:
    - cd /home/$VIRTUSER/sagan && make install
    Name: run
    PrependShell: true
  - CmdLine:
    - chown -R sagan:sagan /var/log/sagan /var/run/sagan
    Name: run
    PrependShell: true
  - CmdLine:
    - chown -R demo:sagan /usr/local/etc/
    Name: run
    PrependShell: true
  - CmdLine:
    - mkfifo /var/run/sagan.fifo
    Name: run
    PrependShell: true
  - CmdLine:
    - chown sagan:sagan /var/run/sagan.fifo
    Name: run
    PrependShell: true
  - CmdLine:
    - chmod 666 /var/run/sagan.fifo /var/log/*
    Name: run
    PrependShell: true
  - CmdLine:
    - chmod ugo+x /var/log/sagan
    Name: run
    PrependShell: true
  - CmdLine:
    - /bin/echo -e '#Sagan template\n$template sagan,"%fromhost-ip%|%syslogfacility-text%|%syslogpriority-text%|%syslogseverity-text%|%syslogtag%|%timegenerated:1:10:date-rfc3339%|%timegenerated:12:19:date-rfc3339%|%programname%|%msg%\\n"\n*.*     |/var/run/sagan.fifo;sagan'
      > /etc/rsyslog.d/sagan.conf
    Name: run
    PrependShell: true
  - CmdLine:
    - /bin/echo -e "$VIRTUSER ALL=(root) NOPASSWD:/usr/local/sbin/sagan\n$VIRTUSER
      ALL=(root) NOPASSWD:/usr/sbin/service rsyslog*" > /etc/sudoers.d/sagan
    Name: run
    PrependShell: true
  - CmdLine:
    - setcap cap_net_raw,cap_net_admin=eip /usr/local/sbin/sagan
    Name: run
    PrependShell: true
  - CmdLine:
    - echo "export TMOUT=1800; readonly TMOUT" > /etc/profile.d/timeout.sh && chmod
      555 /etc/profile.d/timeout.sh
    Name: run
    PrependShell: true
  From:
    Image: ubuntu
  Name: ""
  Platform: ""
  SourceCode: FROM      ubuntu
