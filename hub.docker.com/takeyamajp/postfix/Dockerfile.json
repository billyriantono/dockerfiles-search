{
  "MetaArgs": null,
  "Stages": [
    {
      "Name": "",
      "BaseName": "centos:centos8",
      "SourceCode": "FROM centos:centos8",
      "Platform": "",
      "From": {
        "Image": "centos:centos8"
      },
      "Commands": [
        {
          "Maintainer": "\"Hiroki Takeyama\"",
          "Name": "maintainer"
        },
        {
          "CmdLine": [
            "mkdir /cert;     dnf -y install openssl;     openssl genrsa -aes256 -passout pass:dummy -out \"/cert/key.pass.pem\" 2048;     openssl rsa -passin pass:dummy -in \"/cert/key.pass.pem\" -out \"/cert/key.pem\";     rm -f /cert/key.pass.pem;     dnf clean all;"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "CmdLine": [
            "dnf -y install postfix cyrus-sasl-plain cyrus-sasl-md5;     sed -i 's/^\\(inet_interfaces =\\) .*/\\1 all/' /etc/postfix/main.cf;     sed -i 's/^\\(smtpd_tls_cert_file =\\) .*/\\1 \\/cert\\/cert.pem/' /etc/postfix/main.cf;     sed -i 's/^\\(smtpd_tls_key_file =\\) .*/\\1 \\/cert\\/key.pem/' /etc/postfix/main.cf;     {     echo 'smtpd_sasl_path = smtpd';     echo 'smtpd_sasl_auth_enable = yes';     echo 'broken_sasl_auth_clients = yes';     echo 'smtpd_sasl_security_options = noanonymous';     echo 'disable_vrfy_command = yes';     echo 'smtpd_helo_required = yes';     echo 'smtpd_helo_restrictions = permit_sasl_authenticated, reject_invalid_hostname, reject_non_fqdn_hostname, reject_unknown_hostname';     echo 'smtpd_recipient_restrictions = permit_sasl_authenticated, reject_unauth_destination';     echo 'smtpd_sender_restrictions = reject_non_fqdn_sender, reject_unknown_sender_domain';     echo 'smtpd_tls_security_level = may';     echo 'smtpd_tls_received_header = yes';     echo 'smtpd_tls_loglevel = 1';     echo 'smtp_tls_security_level = may';     echo 'smtp_tls_loglevel = 1';     echo 'smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache';     echo 'tls_random_source = dev:/dev/urandom';     } \u003e\u003e /etc/postfix/main.cf;     {     echo 'pwcheck_method: auxprop';     echo 'auxprop_plugin: sasldb';     echo 'mech_list: PLAIN LOGIN CRAM-MD5 DIGEST-MD5';     } \u003e /etc/sasl2/smtpd.conf;     sed -i 's/^#\\(submission .*\\)/\\1/' /etc/postfix/master.cf;     sed -i 's/^#\\(smtps .*\\)/\\1/' /etc/postfix/master.cf;     sed -i 's/^#\\(.* syslog_name=.*\\)/\\1/' /etc/postfix/master.cf;     sed -i 's/^#\\(.* smtpd_sasl_auth_enable=.*\\)/\\1/' /etc/postfix/master.cf;     sed -i 's/^#\\(.* smtpd_recipient_restrictions=.*\\)/\\1/' /etc/postfix/master.cf;     sed -i 's/^#\\(.* smtpd_tls_wrappermode=.*\\)/\\1/' /etc/postfix/master.cf;     newaliases;     dnf clean all;"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "CmdLine": [
            "dnf -y install rsyslog;     sed -i 's/\\(SysSock\\.Use\\)=\"off\"/\\1=\"on\"/' /etc/rsyslog.conf;     dnf clean all;"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "CmdLine": [
            "mkdir /run/supervisor;     dnf -y install epel-release;     dnf -y install supervisor;     sed -i 's/^\\(nodaemon\\)=false/\\1=true/' /etc/supervisord.conf;     sed -i 's/^;\\(user\\)=chrism/\\1=root/' /etc/supervisord.conf;     sed -i '/^\\[unix_http_server\\]$/a username=dummy\\npassword=dummy' /etc/supervisord.conf;     sed -i '/^\\[supervisorctl\\]$/a username=dummy\\npassword=dummy' /etc/supervisord.conf;     {     echo '[program:postfix]';     echo 'command=/usr/sbin/postfix -c /etc/postfix start';     echo 'priority=3';     echo 'startsecs=0';     } \u003e /etc/supervisord.d/postfix.ini;     {     echo '[program:rsyslog]';     echo 'command=/usr/sbin/rsyslogd -n';     echo 'priority=2';     } \u003e /etc/supervisord.d/rsyslog.ini;     {     echo '[program:tail]';     echo 'command=/usr/bin/tail -F /var/log/maillog';     echo 'priority=1';     echo 'stdout_logfile=/dev/fd/1';     echo 'stdout_logfile_maxbytes=0';     } \u003e /etc/supervisord.d/tail.ini;     dnf clean all;"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "CmdLine": [
            "{     echo '#!/bin/bash -eu';     echo 'ln -fs /usr/share/zoneinfo/${TIMEZONE} /etc/localtime';     echo 'rm -f /var/log/maillog';     echo 'touch /var/log/maillog';     echo 'openssl req -new -sha384 -key \"/cert/key.pem\" -subj \"/CN=${HOST_NAME}\" -out \"/cert/csr.pem\"';     echo 'openssl x509 -req -days 36500 -in \"/cert/csr.pem\" -signkey \"/cert/key.pem\" -out \"/cert/cert.pem\" \u0026\u003e/dev/null';     echo 'if [ -e /etc/sasldb2 ]; then';     echo '  rm -f /etc/sasldb2';     echo 'fi';     echo 'sed -i \"s/^\\(smtpd_sasl_auth_enable =\\).*/\\1 yes/\" /etc/postfix/main.cf';     echo 'if [ ${DISABLE_SMTP_AUTH_ON_PORT_25,,} = \"true\" ]; then';     echo '  sed -i \"s/^\\(smtpd_sasl_auth_enable =\\).*/\\1 no/\" /etc/postfix/main.cf';     echo 'fi';     echo 'echo \"${AUTH_PASSWORD}\" | /usr/sbin/saslpasswd2 -p -c -u ${DOMAIN_NAME} ${AUTH_USER}';     echo 'chown postfix:postfix /etc/sasldb2';     echo 'sed -i '\\''/^# BEGIN SMTP SETTINGS$/,/^# END SMTP SETTINGS$/d'\\'' /etc/postfix/main.cf';     echo '{';     echo 'echo \"# BEGIN SMTP SETTINGS\"';     echo 'echo \"myhostname = ${HOST_NAME}\"';     echo 'echo \"mydomain = ${DOMAIN_NAME}\"';     echo 'echo \"smtpd_banner = \\$myhostname ESMTP unknown\"';     echo 'echo \"message_size_limit = ${MESSAGE_SIZE_LIMIT}\"';     echo 'echo \"# END SMTP SETTINGS\"';     echo '} \u003e\u003e /etc/postfix/main.cf';     echo 'exec \"$@\"';     } \u003e /usr/local/bin/entrypoint.sh;     chmod +x /usr/local/bin/entrypoint.sh;"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "Env": [
            {
              "Key": "TIMEZONE",
              "Value": "Asia/Tokyo"
            }
          ],
          "Name": "env"
        },
        {
          "Env": [
            {
              "Key": "HOST_NAME",
              "Value": "smtp.example.com"
            }
          ],
          "Name": "env"
        },
        {
          "Env": [
            {
              "Key": "DOMAIN_NAME",
              "Value": "example.com"
            }
          ],
          "Name": "env"
        },
        {
          "Env": [
            {
              "Key": "MESSAGE_SIZE_LIMIT",
              "Value": "10240000"
            }
          ],
          "Name": "env"
        },
        {
          "Env": [
            {
              "Key": "AUTH_USER",
              "Value": "user"
            }
          ],
          "Name": "env"
        },
        {
          "Env": [
            {
              "Key": "AUTH_PASSWORD",
              "Value": "password"
            }
          ],
          "Name": "env"
        },
        {
          "Env": [
            {
              "Key": "DISABLE_SMTP_AUTH_ON_PORT_25",
              "Value": "true"
            }
          ],
          "Name": "env"
        },
        {
          "Name": "expose",
          "Ports": [
            "25"
          ]
        },
        {
          "Name": "expose",
          "Ports": [
            "587"
          ]
        },
        {
          "Name": "expose",
          "Ports": [
            "465"
          ]
        },
        {
          "CmdLine": [
            "entrypoint.sh"
          ],
          "Name": "entrypoint",
          "PrependShell": false
        },
        {
          "CmdLine": [
            "supervisord",
            "-c",
            "/etc/supervisord.conf"
          ],
          "Name": "cmd",
          "PrependShell": false
        }
      ]
    }
  ]
}