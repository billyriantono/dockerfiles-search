MetaArgs: null
Stages:
- As: builder
  BaseName: golang:1.10-alpine
  Commands:
  - Env:
    - Key: TERM
      Value: xterm
    - Key: BUILD_DATE
      Value: '"2018-05-04"'
    - Key: BUILD_TYPE
      Value: '"stable"'
    - Key: VERSION
      Value: '"0.10.1"'
    Name: env
  - CmdLine:
    - apk update --no-cache &&   apk upgrade --no-cache &&   apk add     g++ git make
      musl-dev &&   echo "export BUILD_DATE=${BUILD_DATE}" >> /etc/enviroment &&   echo
      "export BUILD_TYPE=${BUILD_TYPE}" >> /etc/enviroment &&   echo "export VERSION=${VERSION}"
      >> /etc/enviroment
    Name: run
    PrependShell: true
  - CmdLine:
    - export GOPATH=/opt/go &&   mkdir -p ${GOPATH} &&   export PATH="${PATH}:${GOPATH}/bin"
      &&   go get -d github.com/graphite-ng/carbon-relay-ng || true &&   go get github.com/jteeuwen/go-bindata/...
      &&   cd ${GOPATH}/src/github.com/graphite-ng/carbon-relay-ng &&   if [ "${BUILD_TYPE}"
      == "stable" ] ; then     echo "switch to stable Tag v${VERSION}" &&     git
      checkout tags/${VERSION} 2> /dev/null ;   fi
    Name: run
    PrependShell: true
  - CmdLine:
    - 'echo "build" &&   export GOPATH=/opt/go &&   cd ${GOPATH}/src/github.com/graphite-ng/carbon-relay-ng
      &&   export PATH="${PATH}:${GOPATH}/bin" &&   version=$(git describe --tags
      --always | sed ''s/^v//'') &&   echo "build version: ${version}" &&   make &&   mv
      carbon-relay-ng /tmp/carbon-relay-ng &&   cp -rv examples /tmp/'
    Name: run
    PrependShell: true
  From:
    Image: golang:1.10-alpine
  Name: builder
  Platform: ""
  SourceCode: FROM golang:1.10-alpine as builder
- BaseName: alpine:3.7
  Commands:
  - Env:
    - Key: TERM
      Value: xterm
    - Key: TZ
      Value: '''Europe/Berlin'''
    - Key: BUILD_DATE
      Value: '"2018-05-04"'
    Name: env
  - Name: expose
    Ports:
    - "2003"
    - "2004"
    - "8081"
  - Labels:
    - Key: version
      Value: '"1805"'
    - Key: maintainer
      Value: '"Bodo Schulz <bodo@boone-schulz.de>"'
    - Key: org.label-schema.build-date
      Value: ${BUILD_DATE}
    - Key: org.label-schema.name
      Value: '"carbon-relay-ng Docker Image"'
    - Key: org.label-schema.description
      Value: '"Inofficial carbon-relay-ng Docker Image"'
    - Key: org.label-schema.url
      Value: '"https://github.com/graphite-ng/carbon-relay-ng"'
    - Key: org.label-schema.vcs-url
      Value: '"https://github.com/bodsch/docker-docker-carbon-relay-ng"'
    - Key: org.label-schema.vendor
      Value: '"Bodo Schulz"'
    - Key: org.label-schema.version
      Value: ${VERSION}
    - Key: org.label-schema.schema-version
      Value: '"1.0"'
    - Key: com.microscaling.docker.dockerfile
      Value: '"/Dockerfile"'
    - Key: com.microscaling.license
      Value: '"The Unlicense"'
    Name: label
  - Name: workdir
    Path: /
  - Chown: ""
    From: builder
    Name: copy
    SourcesAndDest:
    - /tmp/carbon-relay-ng
    - /usr/bin/carbon-relay-ng
  - Chown: ""
    From: builder
    Name: copy
    SourcesAndDest:
    - /tmp/examples/storage-schemas.conf
    - /etc/carbon-relay-ng/storage-schemas.conf
  - Chown: ""
    From: builder
    Name: copy
    SourcesAndDest:
    - /tmp/examples/carbon-relay-ng.ini
    - /etc/carbon-relay-ng/carbon-relay-ng.ini
  - CmdLine:
    - 'apk update --quiet --no-cache  &&   apk upgrade --quiet --no-cache &&   apk
      add --no-cache --quiet --virtual .build-deps     tzdata &&   cp /usr/share/zoneinfo/${TZ}
      /etc/localtime &&   echo ${TZ} > /etc/timezone &&   apk --quiet --purge del
      .build-deps &&   mkdir -p /var/spool/carbon-relay-ng &&   chown nobody: /var/spool/carbon-relay-ng
      &&   rm -rf     /tmp/*     /var/cache/apk/*'
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - rootfs/
    - /
  - Health:
      Interval: 5000000000
      Retries: 12
      StartPeriod: 10000000000
      Test:
      - CMD-SHELL
      - ps ax | grep -v grep | grep -c "/usr/bin/carbon-relay-ng" || exit 1
      Timeout: 2000000000
    Name: healthcheck
  - CmdLine:
    - /init/run.sh
    Name: cmd
    PrependShell: false
  From:
    Image: alpine:3.7
  Name: ""
  Platform: ""
  SourceCode: FROM alpine:3.7
