MetaArgs: null
Stages:
- BaseName: ubuntu:xenial
  Commands:
  - Env:
    - Key: HTTPD_VERSION
      Value: 2.4.27
    Name: env
  - Env:
    - Key: APR_VERSIOV
      Value: 1.6.2
    Name: env
  - Env:
    - Key: APR_UTIL_VERSION
      Value: 1.6.0
    Name: env
  - Env:
    - Key: MIRROR_URL
      Value: https://www.apache.org/dyn/closer.cgi?action=download&filename=
    Name: env
  - Env:
    - Key: ARCHIVE_URL
      Value: https://archive.apache.org/dist/
    Name: env
  - Env:
    - Key: HTTPD_PATH
      Value: httpd/httpd-$HTTPD_VERSION.tar.bz2
    Name: env
  - Env:
    - Key: APR_PATH
      Value: apr/apr-$APR_VERSIOV.tar.bz2
    Name: env
  - Env:
    - Key: APR_UTIL_PATH
      Value: apr/apr-util-$APR_UTIL_VERSION.tar.bz2
    Name: env
  - Env:
    - Key: HTTPD_PREFIX
      Value: /usr/local/apache2
    Name: env
  - Env:
    - Key: PATH
      Value: $HTTPD_PREFIX/bin:$PATH
    Name: env
  - CmdLine:
    - "set -x \t&& dpkg --add-architecture i386 \t&& apt-get update \t&& deps=\"\t\tlibexpat1:i386
      \t\tlibpcre++0v5:i386 \t\tlibnghttp2-14:i386 \t\tlibssl1.0.0:i386 \t\" \t&&
      buildDeps=\" \t\tgcc-multilib \t\tg++-multilib \t\tlibexpat1-dev:i386 \t\tlibpcre++-dev:i386
      \t\tlibnghttp2-dev:i386 \t\tlibssl-dev:i386 \t\tmake \t\twget \t\tca-certificates
      \t\tbzip2 \t\" \t&& apt-get install -y --no-install-recommends \t\t$deps \t
      \t$buildDeps \t&& cd /tmp \t&& { wget -O httpd.tar.bz2 \"${MIRROR_URL}${HTTPD_PATH}\"
      \t\t|| wget -O httpd.tar.bz2 \"${ARCHIVE_URL}${HTTPD_PATH}\" ; } \t&& { wget
      -O httpd.tar.bz2.asc \"${MIRROR_URL}${HTTPD_PATH}.asc\" \t\t|| wget -O httpd.tar.bz2.asc
      \"${ARCHIVE_URL}${HTTPD_PATH}.asc\" ; } \t&& { wget -O apr.tar.bz2 \"${MIRROR_URL}${APR_PATH}\"
      \t\t|| wget -O apr.tar.bz2 \"${ARCHIVE_URL}${APR_PATH}\" ; } \t&& { wget -O
      apr.tar.bz2.asc \"${MIRROR_URL}${APR_PATH}.asc\" \t\t|| wget -O apr.tar.bz2.asc
      \"${ARCHIVE_URL}${APR_PATH}.asc\" ; } \t&& { wget -O apr-util.tar.bz2 \"${MIRROR_URL}${APR_UTIL_PATH}\"
      \t\t|| wget -O apr-util.tar.bz2 \"${ARCHIVE_URL}${APR_UTIL_PATH}\" ; } \t&&
      { wget -O apr-util.tar.bz2.asc \"${MIRROR_URL}${APR_UTIL_PATH}.asc\" \t\t||
      wget -O apr-util.tar.bz2.asc \"${ARCHIVE_URL}${APR_UTIL_PATH}.asc\" ; } \t&&
      export GNUPGHOME=\"$(mktemp -d)\" \t&& gpg --keyserver ha.pool.sks-keyservers.net
      --recv-keys A93D62ECC3C8EA12DB220EC934EA76E6791485A8 \t&& gpg --verify httpd.tar.bz2.asc
      httpd.tar.bz2 \t&& echo 'httpd verified' \t&& wget -O apr.keys https://people.apache.org/keys/group/apr.asc
      \t&& gpg --import apr.keys \t&& gpg --verify apr.tar.bz2.asc apr.tar.bz2 \t&&
      echo 'apr verified' \t&& gpg --verify apr-util.tar.bz2.asc apr-util.tar.bz2
      \t&& echo 'apr-util verified'\t&& mkdir -p /tmp/src \t&& tar -xvf /tmp/httpd.tar.bz2
      -C /tmp/src --strip-components=1 \t&& mkdir -p /tmp/src/srclib/apr \t&& tar
      -xvf /tmp/apr.tar.bz2 -C /tmp/src/srclib/apr --strip-components=1 \t&& mkdir
      -p /tmp/src/srclib/apr-util \t&& tar -xvf /tmp/apr-util.tar.bz2 -C /tmp/src/srclib/apr-util
      --strip-components=1 \t&& mkdir -p \"$HTTPD_PREFIX\" \t&& chown www-data:www-data
      \"$HTTPD_PREFIX\" \t&& cd /tmp/src \t&& ./configure \t\t--prefix=\"$HTTPD_PREFIX\"
      \t\t--enable-mods-shared=reallyall \t\t--enable-http2 \t\t--with-included-apr
      \t\t--host=i686-linux-gnu \"CFLAGS=-m32\" \"CXXFLAGS=-m32\" \"LDFLAGS=-m32\"
      \t&& make -j\"$(nproc)\" \t&& make install \t&& sed -ri \t\t-e 's!^(\\s*CustomLog)\\s+\\S+!\\1
      /proc/self/fd/1!g' \t\t-e 's!^(\\s*ErrorLog)\\s+\\S+!\\1 /proc/self/fd/2!g'
      \t\t\"$HTTPD_PREFIX/conf/httpd.conf\" \t&& apt-get purge -y --auto-remove $buildDeps
      \t&& rm -rf /var/lib/apt/lists/* \t&& rm -rf /tmp/*"
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - httpd-foreground
    - /usr/local/bin/
  - CmdLine:
    - chmod +x /usr/local/bin/httpd-foreground
    Name: run
    PrependShell: true
  - Name: expose
    Ports:
    - "80"
  - CmdLine:
    - httpd-foreground
    Name: cmd
    PrependShell: false
  From:
    Image: ubuntu:xenial
  Name: ""
  Platform: ""
  SourceCode: FROM ubuntu:xenial
