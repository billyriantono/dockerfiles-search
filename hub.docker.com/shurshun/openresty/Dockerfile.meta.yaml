MetaArgs: null
Stages:
- BaseName: shurshun/alpine-moscow
  Commands:
  - Labels:
    - Key: author
      Value: '"Korviakov Andrey"'
    Name: label
  - Labels:
    - Key: maintainer
      Value: '"4lifenet@gmail.com"'
    Name: label
  - Labels:
    - Key: SERVICE_NAME
      Value: '"nginx"'
    Name: label
  - Health:
      Test:
      - CMD-SHELL
      - docker-healthcheck
    Name: healthcheck
  - Key: RESTY_VERSION
    Name: arg
    Value: '"1.11.2.3"'
  - Key: RESTY_LUAROCKS_VERSION
    Name: arg
    Value: '"2.4.2"'
  - Key: RESTY_OPENSSL_VERSION
    Name: arg
    Value: '"1.0.2l"'
  - Key: RESTY_PCRE_VERSION
    Name: arg
    Value: '"8.40"'
  - Key: RESTY_J
    Name: arg
    Value: '"1"'
  - Key: RESTY_GEOIP2_VERSION
    Name: arg
    Value: '"2.0"'
  - Key: RESTY_NPS_VERSION
    Name: arg
    Value: '"1.12.34.2"'
  - Key: RESTY_KETAMA_CHASH_VERSION
    Name: arg
    Value: '"0.6"'
  - Key: RESTY_CONFIG_OPTIONS
    Name: arg
    Value: '"    --prefix=/usr/share     --conf-path=/etc/nginx/nginx.conf     --sbin-path=/usr/sbin/nginx     --error-log-path=/var/log/nginx/error.log     --http-log-path=/var/log/nginx/access.log     --pid-path=/var/run/nginx.pid     --lock-path=/var/run/nginx.lock     --http-client-body-temp-path=/var/cache/nginx/client_temp     --http-proxy-temp-path=/var/cache/nginx/proxy_temp     --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp     --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp     --http-scgi-temp-path=/var/cache/nginx/scgi_temp     --with-file-aio     --with-http_addition_module     --with-http_auth_request_module     --with-http_gunzip_module     --with-http_gzip_static_module     --with-http_image_filter_module=dynamic     --with-http_realip_module     --with-http_secure_link_module     --with-http_slice_module     --with-http_ssl_module     --with-http_stub_status_module     --with-http_sub_module     --with-http_v2_module     --with-ipv6     --with-md5-asm     --with-pcre-jit     --with-sha1-asm     --with-stream     --with-stream_ssl_module     --with-threads     --without-http_redis2_module     --without-http_redis_module     --without-http_rds_csv_module     --without-http_rds_json_module     --add-module=/tmp/ngx_http_geoip2_module-${RESTY_GEOIP2_VERSION}     --add-module=/tmp/ngx_http_upstream_ketama_chash-${RESTY_KETAMA_CHASH_VERSION}     "'
  - Key: _RESTY_CONFIG_DEPS
    Name: arg
    Value: '"--with-openssl=/tmp/openssl-${RESTY_OPENSSL_VERSION} --with-pcre=/tmp/pcre-${RESTY_PCRE_VERSION}"'
  - Env:
    - Key: PCRE_CONF_OPT
      Value: '"--enable-utf8 --enable-unicode-properties"'
    Name: env
  - CmdLine:
    - apk add --no-cache --update --virtual .build-deps         build-base         git         gd-dev         libxslt-dev         linux-headers         cmake         make         perl-dev         readline-dev         zlib-dev         libmaxminddb-dev     &&
      apk add --no-cache --update         curl         jq         gd         libgcc         libxslt         zlib         libmaxminddb     &&
      cd /tmp     && curl -fSL https://www.openssl.org/source/openssl-${RESTY_OPENSSL_VERSION}.tar.gz
      | tar -zx         && curl -fSL https://ftp.pcre.org/pub/pcre/pcre-${RESTY_PCRE_VERSION}.tar.gz
      | tar -zx         && curl -fSl https://codeload.github.com/leev/ngx_http_geoip2_module/tar.gz/${RESTY_GEOIP2_VERSION}
      | tar -zx         && curl -fSlL https://github.com/flygoast/ngx_http_upstream_ketama_chash/archive/v${RESTY_KETAMA_CHASH_VERSION}.tar.gz
      | tar -zx         && curl -fSL https://openresty.org/download/openresty-${RESTY_VERSION}.tar.gz
      | tar -zx     && cd /tmp/openresty-${RESTY_VERSION}     && ./configure -j${RESTY_J}
      ${_RESTY_CONFIG_DEPS} ${RESTY_CONFIG_OPTIONS}     && make -j${RESTY_J}     &&
      make -j${RESTY_J} install     && cd /tmp     && curl -fSL http://luarocks.github.io/luarocks/releases/luarocks-${RESTY_LUAROCKS_VERSION}.tar.gz
      | tar -zx     && cd luarocks-${RESTY_LUAROCKS_VERSION}     && ./configure         --prefix=/usr/share/luajit         --with-lua=/usr/share/luajit         --lua-suffix=jit-2.1.0-beta2         --with-lua-include=/usr/share/luajit/include/luajit-2.1     &&
      make build     && make install     && ln -s /usr/share/luajit/bin/luarocks /bin/luarocks     &&
      cd /tmp         && ln -sf /dev/stdout /var/log/nginx/access.log     && ln -sf
      /dev/stderr /var/log/nginx/error.log         && mkdir -p /usr/share/geoip2     &&
      curl -fSL http://geolite.maxmind.com/download/geoip/database/GeoLite2-Country.mmdb.gz
      | gzip -d  > /usr/share/geoip2/GeoLite2-Country.mmdb     && curl -fSL http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.mmdb.gz
      | gzip -d  > /usr/share/geoip2/GeoLite2-City.mmdb         && git clone https://github.com/DaveGamble/cJSON     &&
      cd cJSON && cmake . && make && make install && cd ..         && mkdir -p /var/cache/nginx
      /etc/nginx/sites-enabled /etc/nginx/upstream-conf.d /etc/nginx/templates         &&
      apk del .build-deps     && rm -rf /tmp/*     && rm -f /etc/nginx/conf.d/default.conf
    Name: run
    PrependShell: true
  - CmdLine:
    - apk add --no-cache --update --virtual .build-deps         build-base         git         cmake         make         &&
      luarocks install lua-resty-libcjson     && sed -ie 's#ffi_load "cjson"#ffi_load
      "/usr/local/lib/libcjson.so"#' /usr/share/luajit/share/lua/5.1/resty/libcjson.lua     &&
      luarocks install lua-resty-http     && luarocks install statsd     && luarocks
      install lua-resty-statsd     && luarocks install lua-resty-beanstalkd     &&
      luarocks install lua-resty-jit-uuid     && luarocks install lua-resty-cookie         &&
      apk del .build-deps
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - conf/
    - /etc/nginx
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - bin/
    - /usr/local/bin
  - CmdLine:
    - find /usr/local/bin -type f -exec chmod +x {} \;
    Name: run
    PrependShell: true
  - CmdLine:
    - nginx
    Name: cmd
    PrependShell: false
  From:
    Image: shurshun/alpine-moscow
  Name: ""
  Platform: ""
  SourceCode: FROM shurshun/alpine-moscow
