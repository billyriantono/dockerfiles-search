MetaArgs: null
Stages:
- BaseName: ruby:2.6.1-alpine3.9
  Commands:
  - Key: VERSION
    Name: arg
    Value: v2.9.0
  - Key: REPOSITORY
    Name: arg
    Value: tootsuite/mastodon
  - Key: LIBICONV_VERSION
    Name: arg
    Value: "1.15"
  - Env:
    - Key: UID
      Value: "991"
    - Key: GID
      Value: "991"
    - Key: RUN_DB_MIGRATIONS
      Value: "true"
    - Key: SIDEKIQ_WORKERS
      Value: "5"
    - Key: RAILS_SERVE_STATIC_FILES
      Value: "true"
    - Key: RAILS_ENV
      Value: production
    - Key: NODE_ENV
      Value: production
    - Key: PATH
      Value: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/mastodon/bin
    Name: env
  - Name: workdir
    Path: /mastodon
  - CmdLine:
    - apk -U upgrade  && apk add     ca-certificates     ffmpeg     file     git     icu-libs     imagemagick     libidn     libxml2     libxslt     libpq     nodejs     npm     openssl     protobuf     s6     su-exec     tzdata  &&
      apk add -t build-dependencies     build-base     icu-dev     libidn-dev     libtool     libxml2-dev     libxslt-dev     postgresql-dev     protobuf-dev     python     tar     yarn  &&
      update-ca-certificates  && wget http://ftp.gnu.org/pub/gnu/libiconv/libiconv-${LIBICONV_VERSION}.tar.gz
      -O /tmp/libiconv-${LIBICONV_VERSION}.tar.gz  && mkdir /tmp/src && tar xzf /tmp/libiconv-${LIBICONV_VERSION}.tar.gz
      -C /tmp/src  && cd /tmp/src/libiconv-${LIBICONV_VERSION}  && ./configure --prefix=/usr/local  &&
      make -j$(getconf _NPROCESSORS_ONLN) && make install && libtool --finish /usr/local/lib  &&
      cd /mastodon  && wget -qO- https://github.com/${REPOSITORY}/archive/${VERSION}.tar.gz
      | tar xz --strip 1  && bundle config build.nokogiri --use-system-libraries --with-iconv-lib=/usr/local/lib
      --with-iconv-include=/usr/local/include  && bundle install -j$(getconf _NPROCESSORS_ONLN)
      --deployment --clean --no-cache --without test development  && yarn install
      --pure-lockfile --ignore-engines  && OTP_SECRET=precompile_placeholder SECRET_KEY_BASE=precompile_placeholder
      bundle exec rails assets:precompile  && npm -g --force cache clean && yarn cache
      clean  && apk del build-dependencies  && rm -rf /var/cache/apk/* /tmp/src
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - rootfs
    - /
  - CmdLine:
    - chmod +x /usr/local/bin/* /etc/s6.d/*/* /etc/s6.d/.s6-svscan/*
    Name: run
    PrependShell: true
  - Name: volume
    Volumes:
    - /mastodon/public/system
    - /mastodon/log
  - Name: expose
    Ports:
    - "3000"
    - "4000"
  - Labels:
    - Key: maintainer
      Value: '"Wonderfall <wonderfall@targaryen.house>"'
    - Key: description
      Value: '"Your self-hosted, globally interconnected microblogging community"'
    Name: label
  - CmdLine:
    - /usr/local/bin/run
    Name: entrypoint
    PrependShell: false
  - CmdLine:
    - /bin/s6-svscan
    - /etc/s6.d
    Name: cmd
    PrependShell: false
  From:
    Image: ruby:2.6.1-alpine3.9
  Name: ""
  Platform: ""
  SourceCode: FROM ruby:2.6.1-alpine3.9
