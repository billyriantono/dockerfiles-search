{
  "MetaArgs": [
    {
      "Key": "FSLIMAGE_VERSION",
      "DefaultValue": "v2.0",
      "ProvidedValue": null,
      "Value": "v2.0"
    },
    {
      "Key": "BIDSAPP_BUILDER_VERSION",
      "DefaultValue": "v1.5",
      "ProvidedValue": null,
      "Value": "v1.5"
    }
  ],
  "Stages": [
    {
      "Name": "builder",
      "BaseName": "cbinyu/bidsapp_builder:${BIDSAPP_BUILDER_VERSION}",
      "SourceCode": "FROM cbinyu/bidsapp_builder:${BIDSAPP_BUILDER_VERSION} as builder",
      "Platform": "",
      "As": "builder",
      "From": {
        "Image": "cbinyu/bidsapp_builder:${BIDSAPP_BUILDER_VERSION}"
      },
      "Commands": [
        {
          "CmdLine": [
            "apt-get update \u0026\u0026 apt-get upgrade -y \u0026\u0026 apt-get install -y     g++   \u0026\u0026 apt-get clean -y \u0026\u0026 apt-get autoclean -y \u0026\u0026 apt-get autoremove -y"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "Env": [
            {
              "Key": "PYDEFACE_VERSION",
              "Value": "2.0.0"
            }
          ],
          "Name": "env"
        },
        {
          "CmdLine": [
            "pip install pydeface==${PYDEFACE_VERSION} \u0026\u0026     sed -i -e \"s/which('fsl')/which('flirt')/\" ${PYTHON_LIB_PATH}/site-packages/pydeface/utils.py"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "CmdLine": [
            "rm -r ${PYTHON_LIB_PATH}/site-packages/scipy \u0026\u0026     find ${PYTHON_LIB_PATH}/site-packages/ -type d -name \"tests\"  -print0 | xargs -0 rm -r"
          ],
          "Name": "run",
          "PrependShell": true
        }
      ]
    },
    {
      "Name": "fsl_builder",
      "BaseName": "cbinyu/fsl6-core:${FSLIMAGE_VERSION}",
      "SourceCode": "FROM cbinyu/fsl6-core:${FSLIMAGE_VERSION} as fsl_builder",
      "Platform": "",
      "As": "fsl_builder",
      "From": {
        "Image": "cbinyu/fsl6-core:${FSLIMAGE_VERSION}"
      },
      "Commands": null
    },
    {
      "Name": "application",
      "BaseName": "cbinyu/bidsapp_builder:${BIDSAPP_BUILDER_VERSION}",
      "SourceCode": "FROM cbinyu/bidsapp_builder:${BIDSAPP_BUILDER_VERSION} as Application",
      "Platform": "",
      "As": "application",
      "From": {
        "Image": "cbinyu/bidsapp_builder:${BIDSAPP_BUILDER_VERSION}"
      },
      "Commands": [
        {
          "Env": [
            {
              "Key": "FSLDIR",
              "Value": "/usr/local/fsl/"
            },
            {
              "Key": "FSLOUTPUTTYPE",
              "Value": "NIFTI_GZ"
            }
          ],
          "Name": "env"
        },
        {
          "Env": [
            {
              "Key": "PATH",
              "Value": "${FSLDIR}/bin:$PATH"
            },
            {
              "Key": "LD_LIBRARY_PATH",
              "Value": "${FSLDIR}:${LD_LIBRARY_PATH}"
            }
          ],
          "Name": "env"
        },
        {
          "Chown": "",
          "From": "builder",
          "Name": "copy",
          "SourcesAndDest": [
            "./${PYTHON_LIB_PATH}/site-packages/",
            "${PYTHON_LIB_PATH}/site-packages/"
          ]
        },
        {
          "Chown": "",
          "From": "builder",
          "Name": "copy",
          "SourcesAndDest": [
            "./usr/local/bin/",
            "/usr/local/bin/"
          ]
        },
        {
          "Chown": "",
          "From": "fsl_builder",
          "Name": "copy",
          "SourcesAndDest": [
            "./${FSLDIR}/bin/flirt",
            "${FSLDIR}/bin/"
          ]
        },
        {
          "Chown": "",
          "From": "fsl_builder",
          "Name": "copy",
          "SourcesAndDest": [
            "./${FSLDIR}/lib/libopenblas.so.0",
            "./${FSLDIR}/lib/libgfortran.so.3",
            "${FSLDIR}/lib/"
          ]
        },
        {
          "Chown": "",
          "From": "fsl_builder",
          "Name": "copy",
          "SourcesAndDest": [
            "./usr/lib/x86_64-linux-gnu/libquadmath.so.0",
            "./usr/lib/x86_64-linux-gnu/libquadmath.so.0.0.0",
            "/usr/lib/x86_64-linux-gnu/"
          ]
        },
        {
          "Chown": "",
          "From": "",
          "Name": "copy",
          "SourcesAndDest": [
            "run.py",
            "version",
            "/"
          ]
        },
        {
          "CmdLine": [
            "chmod a+rx /run.py /version"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "CmdLine": [
            "/run.py"
          ],
          "Name": "entrypoint",
          "PrependShell": false
        }
      ]
    }
  ]
}