{
  "MetaArgs": null,
  "Stages": [
    {
      "Name": "",
      "BaseName": "centos",
      "SourceCode": "FROM centos",
      "Platform": "",
      "From": {
        "Image": "centos"
      },
      "Commands": [
        {
          "Maintainer": "loutian \u003cloutian@gmail.com\u003e",
          "Name": "maintainer"
        },
        {
          "Env": [
            {
              "Key": "NGINX_VERSION",
              "Value": "1.14.0"
            }
          ],
          "Name": "env"
        },
        {
          "Env": [
            {
              "Key": "PHP_VERSION",
              "Value": "7.2.5"
            }
          ],
          "Name": "env"
        },
        {
          "CmdLine": [
            "cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \u0026\u0026 yum install -y gcc     gcc-c++     autoconf     automake     libtool     zip     unzip     make     cmake \u0026\u0026     yum clean all"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "CmdLine": [
            "rpm -ivh http://dl.fedoraproject.org/pub/epel/7/x86_64/Packages/e/epel-release-7-11.noarch.rpm \u0026\u0026     yum install -y wget     zlib     zlib-devel     openssl     openssl-devel     pcre-devel     libxml2     libxml2-devel     libcurl     libcurl-devel     libpng-devel     libjpeg-devel     freetype-devel     libmcrypt-devel     openssh-server     mysql     python-setuptools \u0026\u0026     yum clean all"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "CmdLine": [
            "groupadd -r www \u0026\u0026     useradd -M -s /sbin/nologin -r -g www www"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "CmdLine": [
            "mkdir -p /home/nginx-php \u0026\u0026 cd $_ \u0026\u0026     wget -c -O nginx.tar.gz http://nginx.org/download/nginx-$NGINX_VERSION.tar.gz \u0026\u0026     wget -O php.tar.gz http://php.net/distributions/php-$PHP_VERSION.tar.gz"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "CmdLine": [
            "cd /home/nginx-php \u0026\u0026     tar -zxvf nginx.tar.gz \u0026\u0026     cd nginx-$NGINX_VERSION \u0026\u0026     ./configure --prefix=/usr/local/nginx     --user=www --group=www     --error-log-path=/var/log/nginx_error.log     --http-log-path=/var/log/nginx_access.log     --pid-path=/var/run/nginx.pid     --with-pcre     --with-http_ssl_module     --with-http_realip_module     --with-http_v2_module     --without-mail_pop3_module     --without-mail_imap_module     --with-http_gzip_static_module \u0026\u0026     make -j8 \u0026\u0026 make install"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "CmdLine": [
            "cd /home/nginx-php \u0026\u0026     tar zvxf php.tar.gz \u0026\u0026     cd php-$PHP_VERSION \u0026\u0026     ./configure --prefix=/usr/local/php     --with-config-file-path=/usr/local/php/etc     --with-config-file-scan-dir=/usr/local/php/etc/php.d     --with-fpm-user=www     --with-fpm-group=www     --with-mcrypt=/usr/include     --with-mysqli     --with-pdo-mysql     --with-openssl     --with-gd     --with-iconv     --with-zlib     --with-gettext     --with-curl     --with-png-dir     --with-jpeg-dir     --with-freetype-dir     --with-xmlrpc     --with-mhash     --enable-fpm     --enable-xml     --enable-shmop     --enable-sysvsem     --enable-inline-optimization     --enable-mbregex     --enable-mbstring     --enable-ftp     --enable-gd-native-ttf     --enable-mysqlnd     --enable-pcntl     --enable-sockets     --enable-zip     --enable-soap     --enable-session     --enable-opcache     --enable-bcmath     --enable-exif     --enable-fileinfo     --disable-rpath     --enable-ipv6     --disable-debug     --without-pear \u0026\u0026     make -j8 \u0026\u0026 make install"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "CmdLine": [
            "cd /home/nginx-php/php-$PHP_VERSION \u0026\u0026     cp php.ini-production /usr/local/php/etc/php.ini \u0026\u0026     cp /usr/local/php/etc/php-fpm.conf.default /usr/local/php/etc/php-fpm.conf \u0026\u0026     cp /usr/local/php/etc/php-fpm.d/www.conf.default /usr/local/php/etc/php-fpm.d/www.conf"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "CmdLine": [
            "ln -s /usr/local/php/bin/php /usr/local/bin/php"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "CmdLine": [
            "easy_install supervisor \u0026\u0026     mkdir -p /var/log/supervisor \u0026\u0026     mkdir -p /var/run/supervisord"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "Chown": "",
          "Name": "add",
          "SourcesAndDest": [
            "config/php.ini",
            "/usr/local/php/etc/php.ini"
          ]
        },
        {
          "Name": "workdir",
          "Path": "/root/"
        },
        {
          "Chown": "",
          "Name": "add",
          "SourcesAndDest": [
            "config/supervisord.conf",
            "/etc/supervisord.conf"
          ]
        },
        {
          "CmdLine": [
            "cd / \u0026\u0026 rm -rf /home/nginx-php"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "CmdLine": [
            "php -r \"copy('https://getcomposer.org/installer', 'composer-setup.php');\" \u0026\u0026     php -r \"if (hash_file('SHA384', 'composer-setup.php') === '544e09ee996cdf60ece3804abc52599c22b1f40f4323403c44d44fdfdd586475ca9813a858088ffbc1f233e9b180f061') { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php'); } echo PHP_EOL;\" \u0026\u0026     php composer-setup.php \u0026\u0026     php -r \"unlink('composer-setup.php');\" \u0026\u0026     mv composer.phar /usr/local/bin/composer \u0026\u0026 chmod +x /usr/local/bin/composer"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "Chown": "",
          "From": "",
          "Name": "copy",
          "SourcesAndDest": [
            "package/mongodb-1.4.3.tgz",
            "/tmp/"
          ]
        },
        {
          "Name": "workdir",
          "Path": "/tmp/"
        },
        {
          "CmdLine": [
            "tar xvzf mongodb-1.4.3.tgz"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "Name": "workdir",
          "Path": "/tmp/mongodb-1.4.3/"
        },
        {
          "CmdLine": [
            "/usr/local/php/bin/phpize \u0026\u0026 ./configure --with-php-config=/usr/local/php/bin/php-config \u0026\u0026  make \u0026\u0026 make install \u0026\u0026 echo \"extension=mongodb.so\" \u003e\u003e /usr/local/php/etc/php.ini"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "Name": "workdir",
          "Path": "/data/www/"
        },
        {
          "Name": "volume",
          "Volumes": [
            "/data/www",
            "/usr/local/nginx/conf/ssl",
            "/usr/local/nginx/conf/vhost",
            "/usr/local/php/etc/php.d"
          ]
        },
        {
          "Chown": "",
          "Name": "add",
          "SourcesAndDest": [
            "config/nginx.conf",
            "/usr/local/nginx/conf/nginx.conf"
          ]
        },
        {
          "CmdLine": [
            "chown -R www. /data/www/"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "Chown": "",
          "Name": "add",
          "SourcesAndDest": [
            "start.sh",
            "/start.sh"
          ]
        },
        {
          "CmdLine": [
            "chmod +x /start.sh"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "Name": "expose",
          "Ports": [
            "443",
            "80",
            "9000"
          ]
        },
        {
          "CmdLine": [
            "/start.sh"
          ],
          "Name": "entrypoint",
          "PrependShell": false
        }
      ]
    }
  ]
}