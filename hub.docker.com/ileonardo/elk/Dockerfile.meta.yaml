MetaArgs: null
Stages:
- BaseName: ubuntu
  Commands:
  - Maintainer: iLeonardo Carvalho <i.leonardo.c.c@outlook.com>
    Name: maintainer
  - Env:
    - Key: ELASTICSEARCH
      Value: 2.3.4
    Name: env
  - Env:
    - Key: LOGSTASH
      Value: 2.3.4
    Name: env
  - Env:
    - Key: KIBANA
      Value: 4.5.3
    Name: env
  - Env:
    - Key: JAVA
      Value: "7"
    Name: env
  - Env:
    - Key: LOG_ROOT
      Value: /opt/logs
    Name: env
  - Env:
    - Key: ELASTICSEARCH_HOME
      Value: /opt/elasticsearch
    Name: env
  - Env:
    - Key: ELASTICSEARCH_CONFIG_DIRECTORY
      Value: ${ELASTICSEARCH_HOME}/config
    Name: env
  - Env:
    - Key: ELASTICSEARCH_CONFIG_FILE
      Value: ${ELASTICSEARCH_CONFIG_DIRECTORY}/elasticsearch.yml
    Name: env
  - Env:
    - Key: ELASTICSEARCH_LOG_DIRECTORY
      Value: ${LOG_ROOT}/elasticsearch
    Name: env
  - Env:
    - Key: LOGSTASH_HOME
      Value: /opt/logstash
    Name: env
  - Env:
    - Key: LOGSTASH_CONFIG_DIRECTORY
      Value: ${LOGSTASH_HOME}/conf.d
    Name: env
  - Env:
    - Key: LOGSTASH_PATTERNS_DIRECTORY
      Value: ${LOGSTASH_HOME}/patterns
    Name: env
  - Env:
    - Key: LOGSTASH_LOG_DIRECTORY
      Value: ${LOG_ROOT}/logstash
    Name: env
  - Env:
    - Key: KIBANA_HOME
      Value: /opt/kibana
    Name: env
  - Env:
    - Key: KIBANA_CONFIG_DIRECTORY
      Value: ${KIBANA_HOME}/config
    Name: env
  - Env:
    - Key: KIBANA_CONFIG_FILE
      Value: ${KIBANA_CONFIG_DIRECTORY}/kibana.yml
    Name: env
  - Env:
    - Key: KIBANA_LOG_DIRECTORY
      Value: ${LOG_ROOT}/kibana
    Name: env
  - Name: workdir
    Path: ~/
  - CmdLine:
    - echo oracle-java${JAVA}-installer shared/accepted-oracle-license-v1-1 select
      true | debconf-set-selections
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get update
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get -qqy install software-properties-common
    Name: run
    PrependShell: true
  - CmdLine:
    - add-apt-repository -y ppa:webupd8team/java
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get update
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get --no-install-recommends -qqy install net-tools vim wget curl collectd
      collectd-utils liboping0 oracle-java${JAVA}-installer ca-certificates supervisor
    Name: run
    PrependShell: true
  - Env:
    - Key: JAVA_HOME
      Value: /usr/lib/jvm/java-${JAVA}-oracle
    Name: env
  - Env:
    - Key: PATH
      Value: '"$PATH:${JAVA_HOME}/bin"'
    Name: env
  - CmdLine:
    - chmod -R 755 ${JAVA_HOME}
    Name: run
    PrependShell: true
  - CmdLine:
    - echo "JAVA_HOME=${JAVA_HOME}" >> /etc/environment
    Name: run
    PrependShell: true
  - CmdLine:
    - sed -i '/PATH/c\PATH='"'$PATH:${JAVA_HOME}/bin\'"'' /etc/environment
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /opt
  - Env:
    - Key: ES_GID
      Value: "991"
    Name: env
  - Env:
    - Key: ES_UID
      Value: ${ES_GID}
    Name: env
  - CmdLine:
    - groupadd -r elasticsearch -g ${ES_GID}
    Name: run
    PrependShell: true
  - CmdLine:
    - useradd -r -s /usr/sbin/nologin -M -c "Elasticsearch service user" -u ${ES_UID}
      -g elasticsearch elasticsearch
    Name: run
    PrependShell: true
  - CmdLine:
    - wget https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/tar/elasticsearch/${ELASTICSEARCH}/elasticsearch-${ELASTICSEARCH}.tar.gz
    Name: run
    PrependShell: true
  - Env:
    - Key: LOGSTASH_GID
      Value: "992"
    Name: env
  - Env:
    - Key: LOGSTASH_UID
      Value: ${LOGSTASH_GID}
    Name: env
  - CmdLine:
    - groupadd -r logstash -g ${LOGSTASH_GID}
    Name: run
    PrependShell: true
  - CmdLine:
    - useradd -r -s /usr/sbin/nologin -M -c "Logstash service user" -u ${LOGSTASH_UID}
      -g logstash logstash
    Name: run
    PrependShell: true
  - CmdLine:
    - wget https://download.elastic.co/logstash/logstash/logstash-${LOGSTASH}.tar.gz
    Name: run
    PrependShell: true
  - Env:
    - Key: KIBANA_GID
      Value: "993"
    Name: env
  - Env:
    - Key: KIBANA_UID
      Value: ${KIBANA_GID}
    Name: env
  - CmdLine:
    - groupadd -r kibana -g ${KIBANA_GID}
    Name: run
    PrependShell: true
  - CmdLine:
    - useradd -r -s /usr/sbin/nologin -M -c "Kibana service user" -u ${KIBANA_UID}
      -g kibana kibana
    Name: run
    PrependShell: true
  - CmdLine:
    - wget https://download.elastic.co/kibana/kibana/kibana-${KIBANA}-linux-x64.tar.gz
    Name: run
    PrependShell: true
  - CmdLine:
    - mkdir -p ${ELASTICSEARCH_HOME} ${LOGSTASH_HOME} ${KIBANA_HOME}
    Name: run
    PrependShell: true
  - CmdLine:
    - mkdir -p ${ELASTICSEARCH_LOG_DIRECTORY} ${LOGSTASH_LOG_DIRECTORY} ${KIBANA_LOG_DIRECTORY}
    Name: run
    PrependShell: true
  - CmdLine:
    - mkdir -p ${LOGSTASH_CONFIG_DIRECTORY} ${LOGSTASH_PATTERNS_DIRECTORY}
    Name: run
    PrependShell: true
  - CmdLine:
    - tar -xzf elasticsearch*.tar.gz  -C ${ELASTICSEARCH_HOME} --strip-components=1
    Name: run
    PrependShell: true
  - CmdLine:
    - tar -xzf logstash*.tar.gz  -C ${LOGSTASH_HOME} --strip-components=1
    Name: run
    PrependShell: true
  - CmdLine:
    - tar -xzf kibana*.tar.gz  -C ${KIBANA_HOME} --strip-components=1
    Name: run
    PrependShell: true
  - CmdLine:
    - rm *.tar.gz
    Name: run
    PrependShell: true
  - CmdLine:
    - ${ELASTICSEARCH_HOME}/bin/plugin install cloud-aws -b
    Name: run
    PrependShell: true
  - CmdLine:
    - ${ELASTICSEARCH_HOME}/bin/plugin install lmenezes/elasticsearch-kopf
    Name: run
    PrependShell: true
  - CmdLine:
    - ${LOGSTASH_HOME}/bin/logstash-plugin install logstash-input-jmx
    Name: run
    PrependShell: true
  - CmdLine:
    - ${LOGSTASH_HOME}/bin/logstash-plugin install logstash-filter-json
    Name: run
    PrependShell: true
  - CmdLine:
    - ${LOGSTASH_HOME}/bin/logstash-plugin install logstash-filter-translate
    Name: run
    PrependShell: true
  - CmdLine:
    - ${LOGSTASH_HOME}/bin/logstash-plugin install logstash-input-cloudwatch
    Name: run
    PrependShell: true
  - CmdLine:
    - ${KIBANA_HOME}/bin/kibana plugin --install elastic/sense
    Name: run
    PrependShell: true
  - CmdLine:
    - rm ${ELASTICSEARCH_CONFIG_FILE} /etc/collectd/collectd.conf
    Name: run
    PrependShell: true
  - Chown: ""
    Name: add
    SourcesAndDest:
    - ./elasticsearch.yml
    - ${ELASTICSEARCH_CONFIG_FILE}
  - Chown: ""
    Name: add
    SourcesAndDest:
    - ./kibana.yml
    - ${KIBANA_CONFIG_FILE}
  - Chown: ""
    Name: add
    SourcesAndDest:
    - ./conf.d/collectd.conf
    - ${LOGSTASH_CONFIG_DIRECTORY}
  - Chown: ""
    Name: add
    SourcesAndDest:
    - ./conf.d/logstash.conf
    - ${LOGSTASH_CONFIG_DIRECTORY}
  - Chown: ""
    Name: add
    SourcesAndDest:
    - ./collectd.conf
    - /etc/collectd/collectd.conf
  - CmdLine:
    - chmod 755 ${LOGSTASH_CONFIG_DIRECTORY}
    Name: run
    PrependShell: true
  - CmdLine:
    - chmod 644 ${LOGSTASH_CONFIG_DIRECTORY}/*
    Name: run
    PrependShell: true
  - CmdLine:
    - mkdir -p /usr/local/lib && ln -s /usr/lib/*/libzmq.so.3 /usr/local/lib/libzmq.so
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /usr/sbin
  - CmdLine:
    - ln -sf ${ELASTICSEARCH_HOME}/bin/elasticsearch
    Name: run
    PrependShell: true
  - CmdLine:
    - ln -sf ${LOGSTASH_HOME}/bin/logstash
    Name: run
    PrependShell: true
  - CmdLine:
    - ln -sf ${KIBANA_HOME}/bin/kibana
    Name: run
    PrependShell: true
  - Chown: ""
    Name: add
    SourcesAndDest:
    - ./init.d
    - /etc/init.d/
  - CmdLine:
    - chmod +x /etc/init.d/elasticsearch
    Name: run
    PrependShell: true
  - CmdLine:
    - chmod +x /etc/init.d/logstash
    Name: run
    PrependShell: true
  - CmdLine:
    - chmod +x /etc/init.d/kibana
    Name: run
    PrependShell: true
  - CmdLine:
    - update-rc.d elasticsearch defaults 95 10
    Name: run
    PrependShell: true
  - CmdLine:
    - update-rc.d logstash defaults 97 8
    Name: run
    PrependShell: true
  - CmdLine:
    - update-rc.d kibana defaults 96 9
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get -qqy install supervisor
    Name: run
    PrependShell: true
  - CmdLine:
    - mkdir -p /var/log/supervisor
    Name: run
    PrependShell: true
  - CmdLine:
    - touch /var/log/supervisor/supervisor.log
    Name: run
    PrependShell: true
  - Chown: ""
    Name: add
    SourcesAndDest:
    - ./supervisor
    - /etc/supervisor/conf.d/
  - CmdLine:
    - apt-get -qqy autoremove
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get autoclean
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get clean
    Name: run
    PrependShell: true
  - CmdLine:
    - rm -rf /var/lib/apt/lists/*
    Name: run
    PrependShell: true
  - CmdLine:
    - rm -rf /var/cache/oracle-jdk${JAVA}-installer
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /opt
  - Name: expose
    Ports:
    - "5000"
    - "5601"
    - "9200"
    - "9300"
  - CmdLine:
    - /usr/bin/supervisord
    - -n
    - -c
    - /etc/supervisor/supervisord.conf
    Name: cmd
    PrependShell: false
  From:
    Image: ubuntu
  Name: ""
  Platform: ""
  SourceCode: FROM ubuntu
