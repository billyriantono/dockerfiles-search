MetaArgs: null
Stages:
- BaseName: php:7.0-apache
  Commands:
  - Maintainer: Raphael Bicker
    Name: maintainer
  - Env:
    - Key: MYSQL_ICINGAWEB_DB
      Value: icingaweb2
    Name: env
  - Env:
    - Key: MYSQL_ICINGAWEB_USER
      Value: icingaweb2
    Name: env
  - Env:
    - Key: MYSQL_ICINGAWEB_PASSWORD
      Value: icingaweb2
    Name: env
  - Env:
    - Key: MYSQL_DIRECTOR_DB
      Value: director
    Name: env
  - Env:
    - Key: MYSQL_DIRECTOR_USER
      Value: director
    Name: env
  - Env:
    - Key: MYSQL_DIRECTOR_PASSWORD
      Value: director
    Name: env
  - Env:
    - Key: ADMIN_USER
      Value: admin
    Name: env
  - Env:
    - Key: ADMIN_PASSWORD
      Value: admin
    Name: env
  - Env:
    - Key: ICINGAWEB2_VERSION
      Value: master
    Name: env
  - Env:
    - Key: ICINGAWEB2_DIRECTOR_VERSION
      Value: master
    Name: env
  - Env:
    - Key: DEBIAN_FRONTEND
      Value: noninteractive
    Name: env
  - CmdLine:
    - apt-get -q update   && apt-get -qqy upgrade   && apt-get install -y git mysql-client
      sudo sshpass     zlib1g-dev libicu-dev g++ libpng12-dev libjpeg62-turbo-dev  libfreetype6-dev
      libldap2-dev libcurl4-openssl-dev
    Name: run
    PrependShell: true
  - CmdLine:
    - docker-php-ext-configure intl   && docker-php-ext-configure gd --with-freetype-dir=/usr/include/
      --with-jpeg-dir=/usr/include/   && docker-php-ext-configure ldap --with-libdir=lib/x86_64-linux-gnu   &&
      docker-php-ext-install -j$(nproc) intl gd ldap gettext curl pdo pdo_mysql
    Name: run
    PrependShell: true
  - CmdLine:
    - a2enmod rewrite
    Name: run
    PrependShell: true
  - CmdLine:
    - addgroup --system icingaweb2   && usermod -a -G icingaweb2 www-data
    Name: run
    PrependShell: true
  - CmdLine:
    - git clone http://git.icinga.org/icingaweb2.git /usr/share/icingaweb2   && git
      -C /usr/share/icingaweb2 checkout $ICINGAWEB2_VERSION   && git clone http://github.com/Icinga/icingaweb2-module-director.git
      /usr/share/icingaweb2/modules/director   && git -C /usr/share/icingaweb2/modules/director
      checkout $ICINGAWEB2_DIRECTOR_VERSION
    Name: run
    PrependShell: true
  - CmdLine:
    - /usr/share/icingaweb2/bin/icingacli setup config directory
    Name: run
    PrependShell: true
  - CmdLine:
    - mkdir -p /etc/icingaweb2/modules/monitoring   && mkdir -p /etc/icingaweb2/modules/director
    Name: run
    PrependShell: true
  - CmdLine:
    - /usr/share/icingaweb2/bin/icingacli setup config webserver apache --document-root
      /usr/share/icingaweb2/public > /etc/apache2/conf-available/icingaweb2.conf   &&
      a2enconf icingaweb2   && echo "RedirectMatch ^/$ /icingaweb2/" >> /etc/apache2/apache2.conf
    Name: run
    PrependShell: true
  - CmdLine:
    - curl -L -o /usr/local/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.5/jq-linux64    &&
      chmod +x /usr/local/bin/jq
    Name: run
    PrependShell: true
  - CmdLine:
    - mkdir -p /var/www/.ssh   && chown www-data:www-data /var/www/.ssh   && sudo
      -u www-data ssh-keygen -t rsa -N "" -f /var/www/.ssh/id_rsa
    Name: run
    PrependShell: true
  - Chown: ""
    Name: add
    SourcesAndDest:
    - content/tmp/DbConnection.php.patch
    - /tmp/DbConnection.php.patch
  - Chown: ""
    Name: add
    SourcesAndDest:
    - content/usr
    - /usr
  - Chown: ""
    Name: add
    SourcesAndDest:
    - content/run.sh
    - /run.sh
  - CmdLine:
    - chmod +x /run.sh
    Name: run
    PrependShell: true
  - Name: volume
    Volumes:
    - /etc/icingaweb2
  - Name: expose
    Ports:
    - "443"
    - "80"
  - CmdLine:
    - /run.sh
    Name: cmd
    PrependShell: false
  From:
    Image: php:7.0-apache
  Name: ""
  Platform: ""
  SourceCode: FROM php:7.0-apache
