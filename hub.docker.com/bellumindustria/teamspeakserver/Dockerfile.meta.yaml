MetaArgs: null
Stages:
- BaseName: bellumindustria/linuxgsmserver:release-1.0.1
  Commands:
  - Maintainer: Antoine Benevaut <antoine@bellum-industria.fr>
    Name: maintainer
  - Key: TS3_MACHINE_ID
    Name: arg
    Value: "1"
  - Key: TS3_LICENSEPATH
    Name: arg
    Value: '""'
  - Key: TS3_VOICE_PORT
    Name: arg
    Value: "9987"
  - Key: TS3_VOICE_IP
    Name: arg
    Value: '"0.0.0.0, ::"'
  - Key: TS3_QUERY_PORT
    Name: arg
    Value: "10011"
  - Key: TS3_QUERY_IP
    Name: arg
    Value: '"0.0.0.0, ::"'
  - Key: TS3_FILE_TRANSFERS_PORT
    Name: arg
    Value: "30033"
  - Key: TS3_FILE_TRANSFERS_IP
    Name: arg
    Value: '"0.0.0.0, ::"'
  - Key: TS3_QUERY_IP_WITHELIST
    Name: arg
    Value: '"query_ip_whitelist.txt"'
  - Key: TS3_QUERY_IP_BLACKLIST
    Name: arg
    Value: '"query_ip_blacklist.txt"'
  - Key: TS3_DB_PLUGIN
    Name: arg
    Value: '"ts3db_mariadb"'
  - Key: TS3_DB_PLUGIN_PARAMETER
    Name: arg
    Value: '"ts3db_mariadb.ini"'
  - Key: TS3_DB_SQL_PATH
    Name: arg
    Value: '"sql/"'
  - Key: TS3_DB_SQL_CREATE_PATH
    Name: arg
    Value: '"create_mariadb/"'
  - Key: TS3_DB_CONNECTIONS
    Name: arg
    Value: "10"
  - Key: TS3_LOG_PATH
    Name: arg
    Value: logs
  - Key: TS3_LOG_QUERY_COMMANDS
    Name: arg
    Value: "0"
  - Key: TS3_DB_CLIENT_KEEP_DAYS
    Name: arg
    Value: "30"
  - Key: TS3_LOG_APPEND
    Name: arg
    Value: "0"
  - Key: TS3_QUERY_SKIP_BRUTE_FORCE_CHECK
    Name: arg
    Value: "0"
  - Key: TS3_UPDATE_ON_START
    Name: arg
    Value: "on"
  - Key: TS3_EMAIL_ALERT
    Name: arg
    Value: "on"
  - Key: TS3_EMAIL
    Name: arg
    Value: '"contact@bellum-industria.fr"'
  - Key: TS3_EMAIL_FROM
    Name: arg
    Value: '""'
  - Key: TS3_PUSHBULLET_ALERT
    Name: arg
    Value: '""'
  - Key: TS3_PUSHBULLET_TOKEN
    Name: arg
    Value: '""'
  - Key: TS3_PUSHBULLET_CHANNEL_TAG
    Name: arg
    Value: '""'
  - Key: TS3_MYSQL_HOST
    Name: arg
    Value: mysql
  - Key: TS3_MYSQL_PORT
    Name: arg
    Value: "3306"
  - Key: TS3_MYSQL_DB
    Name: arg
    Value: default
  - Key: TS3_MYSQL_USER
    Name: arg
    Value: default
  - Key: TS3_MYSQL_PASS
    Name: arg
    Value: secret
  - Key: TS3_MYSQL_SOCKET
    Name: arg
    Value: '""'
  - Env:
    - Key: TS3_MACHINE_ID
      Value: ${TS3_MACHINE_ID}
    Name: env
  - Env:
    - Key: TS3_LICENSEPATH
      Value: ${TS3_LICENSEPATH}
    Name: env
  - Env:
    - Key: TS3_VOICE_PORT
      Value: ${TS3_VOICE_PORT}
    Name: env
  - Env:
    - Key: TS3_VOICE_IP
      Value: ${TS3_VOICE_IP}
    Name: env
  - Env:
    - Key: TS3_QUERY_PORT
      Value: ${TS3_QUERY_PORT}
    Name: env
  - Env:
    - Key: TS3_QUERY_IP
      Value: ${TS3_QUERY_IP}
    Name: env
  - Env:
    - Key: TS3_FILE_TRANSFERS_PORT
      Value: ${TS3_FILE_TRANSFERS_PORT}
    Name: env
  - Env:
    - Key: TS3_FILE_TRANSFERS_IP
      Value: ${TS3_FILE_TRANSFERS_IP}
    Name: env
  - Env:
    - Key: TS3_QUERY_IP_WITHELIST
      Value: ${TS3_QUERY_IP_WITHELIST}
    Name: env
  - Env:
    - Key: TS3_QUERY_IP_BLACKLIST
      Value: ${TS3_QUERY_IP_BLACKLIST}
    Name: env
  - Env:
    - Key: TS3_DB_PLUGIN
      Value: ${TS3_DB_PLUGIN}
    Name: env
  - Env:
    - Key: TS3_DB_PLUGIN_PARAMETER
      Value: ${TS3_DB_PLUGIN_PARAMETER}
    Name: env
  - Env:
    - Key: TS3_DB_SQL_PATH
      Value: ${TS3_DB_SQL_PATH}
    Name: env
  - Env:
    - Key: TS3_DB_SQL_CREATE_PATH
      Value: ${TS3_DB_SQL_CREATE_PATH}
    Name: env
  - Env:
    - Key: TS3_DB_CONNECTIONS
      Value: ${TS3_DB_CONNECTIONS}
    Name: env
  - Env:
    - Key: TS3_LOG_PATH
      Value: ${TS3_LOG_PATH}
    Name: env
  - Env:
    - Key: TS3_LOG_QUERY_COMMANDS
      Value: ${TS3_LOG_QUERY_COMMANDS}
    Name: env
  - Env:
    - Key: TS3_DB_CLIENT_KEEP_DAYS
      Value: ${TS3_DB_CLIENT_KEEP_DAYS}
    Name: env
  - Env:
    - Key: TS3_LOG_APPEND
      Value: ${TS3_LOG_APPEND}
    Name: env
  - Env:
    - Key: TS3_QUERY_SKIP_BRUTE_FORCE_CHECK
      Value: ${TS3_QUERY_SKIP_BRUTE_FORCE_CHECK}
    Name: env
  - Env:
    - Key: TS3_UPDATE_ON_START
      Value: ${TS3_UPDATE_ON_START}
    Name: env
  - Env:
    - Key: TS3_EMAIL_ALERT
      Value: ${TS3_EMAIL_ALERT}
    Name: env
  - Env:
    - Key: TS3_EMAIL
      Value: ${TS3_EMAIL}
    Name: env
  - Env:
    - Key: TS3_EMAIL_FROM
      Value: ${TS3_EMAIL_FROM}
    Name: env
  - Env:
    - Key: TS3_PUSHBULLET_ALERT
      Value: ${TS3_PUSHBULLET_ALERT}
    Name: env
  - Env:
    - Key: TS3_PUSHBULLET_TOKEN
      Value: ${TS3_PUSHBULLET_TOKEN}
    Name: env
  - Env:
    - Key: TS3_PUSHBULLET_CHANNEL_TAG
      Value: ${TS3_PUSHBULLET_CHANNEL_TAG}
    Name: env
  - Env:
    - Key: TS3_MYSQL_HOST
      Value: ${TS3_MYSQL_HOST}
    Name: env
  - Env:
    - Key: TS3_MYSQL_PORT
      Value: ${TS3_MYSQL_PORT}
    Name: env
  - Env:
    - Key: TS3_MYSQL_DB
      Value: ${TS3_MYSQL_DB}
    Name: env
  - Env:
    - Key: TS3_MYSQL_USER
      Value: ${TS3_MYSQL_USER}
    Name: env
  - Env:
    - Key: TS3_MYSQL_PASS
      Value: ${TS3_MYSQL_PASS}
    Name: env
  - Env:
    - Key: TS3_MYSQL_SOCKET
      Value: ${TS3_MYSQL_SOCKET}
    Name: env
  - Name: expose
    Ports:
    - $TS3_VOICE_PORT/udp
  - Name: expose
    Ports:
    - $TS3_QUERY_PORT
  - Name: expose
    Ports:
    - $TS3_FILE_TRANSFERS_PORT
  - CmdLine:
    - "groupadd -r ts3server && \tuseradd -rm -g ts3server ts3server && \tadduser
      ts3server sudo && \techo \"ts3server ALL=(ALL) NOPASSWD:ALL\" >> /etc/sudoers"
    Name: run
    PrependShell: true
  - Chown: ""
    Name: add
    SourcesAndDest:
    - ts3db_mariadb.ini
    - /home/ts3server/serverfiles/ts3db_mariadb.ini
  - CmdLine:
    - chown -R ts3server:ts3server /home/ts3server
    Name: run
    PrependShell: true
  - Name: user
    User: ts3server
  - Name: workdir
    Path: /home/ts3server
  - CmdLine:
    - wget https://raw.githubusercontent.com/GameServerManagers/LinuxGSM/170501/TeamSpeak3/ts3server
      &&     chmod +x ts3server
    Name: run
    PrependShell: true
  - CmdLine:
    - sed -i '/emailalert=/s/"\([^"]*\)"/"$TS3_EMAIL_ALERT"/' ts3server &&     sed
      -i '/email=/s/"\([^"]*\)"/"$TS3_EMAIL"/' ts3server &&     sed -i '/emailfrom=/s/"\([^"]*\)"/"$TS3_EMAIL_FROM"/'
      ts3server &&     sed -i '/pushbulletalert=/s/"\([^"]*\)"/"$TS3_PUSHBULLET_ALERT"/'
      ts3server &&     sed -i '/pushbullettoken=/s/"\([^"]*\)"/"$TS3_PUSHBULLET_TOKEN"/'
      ts3server &&     sed -i '/channeltag=/s/"\([^"]*\)"/"$TS3_PUSHBULLET_CHANNEL_TAG"/'
      ts3server &&     sed -i '/updateonstart=/s/"\([^"]*\)"/"$TS3_UPDATE_ON_START"/'
      ts3server
    Name: run
    PrependShell: true
  - CmdLine:
    - ./ts3server auto-install
    Name: run
    PrependShell: true
  - CmdLine:
    - mkdir -p /home/ts3server/serverfiles &&     mkdir -p /home/ts3server/backups
      &&     mkdir -p /home/ts3server/log &&     chown -R ts3server:ts3server /home/ts3server
    Name: run
    PrependShell: true
  - Name: volume
    Volumes:
    - /home/ts3server/serverfiles/files
    - /home/ts3server/log
    - /home/ts3server/backups
  - CmdLine:
    - echo "machine_id=${TS3_MACHINE_ID}" > serverfiles/ts3-server.ini &&     echo
      "default_voice_port=${TS3_VOICE_PORT}" >> serverfiles/ts3-server.ini &&     echo
      "voice_ip=${TS3_VOICE_IP}" >> serverfiles/ts3-server.ini &&     echo "licensepath=${TS3_LICENSEPATH}"
      >> serverfiles/ts3-server.ini &&     echo "filetransfer_port=${TS3_FILE_TRANSFERS_PORT}"
      >> serverfiles/ts3-server.ini &&     echo "filetransfer_ip=${TS3_FILE_TRANSFERS_IP}"
      >> serverfiles/ts3-server.ini &&     echo "query_port=${TS3_QUERY_PORT}" >>
      serverfiles/ts3-server.ini &&     echo "query_ip=${TS3_QUERY_IP}" >> serverfiles/ts3-server.ini
      &&     echo "query_ip_whitelist=${TS3_QUERY_IP_WITHELIST}" >> serverfiles/ts3-server.ini
      &&     echo "query_ip_blacklist=${TS3_QUERY_IP_BLACKLIST}" >> serverfiles/ts3-server.ini
      &&     echo "dbplugin=${TS3_DB_PLUGIN}" >> serverfiles/ts3-server.ini &&     echo
      "dbpluginparameter=${TS3_DB_PLUGIN_PARAMETER}" >> serverfiles/ts3-server.ini
      &&     echo "dbsqlpath=${TS3_DB_SQL_PATH}" >> serverfiles/ts3-server.ini &&     echo
      "dbsqlcreatepath=${TS3_DB_SQL_CREATE_PATH}" >> serverfiles/ts3-server.ini &&     echo
      "dbconnections=${TS3_DB_CONNECTIONS}" >> serverfiles/ts3-server.ini &&     echo
      "logpath=${TS3_LOG_PATH}" >> serverfiles/ts3-server.ini &&     echo "logquerycommands=${TS3_LOG_QUERY_COMMANDS}"
      >> serverfiles/ts3-server.ini &&     echo "dbclientkeepdays=${TS3_DB_CLIENT_KEEP_DAYS}"
      >> serverfiles/ts3-server.ini &&     echo "logappend=${TS3_LOG_APPEND}" >> serverfiles/ts3-server.ini
      &&     echo "query_skipbruteforcecheck=${TS3_QUERY_SKIP_BRUTE_FORCE_CHECK}"
      >> serverfiles/ts3-server.ini
    Name: run
    PrependShell: true
  - CmdLine:
    - echo '[config]' > serverfiles/ts3db_mariadb.ini &&     echo "host=${TS3_MYSQL_HOST}"
      >> serverfiles/ts3db_mariadb.ini &&     echo "port=${TS3_MYSQL_PORT}" >> serverfiles/ts3db_mariadb.ini
      &&     echo "username=${TS3_MYSQL_USER}" >> serverfiles/ts3db_mariadb.ini &&     echo
      "password=${TS3_MYSQL_PASS}" >> serverfiles/ts3db_mariadb.ini &&     echo "database=${TS3_MYSQL_DB}"
      >> serverfiles/ts3db_mariadb.ini &&     echo "socket=${TS3_MYSQL_SOCKET}" >>
      serverfiles/ts3db_mariadb.ini
    Name: run
    PrependShell: true
  - CmdLine:
    - echo '#!/bin/sh' > start.sh &&     echo '' >> start.sh &&     echo '# Docker
      Start / Run Script' > start.sh &&     echo '' >> start.sh &&     echo 'server_file="/home/ts3server/serverfiles/ts3server_minimal_runscript.sh"'
      >> start.sh &&     echo 'if [ -f "$server_file" ]' >> start.sh &&     echo 'then'
      >> start.sh &&     echo 'exec /home/ts3server/serverfiles/ts3server_minimal_runscript.sh
      inifile=ts3-server.ini' >> start.sh &&     echo 'else' >> start.sh &&     echo
      './ts3server auto-install' >> start.sh &&     echo 'exec /home/ts3server/serverfiles/ts3server_minimal_runscript.sh
      inifile=ts3-server.ini' >> start.sh &&     echo 'fi' >> start.sh &&     chmod
      +x start.sh
    Name: run
    PrependShell: true
  - CmdLine:
    - bash -c 'exec /home/ts3server/start.sh';
    Name: cmd
    PrependShell: true
  From:
    Image: bellumindustria/linuxgsmserver:release-1.0.1
  Name: ""
  Platform: ""
  SourceCode: FROM bellumindustria/linuxgsmserver:release-1.0.1
