FROM registry.fedoraproject.org/fedora:27

ENV LANG C.UTF-8

RUN dnf -y update

RUN dnf -y install git \
                   make \
                   gcc-c++ \
                   which \
                   doxygen \
                   systemd-devel \
                   graphviz \
                   rpm-build \
                   redhat-rpm-config \
                   python3 \
                   python3-devel \
                   python3-virtualenv \
                   python2-virtualenv \
                   libyaml-devel \
                   openssl-devel \
                   libffi-devel \
                   postgresql-devel \
                   libjpeg-turbo-devel \
                   libpng-devel \
                   lcms-devel \
                   freetype-devel \
                   libtiff-devel \
                   libwebp-devel \
                   nmap \
                   lirc-devel \
                   autoconf

RUN git clone https://github.com/ryanwinter/open-zwave.git /opt/open-zwave
RUN cd /opt/open-zwave && (curl https://src.fedoraproject.org/rpms/openzwave/raw/fb7d98a5c6858feb28f0f32e918dda1b62bea2a4/f/openzwave-1.5.0-format.patch | patch -p1)
RUN cd /opt/open-zwave && LDFLAGS="`rpmbuild --eval %{__global_ldflags}`" CPPFLAGS="`rpmbuild --eval %{optflags}` -Wformat" make

RUN virtualenv --python=python3.6 /opt/homeassistant

RUN /opt/homeassistant/bin/pip install --no-binary ":all:" Cython
RUN /opt/homeassistant/bin/pip install --no-binary ":all:" six
RUN /opt/homeassistant/bin/pip install --no-binary ":all:" "PyDispatcher>=2.0.5"

RUN LOCAL_OPENZWAVE=/opt/open-zwave /opt/homeassistant/bin/pip install --no-binary ":all:" "python_openzwave==0.4.3" --install-option="--flavor=dev"

RUN /opt/homeassistant/bin/pip install  \
                                       "git+https://github.com/home-assistant/home-assistant.git@0.66.0" \
                                       "requests==2.18.4" \
                                       "pyyaml>=3.11,<4" \
                                       "pytz>2017.02" \
                                       "pip>=8.0.3" \
                                       "jinja2>=2.10" \
                                       "voluptuous==0.11.1" \
                                       "typing>=3,<4" \
                                       "aiohttp==3.0.9" \
                                       "async_timeout==2.0.1" \
                                       "astral==1.6" \
                                       "certifi>=2017.4.17" \
                                       "attrs==17.4.0" \
                                       "DoorBirdPy==0.1.3" \
                                       "HAP-python==1.1.7" \
                                       "PyISY==1.1.0" \
                                       "PyJWT==1.6.0" \
                                       "PyMVGLive==1.1.4" \
                                       "PyMata==2.14" \
                                       "PyXiaomiGateway==0.8.3" \
                                       "RtmAPI==0.7.0" \
                                       "SoCo==0.14" \
                                       "TravisPy==0.3.5" \
                                       "TwitterAPI==2.5.0" \
                                       "YesssSMS==0.1.1b3" \
                                       "abodepy==0.12.2" \
                                       "afsapi==0.0.3" \
                                       "aioautomatic==0.6.5" \
                                       "aiodns==1.1.1" \
                                       "aiohttp-cors==0.7.0" \
                                       "aiohue==1.3.0" \
                                       "aioimaplib==0.7.13" \
                                       "aiolifx==0.6.1" \
                                       "aiolifx_effects==0.1.2" \
                                       "aiopvapi==1.5.4" \
                                       "alarmdecoder==1.13.2" \
                                       "alpha_vantage==1.9.0" \
                                       "amcrest==1.2.1" \
                                       "anthemav==1.1.8" \
                                       "apcaccess==0.0.13" \
                                       "apns2==0.3.0" \
                                       "asterisk_mbox==0.4.0" \
                                       "axis==14" \
                                       "baidu-aip==1.6.6" \
                                       "beautifulsoup4==4.6.0" \
                                       "bellows==0.5.1" \
                                       "bimmer_connected==0.4.1" \
                                       "blinkpy==0.6.0" \
                                       "blinkstick==1.1.8" \
                                       "blockchain==1.4.0" \
                                       "boto3==1.4.7" \
                                       "botocore==1.7.34" \
                                       "buienradar==0.91" \
                                       "caldav==0.5.0" \
                                       "ciscosparkapi==0.4.2" \
                                       "coinbase==2.1.0" \
                                       "coinmarketcap==4.2.1" \
                                       "colorlog==3.1.2" \
                                       "concord232==0.15" \
                                       "construct==2.9.41" \
                                       "crimereports==1.0.0" \
                                       "datadog==0.15.0" \
                                       "datapoint==0.4.3" \
                                       "defusedxml==0.5.0" \
                                       "deluge-client==1.0.5" \
                                       "denonavr==0.6.1" \
                                       "directpy==0.2" \
                                       "discogs_client==2.2.1" \
                                       "discord.py==0.16.12" \
                                       "distro==1.2.0" \
                                       "dlipower==0.7.165" \
                                       "dnspython3==1.15.0" \
                                       "dovado==0.4.1" \
                                       "dsmr_parser==0.11" \
                                       "dweepy==0.3.0" \
                                       "eliqonline==1.0.13" \
                                       "enocean==0.40" \
                                       "ephem==3.7.6.0" \
                                       "evohomeclient==0.2.5" \
                                       "fastdotcom==0.0.3" \
                                       "fedexdeliverymanager==1.0.6" \
                                       "feedparser==5.2.1" \
                                       "fitbit==0.3.0" \
                                       "fixerio==0.1.1" \
                                       "flux_led==0.21" \
                                       "foobot_async==0.3.0" \
                                       "freesms==0.1.2" \
                                       "fritzhome==1.0.4" \
                                       "gTTS-token==1.1.1" \
                                       "gearbest_parser" \
                                       "gitterpy==0.1.6" \
                                       "gntp==1.0.3" \
                                       "google-api-python-client==1.6.4" \
                                       "googlemaps==2.5.1" \
                                       "gps3==0.33.3" \
                                       "greenwavereality==0.5.1" \
                                       "gstreamer-player==1.1.0" \
                                       "ha-ffmpeg==1.9" \
                                       "ha-philipsjs==0.0.2" \
                                       "haversine==0.4.5" \
                                       "heatmiserV3==0.9.1" \
                                       "hikvision==0.4" \
                                       "hipnotify==1.0.8" \
                                       "holidays==0.9.4" \
                                       "home-assistant-frontend==20180330.0" \
                                       "homematicip==0.8" \
                                       "http://github.com/tgaugry/suds-passworddigest-py3/archive/86fc50e39b4d2b8997481967d6a7fe1c57118999.zip#suds-passworddigest-py3==0.1.2a" \
                                       "httplib2==0.10.3" \
                                       "https://github.com/aparraga/braviarc/archive/0.3.7.zip#braviarc==0.3.7" \
                                       "https://github.com/balloob/python-broadlink/archive/3580ff2eaccd267846f14246d6ede6e30671f7c6.zip#broadlink==0.5.1" \
                                       "https://github.com/happyleavesaoc/spotipy/archive/544614f4b1d508201d363e84e871f86c90aa26b2.zip#spotipy==2.4.4" \
                                       "https://github.com/jabesq/netatmo-api-python/archive/v0.9.2.1.zip#lnetatmo==0.9.2.1" \
                                       "https://github.com/jabesq/pybotvac/archive/v0.0.5.zip#pybotvac==0.0.5" \
                                       "https://github.com/mweinelt/anel-pwrctrl/archive/ed26e8830e28a2bfa4260a9002db23ce3e7e63d7.zip#anel_pwrctrl==0.0.1" \
                                       "https://github.com/robbiet480/pygtfs/archive/00546724e4bbcb3053110d844ca44e2246267dd8.zip#pygtfs==0.1.3" \
                                       "https://github.com/soldag/pyflic/archive/0.4.zip#pyflic==0.4" \
                                       "https://github.com/wokar/pylgnetcast/archive/v0.2.0.zip#pylgnetcast==0.2.0" \
                                       "iglo==1.2.7" \
                                       "ihcsdk==2.2.0" \
                                       "influxdb==5.0.0" \
                                       "insteonlocal==0.53" \
                                       "insteonplm==0.8.3" \
                                       "jsonpath==0.75" \
                                       "jsonrpc-async==0.6" \
                                       "jsonrpc-websocket==0.6" \
                                       "keyring==11.0.0" \
                                       "keyrings.alt==2.3" \
                                       "libnacl==1.6.1" \
                                       "libpurecoollink==0.4.2" \
                                       "libpyfoscam==1.0" \
                                       "librouteros==1.0.5" \
                                       "libsoundtouch==0.7.2" \
                                       "liffylights==0.9.4" \
                                       "lightify==1.0.6.1" \
                                       "limitlessled==1.1.0" \
                                       "linode-api==4.1.4b2" \
                                       "liveboxplaytv==2.0.2" \
                                       "lmnotify==0.0.4" \
                                       "luftdaten==0.1.3" \
                                       "lyft_rides==0.2" \
                                       "matrix-client==0.0.6" \
                                       "maxcube-api==0.1.0" \
                                       "mercedesmejsonpy==0.1.2" \
                                       "messagebird==1.2.0" \
                                       "mficlient==0.3.0" \
                                       "miflora==0.3.0" \
                                       "miniupnpc==2.0.2" \
                                       "motorparts==1.0.2" \
                                       "mutagen==1.40.0" \
                                       "mychevy==0.1.1" \
                                       "mycroftapi==2.0" \
                                       "myusps==1.3.2" \
                                       "nad_receiver==0.0.9" \
                                       "netdisco==1.3.0" \
                                       "networkx" \
                                       "neurio==0.3.1" \
                                       "nsapi==2.7.4" \
                                       "nuheat==0.3.0" \
                                       "numpy==1.14.2" \
                                       "oauth2client==4.0.0" \
                                       "oemthermostat==1.1" \
                                       "onkyo-eiscp==1.2.4" \
                                       "onvif-py3==0.1.3" \
                                       "openevsewifi==0.4" \
                                       "openhomedevice==0.4.2" \
                                       "orvibo==1.1.1" \
                                       "paho-mqtt==1.3.1" \
                                       "panasonic_viera==0.3.1" \
                                       "pdunehd==1.3" \
                                       "pexpect==4.0.1" \
                                       "pexpect==4.0.1" \
                                       "pifacecommon==4.1.2" \
                                       "pifacedigitalio==3.0.5" \
                                       "piglow==1.2.4" \
                                       "pilight==0.1.1" \
                                       "pillow==5.0.0" \
                                       "pizzapi==0.0.3" \
                                       "plexapi==3.0.6" \
                                       "pmsensor==0.4" \
                                       "pocketcasts==0.1" \
                                       "proliphix==0.4.1" \
                                       "prometheus-client==0.1.0" \
                                       psycopg2 \
                                       "psutil==5.4.3" \
                                       "pubnubsub-handler==1.0.2" \
                                       "pushbullet.py==0.11.0" \
                                       "pushetta==1.0.15" \
                                       "pwmled==1.2.1" \
                                       "py-august==0.4.0" \
                                       "py-canary==0.4.1" \
                                       "py-cpuinfo==3.3.0" \
                                       "py-melissa-climate==1.0.6" \
                                       "py-synology==0.2.0" \
                                       "pyCEC==0.4.13" \
                                       "pyHS100==0.3.0" \
                                       "pyRFXtrx==0.21.1" \
                                       "pyTibber==0.4.0" \
                                       "pyW215==0.6.0" \
                                       "pyads==2.2.6" \
                                       "pyairvisual==1.0.0" \
                                       "pyalarmdotcom==0.3.1" \
                                       "pyarlo==0.1.2" \
                                       "pyasn1-modules==0.1.5" \
                                       "pyasn1==0.3.7" \
                                       "pyatv==0.3.9" \
                                       "pybbox==0.0.5-alpha" \
                                       "pychannels==1.0.0" \
                                       "pychromecast==2.1.0" \
                                       "pycmus==0.1.0" \
                                       "pycomfoconnect==0.3" \
                                       "pycsspeechtts==1.0.2" \
                                       "pydaikin==0.4" \
                                       "pydeconz==32" \
                                       "pydroid-ipcam==0.8" \
                                       "pyebox==0.1.0" \
                                       "pyeconet==0.0.5" \
                                       "pyedimax==0.1" \
                                       "pyeight==0.0.7" \
                                       "pyemby==1.5" \
                                       "pyenvisalink==2.2" \
                                       "pyephember==0.1.1" \
                                       "pyfido==2.1.0" \
                                       "pyflexit==0.3" \
                                       "pyfttt==0.3" \
                                       "pyharmony==1.0.20" \
                                       "pyhik==0.1.8" \
                                       "pyhiveapi==0.2.11" \
                                       "pyhomematic==0.1.40" \
                                       "pyhydroquebec==2.1.0" \
                                       "pyialarm==0.2" \
                                       "pyicloud==0.9.1" \
                                       "pyirishrail==0.0.2" \
                                       "pyiss==1.0.1" \
                                       "pyitachip2ir==0.0.7" \
                                       "pykira==0.1.1" \
                                       "pykwb==0.0.8" \
                                       "pylacrosse==0.3.1" \
                                       "pylast==2.1.0" \
                                       "pylgtv==0.1.7" \
                                       "pylitejet==0.1" \
                                       "pyloopenergy==0.0.18" \
                                       "pylutron-caseta==0.3.0" \
                                       "pylutron==0.1.0" \
                                       "pymailgunner==1.4" \
                                       "pymediaroom==0.6" \
                                       "pymitv==1.0.0" \
                                       "pymochad==0.2.0" \
                                       "pymodbus==1.3.1" \
                                       "pymonoprice==0.3" \
                                       "pymusiccast==0.1.6" \
                                       "pymyq==0.0.8" \
                                       "pymysensors==0.11.1" \
                                       "pynello==1.5.1" \
                                       "pynetgear==0.3.3" \
                                       "pynetio==0.1.6" \
                                       "pynuki==1.3.1" \
                                       "pynut2==2.1.2" \
                                       "pynx584==0.4" \
                                       "pyota==2.0.4" \
                                       "pyotp==2.2.6" \
                                       "pyowm==2.8.0" \
                                       "pypollencom==1.1.1" \
                                       "pyqwikswitch==0.4" \
                                       "pyrainbird==0.1.3" \
                                       "pysabnzbd==1.0.1" \
                                       "pysensibo==1.0.2" \
                                       "pyserial-asyncio==0.4" \
                                       "pyserial==3.1.1" \
                                       "pysesame==0.1.0" \
                                       "pysher==0.2.0" \
                                       "pysma==0.2" \
                                       "pysnmp==4.4.4" \
                                       "pystride==0.1.7" \
                                       "pysyncthru==0.3.1" \
                                       "pyteleloisirs==3.3" \
                                       "pythinkingcleaner==0.0.3" \
                                       "python-blockchain-api==0.0.2" \
                                       "python-clementine-remote==1.0.1" \
                                       "python-digitalocean==1.13.2" \
                                       "python-ecobee-api==0.0.17" \
                                       "python-etherscan-api==0.0.3" \
                                       "python-forecastio==1.4.0" \
                                       "python-gc100==1.0.3a" \
                                       "python-hpilo==3.9" \
                                       "python-join-api==0.0.2" \
                                       "python-juicenet==0.0.5" \
                                       "python-lirc==1.2.3" \
                                       "python-miio==0.3.9" \
                                       "python-mpd2==0.5.5" \
                                       "python-mystrom==0.3.8" \
                                       "python-nest==3.7.0" \
                                       "python-nmap==0.6.1" \
                                       "python-pushover==0.3" \
                                       "python-ripple-api==0.0.3" \
                                       "python-roku==3.1.5" \
                                       "python-sochain-api==0.0.2" \
                                       "python-songpal==0.0.6" \
                                       "python-synology==0.1.0" \
                                       "python-tado==0.2.2" \
                                       "python-telegram-bot==10.0.1" \
                                       "python-twitch==1.3.0" \
                                       "python-velbus==2.0.11" \
                                       "python-vlc==1.1.2" \
                                       "python-wink==1.7.3" \
                                       "python_opendata_transport==0.0.3" \
                                       "pythonegardia==1.0.39" \
                                       "pythonwhois==2.4.3" \
                                       "pytile==1.1.0" \
                                       "pytouchline==0.7" \
                                       "pytrackr==0.0.5" \
                                       "pytradfri[async]==4.1.0" \
                                       "pyunifi==2.13" \
                                       "pyvera==0.2.42" \
                                       "pyvesync==0.1.1" \
                                       "pyvizio==0.0.2" \
                                       "pyvlx==0.1.3" \
                                       "pywebpush==1.6.0" \
                                       "pywemo==0.4.25" \
                                       "pyxeoma==1.4.0" \
                                       "pyzabbix==0.7.4" \
                                       "qnapstats==0.2.4" \
                                       "rachiopy==0.1.2" \
                                       "radiotherm==1.3" \
                                       "raincloudy==0.0.4" \
                                       "regenmaschine==0.4.1" \
                                       "restrictedpython==4.0b2" \
                                       "rflink==0.0.34" \
                                       "ring_doorbell==0.1.8" \
                                       "rocketchat-API==0.6.1" \
                                       "roombapy==1.3.1" \
                                       "russound==0.1.9" \
                                       "russound_rio==0.1.4" \
                                       "rxv==0.5.1" \
                                       "samsungctl[websocket]==0.7.1" \
                                       "satel_integra==0.1.0" \
                                       "schiene==0.22" \
                                       "scsgate==0.1.0" \
                                       "sendgrid==5.3.0" \
                                       "sense-hat==2.2.0" \
                                       "sense_energy==0.3.1" \
                                       "sharp_aquos_rc==0.3.2" \
                                       "shodan==1.7.7" \
                                       "simplepush==1.1.4" \
                                       "simplisafe-python==1.0.5" \
                                       "skybellpy==0.1.1" \
                                       "slacker==0.9.60" \
                                       "sleekxmpp==1.3.2" \
                                       "sleepyq==0.6" \
                                       "smappy==0.2.15" \
                                       "snapcast==2.0.8" \
                                       "somecomfort==0.5.0" \
                                       "speedtest-cli==2.0.0" \
                                       "spotcrime==1.0.3" \
                                       "sqlalchemy==1.2.5" \
                                       "statsd==3.2.1" \
                                       "steamodd==4.21" \
                                       "suds-py3==1.3.3.0" \
                                       "tahoma-api==0.0.13" \
                                       "tank_utility==1.4.0" \
                                       "tapsaff==0.1.3" \
                                       "tellcore-net==0.4" \
                                       "tellcore-py==1.1.2" \
                                       "temperusb==1.5.3" \
                                       "teslajsonpy==0.0.23" \
                                       "thingspeak==0.4.1" \
                                       "tikteck==0.4" \
                                       "todoist-python==7.0.17" \
                                       "toonlib==1.0.2" \
                                       "total_connect_client==0.16" \
                                       "transmissionrpc==0.11"