MetaArgs: null
Stages:
- BaseName: php:apache
  Commands:
  - Labels:
    - Key: maintainer
      Value: '"Mathieu.Mangeot@imag.fr"'
    Name: label
  - Key: DICTIONNAIRES_SITE
    Name: arg
    Value: '"/var/www/html/Dicos"'
  - Key: DICTIONNAIRES_SITE_DAV
    Name: arg
    Value: '"/var/www/html/DAV"'
  - Key: DICTIONNAIRES_DAV
    Name: arg
    Value: '"/DAV/Dicos"'
  - Key: DICTIONNAIRES_WEB
    Name: arg
    Value: '"/Dicos"'
  - Key: DICTIONNAIRES_SITE_PUBLIC
    Name: arg
    Value: '"/var/www/html/DicosPublic"'
  - Key: DICTIONNAIRES_WEB_PUBLIC
    Name: arg
    Value: '"/DicosPublic"'
  - Key: ADMIN_USER
    Name: arg
    Value: '"ipolex"'
  - Key: ADMIN_PASSWORD
    Name: arg
    Value: '"19013x"'
  - Key: DEFAULT_TEST_USER
    Name: arg
    Value: $ADMIN_USER
  - Env:
    - Key: DICTIONNAIRES_SITE
      Value: $DICTIONNAIRES_SITE
    Name: env
  - Env:
    - Key: DICTIONNAIRES_SITE_DAV
      Value: $DICTIONNAIRES_SITE_DAV
    Name: env
  - Env:
    - Key: DICTIONNAIRES_DAV
      Value: $DICTIONNAIRES_DAV
    Name: env
  - Env:
    - Key: DICTIONNAIRES_WEB
      Value: $DICTIONNAIRES_WEB
    Name: env
  - Env:
    - Key: DICTIONNAIRES_SITE_PUBLIC
      Value: $DICTIONNAIRES_SITE_PUBLIC
    Name: env
  - Env:
    - Key: DICTIONNAIRES_WEB_PUBLIC
      Value: $DICTIONNAIRES_WEB_PUBLIC
    Name: env
  - Env:
    - Key: ADMIN_USER
      Value: $ADMIN_USER
    Name: env
  - Env:
    - Key: ADMIN_PASSWORD
      Value: $ADMIN_PASSWORD
    Name: env
  - Env:
    - Key: DEFAULT_TEST_USER
      Value: $DEFAULT_TEST_USER
    Name: env
  - Name: workdir
    Path: $DICTIONNAIRES_SITE
  - Name: workdir
    Path: $DICTIONNAIRES_SITE_DAV
  - Name: workdir
    Path: $DICTIONNAIRES_SITE_PUBLIC
  - CmdLine:
    - ln -s $DICTIONNAIRES_SITE $DICTIONNAIRES_SITE_DAV
    Name: run
    PrependShell: true
  - CmdLine:
    - chown -R www-data:www-data $DICTIONNAIRES_SITE $DICTIONNAIRES_SITE_DAV $DICTIONNAIRES_SITE_PUBLIC
    Name: run
    PrependShell: true
  - CmdLine:
    - mkdir -p /usr/share/man/man1    && apt-get update && apt-get install -y libexpat1-dev       locales       openjdk-8-jre
    Name: run
    PrependShell: true
  - CmdLine:
    - echo 'fr_FR.UTF-8 UTF-8' >> /etc/locale.gen    && echo 'en_US.UTF-8 UTF-8' >>
      /etc/locale.gen    && locale-gen
    Name: run
    PrependShell: true
  - CmdLine:
    - sed -i "s#</VirtualHost>#<Directory "/var/www/html">\n    Options +Indexes +FollowSymLinks
      +MultiViews\n </Directory>\n <Directory \"$DICTIONNAIRES_SITE_DAV\">\n   DirectoryIndex
      none.none\n   DAV On\n   RemoveHandler .php\n   ForceType text/plain\n   php_flag
      engine off\n   AuthType Basic\n   AuthName \"iPolex WebDav Authentication\"\n   AuthBasicProvider
      file\n   AuthUserFile /etc/apache2/webdav.htpasswd\n   Require valid-user\n  </Directory>\n
      \n  </VirtualHost>#" /etc/apache2/sites-enabled/000-default.conf
    Name: run
    PrependShell: true
  - CmdLine:
    - htpasswd -cb /etc/apache2/webdav.htpasswd $ADMIN_USER $ADMIN_PASSWORD
    Name: run
    PrependShell: true
  - CmdLine:
    - /usr/sbin/a2enmod dav dav_fs dav_lock
    Name: run
    PrependShell: true
  - CmdLine:
    - cpan install XML::Parser XML::DOM::XPath
    Name: run
    PrependShell: true
  - CmdLine:
    - docker-php-ext-install gettext
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /var/www/html
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - .
    - .
  - CmdLine:
    - cp init.php.sample init.php
    Name: run
    PrependShell: true
  - CmdLine:
    - sed -i "s#\%DICTIONNAIRES_SITE\%#$DICTIONNAIRES_SITE#g" init.php    && sed -i
      "s#\%DICTIONNAIRES_DAV\%#$DICTIONNAIRES_DAV#g" init.php    && sed -i "s#\%DICTIONNAIRES_WEB\%#$DICTIONNAIRES_WEB#g"
      init.php    && sed -i "s#\%DICTIONNAIRES_SITE_PUBLIC\%#$DICTIONNAIRES_SITE_PUBLIC#g"
      init.php    && sed -i "s#\%DICTIONNAIRES_WEB_PUBLIC\%#$DICTIONNAIRES_WEB_PUBLIC#g"
      init.php    && sed -i "s#\%DEFAULT_TEST_USER\%#$DEFAULT_TEST_USER#g" init.php
    Name: run
    PrependShell: true
  From:
    Image: php:apache
  Name: ""
  Platform: ""
  SourceCode: FROM php:apache
