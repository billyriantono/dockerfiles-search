FROM alpine:3.8

# dont ask questions
ENV PERL_MM_USE_DEFAULT 1

RUN apk add --update && \
    apk add nginx wget unzip make zip perl-cgi perl-fcgi perl-cgi-session perl-error perl-json perl-file-copy-recursive

RUN perl -MCPAN -e 'install Crypt::PasswdMD5'

RUN wget --no-check-certificate https://github.com/foswiki/distro/releases/download/FoswikiRelease02x01x06/Foswiki-2.1.6.zip
RUN mkdir -p /var/www && \
    mv Foswiki-2.1.6.zip /var/www && \
    cd /var/www && \
    unzip Foswiki-2.1.6.zip -d /var/www/ && \
    mv Foswiki-2.1.6 foswiki && \
    rm -rf Foswiki-2.1.6.zip && \
    cd foswiki && \
    sh tools/fix_file_permissions.sh && \
    mkdir -p /run/nginx && \
    mkdir -p /etc/nginx/conf.d

COPY default.conf /etc/nginx/conf.d/default
COPY initialize.sh initialize.sh

EXPOSE 80

CMD [ "sh", "initialize.sh" ]