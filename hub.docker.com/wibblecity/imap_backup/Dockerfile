### base image
FROM ruby:2.5.3-alpine


### required input
ARG IMAP_SERVER
ARG USERNAME
ARG PASSWORD
ARG ACCOUNT_ID


### optional input
ARG IS_GMAIL
ENV IS_GMAIL=${IS_GMAIL:-false}

ARG BACKUPS_TO_KEEP
ENV BACKUPS_TO_KEEP=${BACKUPS_TO_KEEP:-1}

ARG CREATE_ARCHIVE
ENV CREATE_ARCHIVE=${CREATE_ARCHIVE:-false}

ARG ARCHIVES_TO_KEEP
ENV ARCHIVES_TO_KEEP=${ARCHIVES_TO_KEEP:-5}

ARG ENCRYPT_ARCHIVE
ENV ENCRYPT_ARCHIVE=${ENCRYPT_ARCHIVE:-false}

ARG ENCRYPTION_PASSWORD
ENV ENCRYPTION_PASSWORD=${ENCRYPTION_PASSWORD:-NO_PASSWORD_SET}


### environment variables
ENV CFG_FILE_DIR=/root/.imap-backup/
ENV CFG_FILE_NAME=config.json
ENV CFG_FILE_PATH=${CFG_FILE_DIR}/${CFG_FILE_NAME}
ENV GMAIL_CFG_FILE_DIR=/root/.imap-backup/
ENV GMAIL_CFG_FILE_NAME=gmail.config.json
ENV GMAIL_CFG_FILE_PATH=${GMAIL_CFG_FILE_DIR}/${GMAIL_CFG_FILE_NAME}
ENV ENTRYPOINT_FILE_DIR=/usr/bin
ENV ENTRYPOINT_FILE_NAME=entrypoint.sh
ENV ENTRYPOINT_FILE_PATH=${ENTRYPOINT_FILE_DIR}/${ENTRYPOINT_FILE_NAME}


### installing packages
RUN apk --update --no-cache add p7zip && rm -rf /var/cache/apk/* /tmp/*


### copying config files
COPY ${CFG_FILE_NAME} ${CFG_FILE_PATH}
COPY ${GMAIL_CFG_FILE_NAME} ${GMAIL_CFG_FILE_PATH}
COPY ${ENTRYPOINT_FILE_NAME} ${ENTRYPOINT_FILE_PATH}


### setting permissions
RUN chmod 600 ${CFG_FILE_PATH}
RUN chmod 600 ${GMAIL_CFG_FILE_PATH}
RUN chmod 700 ${ENTRYPOINT_FILE_PATH}


### entrypoint
CMD ${ENTRYPOINT_FILE_PATH}
