MetaArgs: null
Stages:
- BaseName: phusion/baseimage:latest
  Commands:
  - CmdLine:
    - ACCEPT_EULA=Y
    Name: run
    PrependShell: true
  - CmdLine:
    - DEBIAN_FRONTEND=noninteractive
    Name: run
    PrependShell: true
  - CmdLine:
    - locale-gen en_US.UTF-8
    Name: run
    PrependShell: true
  - Env:
    - Key: LANGUAGE
      Value: en_US.UTF-8
    Name: env
  - Env:
    - Key: LC_ALL
      Value: en_US.UTF-8
    Name: env
  - Env:
    - Key: LC_CTYPE
      Value: UTF-8
    Name: env
  - Env:
    - Key: LANG
      Value: en_US.UTF-8
    Name: env
  - Env:
    - Key: TERM
      Value: xterm
    Name: env
  - Env:
    - Key: php_conf
      Value: /etc/php/7.1/cli/php.ini
    Name: env
  - Env:
    - Key: fpm_conf
      Value: /etc/php/7.1/fpm/php-fpm.conf
    Name: env
  - Env:
    - Key: fpm_pool_conf
      Value: /etc/php/7.1/fpm/pool.d/www.conf
    Name: env
  - CmdLine:
    - apt-get update && apt-get install -y     software-properties-common
    Name: run
    PrependShell: true
  - CmdLine:
    - add-apt-repository -y     ppa:ondrej/php
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get update && apt-get install -y     libpcre3     openssh-client     nginx     curl     wget     git     nano     vim     dialog     php7.1     php7.1-bcmath     php7.1-cli     php7.1-common     php7.1-memcached     php7.1-fpm     php7.1-mysql     php7.1-pgsql     php7.1-sqlite     php7.1-sqlite3     php7.1-sybase     php7.1-mcrypt     php7.1-mbstring     php7.1-ctype     php7.1-zip     php7.1-gd     php7.1-exif     php7.1-intl     php7.1-xml     php7.1-xsl     php7.1-curl     php7.1-json     php7.1-iconv     php7.1-soap     php7.1-dev     libcurl4-openssl-dev     libedit-dev     libssl-dev     libsslcommon2-dev     libxml2-dev     xz-utils     sqlite3     libsqlite3-dev     autoconf     pkg-config     ca-certificates     freetds-common     freetds-bin     python-pip
    Name: run
    PrependShell: true
  - CmdLine:
    - pip install --upgrade supervisor supervisor-stdout
    Name: run
    PrependShell: true
  - Chown: ""
    Name: add
    SourcesAndDest:
    - conf/supervisor/*.conf
    - /etc/supervisor/
  - CmdLine:
    - curl https://packages.microsoft.com/keys/microsoft.asc | apt-key add -
    Name: run
    PrependShell: true
  - CmdLine:
    - curl https://packages.microsoft.com/config/ubuntu/16.04/prod.list > /etc/apt/sources.list.d/mssql-release.list
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get update
    Name: run
    PrependShell: true
  - CmdLine:
    - ACCEPT_EULA=Y DEBIAN_FRONTEND=noninteractive apt-get -y install     msodbcsql     mssql-tools     unixodbc-dev
    Name: run
    PrependShell: true
  - CmdLine:
    - pecl install sqlsrv-4.3.0
    Name: run
    PrependShell: true
  - CmdLine:
    - pecl install pdo_sqlsrv-4.3.0
    Name: run
    PrependShell: true
  - CmdLine:
    - echo "extension=sqlsrv.so" >> /etc/php/7.1/cli/php.ini
    Name: run
    PrependShell: true
  - CmdLine:
    - echo "extension=pdo_sqlsrv.so" >> /etc/php/7.1/cli/php.ini
    Name: run
    PrependShell: true
  - Chown: ""
    Name: add
    SourcesAndDest:
    - conf/freetds.conf
    - /etc/freetds/freetds.conf
  - Chown: ""
    Name: add
    SourcesAndDest:
    - conf/odbcinst.ini
    - /etc/odbcinst.ini
  - CmdLine:
    - pecl install mongodb-1.4.3
    Name: run
    PrependShell: true
  - CmdLine:
    - echo "extension=mongodb.so" >> /etc/php/7.1/fpm/conf.d/mongodb.ini
    Name: run
    PrependShell: true
  - CmdLine:
    - echo "extension=mongodb.so" >> /etc/php/7.1/cli/php.ini
    Name: run
    PrependShell: true
  - CmdLine:
    - cd /root/  && wget https://github.com/edenhill/librdkafka/archive/v0.11.0.tar.gz  &&
      tar -xzf v0.11.0.tar.gz  && cd /root/librdkafka-0.11.0  && ./configure  && make  &&
      make install  && pecl install rdkafka  && echo "extension=rdkafka.so" >> /etc/php/7.1/fpm/conf.d/rdkafka.ini  &&
      echo "extension=rdkafka.so" >> /etc/php/7.1/cli/php.ini  && cd ~
    Name: run
    PrependShell: true
  - CmdLine:
    - mkdir -p /etc/nginx
    Name: run
    PrependShell: true
  - CmdLine:
    - mkdir -p /run/nginx
    Name: run
    PrependShell: true
  - CmdLine:
    - rm -Rf /etc/nginx/nginx.conf
    Name: run
    PrependShell: true
  - Chown: ""
    Name: add
    SourcesAndDest:
    - conf/nginx.conf
    - /etc/nginx/nginx.conf
  - CmdLine:
    - mkdir -p /etc/nginx/sites-available/ &&     mkdir -p /etc/nginx/sites-enabled/
      &&     rm -Rf /var/www/* &&     mkdir /var/www/html/
    Name: run
    PrependShell: true
  - Chown: ""
    Name: add
    SourcesAndDest:
    - conf/nginx-site.conf
    - /etc/nginx/sites-available/default.conf
  - CmdLine:
    - rm -Rf /etc/nginx/sites-enabled/*
    Name: run
    PrependShell: true
  - CmdLine:
    - ln -s /etc/nginx/sites-available/default.conf /etc/nginx/sites-enabled/default.conf
    Name: run
    PrependShell: true
  - CmdLine:
    - sed -i         -e "s/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/g"         -e "s/upload_max_filesize\s*=\s*2M/upload_max_filesize
      = 100M/g"         -e "s/post_max_size\s*=\s*8M/post_max_size = 100M/g"         -e
      "s/variables_order = \"GPCS\"/variables_order = \"EGPCS\"/g"         -e "s/max_execution_time\s*=\s*30/max_execution_time
      = 300/g"         -e "s/max_input_time\s*=\s*60/max_input_time = 360/g"         ${php_conf}
      &&     sed -i         -e "s/;daemonize\s*=\s*yes/daemonize = no/g"         ${fpm_conf}
      &&     sed -i         -e "s/;catch_workers_output\s*=\s*yes/catch_workers_output
      = yes/g"         -e "s/pm.max_children = 5/pm.max_children = 100/g"         -e
      "s/pm.start_servers = 2/pm.start_servers = 3/g"         -e "s/pm.min_spare_servers
      = 1/pm.min_spare_servers = 2/g"         -e "s/pm.max_spare_servers = 3/pm.max_spare_servers
      = 4/g"         -e "s/;pm.max_requests = 500/pm.max_requests = 200/g"         -e
      "s/;listen.mode = 0660/listen.mode = 0666/g"         -e "s/listen = \/run\/php\/php7.1-fpm.sock/listen
      = \/var\/run\/php-fpm.sock/g"         -e "s/^;clear_env = no$/clear_env = no/"         ${fpm_pool_conf}
      &&     ln -s /etc/php/7.1/cli/php.ini /etc/php/7.1/cli/conf.d/php.ini &&     find
      /etc/php/7.1/cli/conf.d/ -name "*.ini" -exec sed -i -re 's/^(\s*)#(.*)/\1;\2/g'
      {} \;
    Name: run
    PrependShell: true
  - CmdLine:
    - echo "export PATH=${PATH}:/var/www/html/vendor/bin" >> ~/.bashrc
    Name: run
    PrependShell: true
  - CmdLine:
    - curl -s http://getcomposer.org/installer | php     && mv composer.phar /usr/local/bin/composer
    Name: run
    PrependShell: true
  - Chown: ""
    Name: add
    SourcesAndDest:
    - conf/crontab
    - /etc/cron.d/workspace-cron
  - CmdLine:
    - chmod 0644 /etc/cron.d/workspace-cron
    Name: run
    PrependShell: true
  - CmdLine:
    - . ~/.bashrc
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /var/www/html
  - Name: expose
    Ports:
    - "80"
  - Chown: ""
    Name: add
    SourcesAndDest:
    - scripts/start.sh
    - /start.sh
  - CmdLine:
    - chmod 0700 /start.sh
    Name: run
    PrependShell: true
  - CmdLine:
    - /start.sh
    Name: cmd
    PrependShell: false
  From:
    Image: phusion/baseimage:latest
  Name: ""
  Platform: ""
  SourceCode: FROM phusion/baseimage:latest
