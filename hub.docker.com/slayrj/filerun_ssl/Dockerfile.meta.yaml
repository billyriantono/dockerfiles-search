MetaArgs: null
Stages:
- BaseName: php:7.3.6-apache
  Commands:
  - CmdLine:
    - "apt-get update     && apt-get install -y         libapache2-mod-xsendfile         libfreetype6-dev
      \        libjpeg62-turbo-dev         libldap2-dev         libxml2-dev         libzip-dev
      \        libcurl4-gnutls-dev         dcraw         locales         graphicsmagick
      \        ffmpeg         mysql-client         unzip         cron \tssl-cert     &&
      apt-get clean     && rm -rf /var/lib/apt/lists/*     && docker-php-ext-configure
      zip --with-libzip     && docker-php-ext-configure gd --with-freetype-dir=/usr/include/
      --with-jpeg-dir=/usr/include/     && docker-php-ext-configure ldap --with-libdir=lib/x86_64-linux-gnu
      \    && docker-php-ext-install -j$(nproc) pdo_mysql exif zip gd opcache ldap"
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - filerun-optimization.ini
    - /usr/local/etc/php/conf.d/
  - CmdLine:
    - curl -O http://downloads3.ioncube.com/loader_downloads/ioncube_loaders_lin_x86-64.tar.gz  &&
      tar xvfz ioncube_loaders_lin_x86-64.tar.gz  && PHP_EXT_DIR=$(php-config --extension-dir)  &&
      cp "ioncube/ioncube_loader_lin_7.3.so" $PHP_EXT_DIR  && echo "zend_extension=ioncube_loader_lin_7.3.so"
      >> /usr/local/etc/php/conf.d/00_ioncube_loader_lin_7.3.ini  && rm -rf ioncube
      ioncube_loaders_lin_x86-64.tar.gz
    Name: run
    PrependShell: true
  - CmdLine:
    - "{ \t\techo 'XSendFile On'; \t\techo; \t\techo 'XSendFilePath /user-files';
      \t} | tee \"/etc/apache2/conf-available/filerun.conf\" \t&& a2enconf filerun"
    Name: run
    PrependShell: true
  - CmdLine:
    - curl -o /filerun.zip -L https://filerun.com/download-latest-php73  && mkdir
      /user-files  && chown www-data:www-data /user-files
    Name: run
    PrependShell: true
  - Env:
    - Key: FR_DB_HOST
      Value: db
    Name: env
  - Env:
    - Key: FR_DB_PORT
      Value: "3306"
    Name: env
  - Env:
    - Key: FR_DB_NAME
      Value: filerun
    Name: env
  - Env:
    - Key: FR_DB_USER
      Value: filerun
    Name: env
  - Env:
    - Key: FR_DB_PASS
      Value: filerun
    Name: env
  - Env:
    - Key: APACHE_RUN_USER
      Value: user
    Name: env
  - Env:
    - Key: APACHE_RUN_USER_ID
      Value: "1000"
    Name: env
  - Env:
    - Key: APACHE_RUN_GROUP
      Value: user
    Name: env
  - Env:
    - Key: APACHE_RUN_GROUP_ID
      Value: "1000"
    Name: env
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - db.sql
    - /filerun.setup.sql
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - autoconfig.php
    - /
  - Name: volume
    Volumes:
    - /var/www/html
    - /user-files
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - ./entrypoint.sh
    - /
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - ./wait-for-it.sh
    - /
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - ./import-db.sh
    - /
  - CmdLine:
    - chmod +x /wait-for-it.sh
    Name: run
    PrependShell: true
  - CmdLine:
    - chmod +x /import-db.sh
    Name: run
    PrependShell: true
  - CmdLine:
    - chmod +x /entrypoint.sh
    Name: run
    PrependShell: true
  - CmdLine:
    - a2ensite default-ssl
    Name: run
    PrependShell: true
  - CmdLine:
    - a2enmod ssl
    Name: run
    PrependShell: true
  - CmdLine:
    - make-ssl-cert generate-default-snakeoil --force-overwrite
    Name: run
    PrependShell: true
  - CmdLine:
    - /entrypoint.sh
    Name: entrypoint
    PrependShell: false
  - CmdLine:
    - apache2-foreground
    Name: cmd
    PrependShell: false
  From:
    Image: php:7.3.6-apache
  Name: ""
  Platform: ""
  SourceCode: FROM php:7.3.6-apache
