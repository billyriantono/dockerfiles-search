MetaArgs: null
Stages:
- BaseName: phusion/baseimage
  Commands:
  - Env:
    - Key: DEBIAN_FRONTEND
      Value: noninteractive
    Name: env
  - Env:
    - Key: HOME
      Value: '"/root"'
    Name: env
  - Env:
    - Key: TERM
      Value: xterm
    Name: env
  - Env:
    - Key: LANG
      Value: en_US.UTF-8
    Name: env
  - Env:
    - Key: LANGUAGE
      Value: en_US:en
    Name: env
  - Env:
    - Key: LC_ALL
      Value: en_US.UTF-8
    Name: env
  - Env:
    - Key: ASTERISKUSER
      Value: asterisk
    Name: env
  - Env:
    - Key: ASTERISK_DB_PW
      Value: Password
    Name: env
  - Env:
    - Key: ASTERISKVER
      Value: "13.1"
    Name: env
  - Env:
    - Key: FREEPBXVER
      Value: 12.0.43
    Name: env
  - Name: expose
    Ports:
    - "80"
  - CmdLine:
    - /sbin/my_init
    Name: cmd
    PrependShell: false
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - start-apache2.sh
    - /etc/service/apache2/run
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - start-mysqld.sh
    - /etc/service/mysqld/run
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - start-asterisk.sh
    - /etc/service/asterisk/run
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - start-amportal.sh
    - /etc/my_init.d/10_amportal.sh
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - start-fail2ban.sh
    - /etc/my_init.d/20_fail2ban.sh
  - CmdLine:
    - chmod +x /etc/service/apache2/run &&     chmod +x /etc/service/mysqld/run &&     chmod
      +x /etc/service/asterisk/run &&     chmod +x /etc/my_init.d/10_amportal.sh &&     chmod
      +x /etc/my_init.d/20_fail2ban.sh
    Name: run
    PrependShell: true
  - CmdLine:
    - sed -i 's/archive.ubuntu.com/mirrors.digitalocean.com/' /etc/apt/sources.list
      &&     apt-get update &&     apt-get upgrade -y &&     apt-get install -y         apache2         automake         bison         build-essential         curl         fail2ban         flex         libasound2-dev         libcurl4-openssl-dev         libical-dev         libmyodbc         libmysqlclient-dev         libncurses5-dev         libneon27-dev         libnewt-dev         libogg-dev         libspandsp-dev         libsrtp0-dev         libssl-dev         libsqlite3-dev         libtool         libvorbis-dev         libxml2-dev         mpg123         mysql-client         mysql-server         php5         php5-cli         php5-curl         php-db         php5-gd         php5-mysql         php-pear         pkg-config         sox        sqlite3         autoconf         subversion         unixodbc-dev         uuid         uuid-dev
      &&     apt-get clean &&     rm -rf /var/lib/apt/lists/* &&     mv /etc/fail2ban/filter.d/asterisk.conf
      /etc/fail2ban/filter.d/asterisk.conf.org &&     mv /etc/fail2ban/jail.conf /etc/fail2ban/jail.conf.org
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - conf/fail2ban/asterisk.conf
    - /etc/fail2ban/filter.d/asterisk.conf
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - conf/fail2ban/jail.conf
    - /etc/fail2ban/jail.conf
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - conf/my-small.cnf
    - /etc/mysql/my.cnf
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - conf/mpm_prefork.conf
    - /etc/apache2/mods-available/mpm_prefork.conf
  - CmdLine:
    - pear uninstall db &&     pear install db-1.7.14
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /usr/src
  - CmdLine:
    - curl -sf -o pjproject.tar.bz2 -L http://www.pjsip.org/release/2.3/pjproject-2.3.tar.bz2
      &&     mkdir pjproject &&     tar -xf pjproject.tar.bz2 -C pjproject --strip-components=1
      &&     rm pjproject.tar.bz2 &&     cd pjproject &&     ./configure --enable-shared
      --disable-sound --disable-resample --disable-video --disable-opencore-amr &&     make
      dep &&     make &&     make install &&     rm -r /usr/src/pjproject
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /usr/src
  - CmdLine:
    - curl -sf -o jansson.tar.gz -L http://www.digip.org/jansson/releases/jansson-2.7.tar.gz
      &&     mkdir jansson &&     tar -xzf jansson.tar.gz -C jansson --strip-components=1
      &&     rm jansson.tar.gz &&     cd jansson &&     autoreconf -i &&     ./configure
      &&     make &&     make install &&     rm -r /usr/src/jansson
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /usr/src
  - CmdLine:
    - curl -sf -o asterisk.tar.gz -L http://downloads.asterisk.org/pub/telephony/certified-asterisk/certified-asterisk-$ASTERISKVER-current.tar.gz
      &&     mkdir asterisk &&     tar -xzf /usr/src/asterisk.tar.gz -C /usr/src/asterisk
      --strip-components=1 &&     rm asterisk.tar.gz &&     cd asterisk &&     ./configure
      &&     contrib/scripts/get_mp3_source.sh &&     make menuselect.makeopts &&     menuselect/menuselect
      --enable chan_sip menuselect.makeopts &&     sed -i "s/BUILD_NATIVE//" menuselect.makeopts
      &&     make &&     make install &&     make config &&     ldconfig &&     rm
      -r /usr/src/asterisk
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /var/lib/asterisk/sounds
  - CmdLine:
    - curl -sf -o asterisk-extra-sounds-en-wav-current.tar.gz -L http://downloads.asterisk.org/pub/telephony/sounds/asterisk-extra-sounds-en-wav-current.tar.gz
      &&     tar -xzf asterisk-extra-sounds-en-wav-current.tar.gz &&     rm -f asterisk-extra-sounds-en-wav-current.tar.gz
      &&     curl -sf -o asterisk-extra-sounds-en-g722-current.tar.gz -L http://downloads.asterisk.org/pub/telephony/sounds/asterisk-extra-sounds-en-g722-current.tar.gz
      &&     tar -xzf asterisk-extra-sounds-en-g722-current.tar.gz &&     rm -f asterisk-extra-sounds-en-g722-current.tar.gz
    Name: run
    PrependShell: true
  - CmdLine:
    - useradd -m $ASTERISKUSER &&     chown $ASTERISKUSER. /var/run/asterisk &&     chown
      -R $ASTERISKUSER. /etc/asterisk &&     chown -R $ASTERISKUSER. /var/lib/asterisk
      &&     chown -R $ASTERISKUSER. /var/log/asterisk &&     chown -R $ASTERISKUSER.
      /var/spool/asterisk &&     chown -R $ASTERISKUSER. /usr/lib/asterisk &&     chown
      -R $ASTERISKUSER. /var/www/ &&     chown -R $ASTERISKUSER. /var/www/* &&     rm
      -rf /var/www/html
    Name: run
    PrependShell: true
  - CmdLine:
    - sed -i 's/\(^upload_max_filesize = \).*/\120M/' /etc/php5/apache2/php.ini &&     cp
      /etc/apache2/apache2.conf /etc/apache2/apache2.conf_orig &&     sed -i 's/^\(User\|Group\).*/\1
      asterisk/' /etc/apache2/apache2.conf &&     sed -i 's/AllowOverride None/AllowOverride
      All/' /etc/apache2/apache2.conf
    Name: run
    PrependShell: true
  - CmdLine:
    - /etc/init.d/mysql start &&     mysqladmin -u root create asterisk &&     mysqladmin
      -u root create asteriskcdrdb &&     mysql -u root -e "GRANT ALL PRIVILEGES ON
      asterisk.* TO $ASTERISKUSER@localhost IDENTIFIED BY '$ASTERISK_DB_PW';" &&     mysql
      -u root -e "GRANT ALL PRIVILEGES ON asteriskcdrdb.* TO $ASTERISKUSER@localhost
      IDENTIFIED BY '$ASTERISK_DB_PW';" &&     mysql -u root -e "flush privileges;"
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /usr/src
  - CmdLine:
    - curl -sf -o freepbx-$FREEPBXVER.tgz -L http://mirror.freepbx.org/freepbx-$FREEPBXVER.tgz
      &&     tar xfz freepbx-$FREEPBXVER.tgz &&     rm freepbx-$FREEPBXVER.tgz &&     cd
      /usr/src/freepbx &&     /etc/init.d/mysql start &&     /etc/init.d/apache2 start
      &&     /usr/sbin/asterisk &&     ./install_amp --installdb --username=$ASTERISKUSER
      --password=$ASTERISK_DB_PW &&     amportal chown &&     amportal a ma upgrade
      framework &&     amportal a ma upgradeall &&     amportal chown &&     amportal
      a reload &&     amportal a ma refreshsignatures &&     amportal chown &&     mysql
      -u$ASTERISKUSER -p$ASTERISK_DB_PW asterisk -e "INSERT into logfile_logfiles         (name,
      debug, dtmf, error, fax, notice, verbose, warning, security)         VALUES
      ('fail2ban', 'off', 'off', 'on', 'off', 'on', 'off', 'on', 'on');" &&     amportal
      a r &&     ln -s /var/lib/asterisk/moh /var/lib/asterisk/mohmp3 &&     rm -r
      /usr/src/freepbx
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - conf/cdr/odbc.ini
    - /etc/odbc.ini
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - conf/cdr/odbcinst.ini
    - /etc/odbcinst.ini
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - conf/cdr/cdr_adaptive_odbc.conf
    - /etc/asterisk/cdr_adaptive_odbc.conf
  - CmdLine:
    - chown asterisk:asterisk /etc/asterisk/cdr_adaptive_odbc.conf &&     chmod 775
      /etc/asterisk/cdr_adaptive_odbc.conf
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /
  From:
    Image: phusion/baseimage
  Name: ""
  Platform: ""
  SourceCode: FROM phusion/baseimage
