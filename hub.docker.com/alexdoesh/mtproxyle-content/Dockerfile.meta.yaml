MetaArgs:
- DefaultValue: intersystemscommunity/irispy:latest
  Key: IMAGE
  ProvidedValue: null
  Value: intersystemscommunity/irispy:latest
Stages:
- BaseName: ${IMAGE}
  Commands:
  - Name: user
    User: root
  - CmdLine:
    - pip install pandas matplotlib seaborn numpy dill Pillow "tensorflow>=2.0.0"
      tensorflow-hub tqdm
    Name: run
    PrependShell: true
  - Name: user
    User: root
  - Env:
    - Key: SRC_DIR
      Value: /home/irisowner
    Name: env
  - Chown: irisowner
    From: ""
    Name: copy
    SourcesAndDest:
    - ./iscpython.o
    - $ISC_PACKAGE_INSTALLDIR/bin/iscpython.o
  - Chown: irisowner
    From: ""
    Name: copy
    SourcesAndDest:
    - ./iscpython.so
    - $ISC_PACKAGE_INSTALLDIR/bin/iscpython.so
  - Chown: irisowner
    From: ""
    Name: copy
    SourcesAndDest:
    - ./od/
    - $SRC_DIR/od
  - Chown: irisuser
    From: ""
    Name: copy
    SourcesAndDest:
    - ./pycode
    - /home/irisuser/pycode
  - Chown: irisuser
    From: ""
    Name: copy
    SourcesAndDest:
    - ./web
    - /usr/irissys/csp/python
  - CmdLine:
    - set -ex         && wget -O inception.tar "https://tfhub.dev/google/faster_rcnn/openimages_v4/inception_resnet_v2/1?tf-hub-format=compressed"     &&
      mkdir -p /home/irisuser/models     && tar -xvf inception.tar -C /home/irisuser/models      &&
      rm inception.tar     && chown -R irisuser:irisuser /home/irisuser/models
    Name: run
    PrependShell: true
  - Name: user
    User: irisowner
  - CmdLine:
    - 'iris start $ISC_PACKAGE_INSTANCENAME &&     /bin/echo -e " do \$system.OBJ.Load(\"/home/irisowner/od/Installer.cls\",\"ck\")\n"             "
      set sc = ##class(od.Installer).Setup(, 3)\n"             " halt"     | iris
      session $ISC_PACKAGE_INSTANCENAME &&  iris stop $ISC_PACKAGE_INSTANCENAME quietly   &&
      rm -rf $SRC_DIR/isc'
    Name: run
    PrependShell: true
  - Health:
      Interval: 5000000000
      Test:
      - CMD-SHELL
      - /irisHealth.sh || exit 1
    Name: healthcheck
  From:
    Image: ${IMAGE}
  Name: ""
  Platform: ""
  SourceCode: FROM ${IMAGE}
