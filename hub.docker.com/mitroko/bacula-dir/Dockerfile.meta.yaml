MetaArgs: null
Stages:
- BaseName: centos:7
  Commands:
  - Maintainer: Dzmitry Stremkouski mitroko@gmail.com
    Name: maintainer
  - CmdLine:
    - yum -y install epel-release
    Name: run
    PrependShell: true
  - CmdLine:
    - yum -y install bacula-director supervisor
    Name: run
    PrependShell: true
  - CmdLine:
    - echo $'[unix_http_server]\nfile=/var/run/supervisor/supervisor.sock\n\n[supervisord]\nlogfile=/var/log/supervisor/supervisord.log\nlogfile_maxbytes=50MB\nlogfile_backups=1\nloglevel=info\npidfile=/var/run/supervisord.pid\nnodaemon=true\nminfds=1024\nminprocs=200\nuser=root\n\n[rpcinterface:supervisor]\nsupervisor.rpcinterface_factory
      = supervisor.rpcinterface:make_main_rpcinterface\n\n[supervisorctl]\nserverurl=unix:///var/run/supervisor/supervisor.sock\n\n[program:bacula-dir]\ncommand=/usr/sbin/bacula-dir
      -c /etc/bacula/bacula-dir.conf -f\nnumprocs=1\nautostart=true\nautorestart=true\nstartsecs=10\nstartretries=1\nuser=bacula\nstdout_logfile=/var/log/supervisor/bacula-dir.stdout.log\nstdout_logfile_maxbytes=1MB\nstdout_logfile_backups=10\nstderr_logfile=/var/log/supervisor/bacula-dir.stderr.log\nstderr_logfile_maxbytes=1MB\nstderr_logfile_backups=10\n'
      > /usr/local/etc/supervisord.conf
    Name: run
    PrependShell: true
  - CmdLine:
    - sed -i 's/PidDirectory.*/PidDirectory = \/var\/run\/bacula/' /etc/bacula/bacula-dir.conf
    Name: run
    PrependShell: true
  - CmdLine:
    - 'mkdir -p /var/run/bacula && chown bacula: /var/run/bacula -R'
    Name: run
    PrependShell: true
  - CmdLine:
    - cp /etc/bacula/bacula-dir.conf /usr/local/share/bacula-dir.conf && cp /etc/bacula/query.sql
      /usr/local/share/bacula-dir.query.sql
    Name: run
    PrependShell: true
  - CmdLine:
    - 'echo $''#!/bin/bash\n[ -f /etc/bacula/bin/dir_pre_start.sh ] && /etc/bacula/bin/dir_pre_start.sh\n[
      ! -f /etc/bacula/bacula-dir.conf ] && cp /usr/local/share/bacula-dir.query.sql
      /etc/bacula/query.sql && chown bacula: /etc/bacula/query.sql \n[ ! -f /etc/bacula/bacula-dir.conf
      ] && cp /usr/local/share/bacula-dir.conf /etc/bacula/bacula-dir.conf && chown
      bacula: /etc/bacula/bacula-dir.conf \nfind /var/run/ -iname *.pid -delete\n/usr/bin/supervisord
      -n -c /usr/local/etc/supervisord.conf\n'' > /usr/local/bin/entrypoint.sh &&
      chmod 0755 /usr/local/bin/entrypoint.sh'
    Name: run
    PrependShell: true
  - Name: expose
    Ports:
    - 9101/tcp
  - Name: volume
    Volumes:
    - /etc/bacula
  - CmdLine:
    - /usr/local/bin/entrypoint.sh
    Name: entrypoint
    PrependShell: false
  From:
    Image: centos:7
  Name: ""
  Platform: ""
  SourceCode: FROM centos:7
