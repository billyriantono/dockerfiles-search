MetaArgs: null
Stages:
- BaseName: debian:9
  Commands:
  - Maintainer: Jose A Alferez <correo@alferez.es>
    Name: maintainer
  - Env:
    - Key: NAGIOS_VERSION
      Value: 4.3.1
    Name: env
  - Env:
    - Key: DEBIAN_FRONTEND
      Value: noninteractive
    Name: env
  - CmdLine:
    - echo "Europe/Madrid" > /etc/timezone
    Name: run
    PrependShell: true
  - CmdLine:
    - dpkg-reconfigure tzdata
    Name: run
    PrependShell: true
  - CmdLine:
    - echo "deb http://httpredir.debian.org/debian stretch-backports main" >> /etc/apt/sources.list
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get update -y --fix-missing
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get -y upgrade
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get install -y --fix-missing wget curl nano apache2 php-mysql build-essential
      php-cgi php-gd php-common php-curl libgd2-xpm-dev openssl libssl-dev xinetd
      apache2-utils unzip libapache2-mod-php php-cli  make mosquitto-clients bc dnsutils
    Name: run
    PrependShell: true
  - CmdLine:
    - groupadd nagios
    Name: run
    PrependShell: true
  - CmdLine:
    - groupadd nagcmd
    Name: run
    PrependShell: true
  - CmdLine:
    - useradd -u 3000 -g nagios -G nagcmd -d /usr/local/nagios -c 'Nagios Admin' nagios
    Name: run
    PrependShell: true
  - CmdLine:
    - usermod -a -G nagcmd nagios
    Name: run
    PrependShell: true
  - CmdLine:
    - usermod -G nagcmd www-data
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /tmp
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - ./nagioscore
    - /tmp/nagioscore
  - Name: workdir
    Path: /tmp/nagioscore
  - CmdLine:
    - ./configure  --prefix=/usr/local/nagios --with-nagios-user=nagios --with-nagios-group=nagios
      --with-command-user=nagios --with-command-group=nagcmd
    Name: run
    PrependShell: true
  - CmdLine:
    - make all
    Name: run
    PrependShell: true
  - CmdLine:
    - make install
    Name: run
    PrependShell: true
  - CmdLine:
    - make install-commandmode
    Name: run
    PrependShell: true
  - CmdLine:
    - make install-init
    Name: run
    PrependShell: true
  - CmdLine:
    - make install-config
    Name: run
    PrependShell: true
  - CmdLine:
    - /usr/bin/install -c -m 644 sample-config/httpd.conf /etc/apache2/sites-available/nagios.conf
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /tmp
  - CmdLine:
    - rm -rf nagios
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get install -y --fix-missing  m4 gettext automake autoconf
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - ./nagios-plugins
    - /tmp/nagios-plugins
  - Name: workdir
    Path: /tmp/nagios-plugins
  - CmdLine:
    - ./tools/setup
    Name: run
    PrependShell: true
  - CmdLine:
    - ./configure --with-nagios-user=nagios --with-nagios-group=nagios --with-openssl
    Name: run
    PrependShell: true
  - CmdLine:
    - make
    Name: run
    PrependShell: true
  - CmdLine:
    - make install
    Name: run
    PrependShell: true
  - CmdLine:
    - make install-root
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /tmp
  - CmdLine:
    - rm -rf nagios-plugins
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /tmp
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - ./nrpe
    - /tmp/nrpe
  - Name: workdir
    Path: /tmp/nrpe
  - CmdLine:
    - ./configure --enable-command-args --with-nagios-user=nagios --with-nagios-group=nagios
      --with-ssl=/usr/bin/openssl --with-ssl-lib=/usr/lib/x86_64-linux-gnu
    Name: run
    PrependShell: true
  - CmdLine:
    - make all
    Name: run
    PrependShell: true
  - CmdLine:
    - make install
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /tmp
  - CmdLine:
    - rm -rf nrpe
    Name: run
    PrependShell: true
  - CmdLine:
    - a2enmod rewrite
    Name: run
    PrependShell: true
  - CmdLine:
    - a2enmod cgi
    Name: run
    PrependShell: true
  - CmdLine:
    - a2enmod auth_form
    Name: run
    PrependShell: true
  - CmdLine:
    - a2enmod session_cookie
    Name: run
    PrependShell: true
  - CmdLine:
    - a2enmod session_crypto
    Name: run
    PrependShell: true
  - CmdLine:
    - a2enmod request
    Name: run
    PrependShell: true
  - CmdLine:
    - echo "ServerName localhost" | tee /etc/apache2/conf-available/fqdn.conf
    Name: run
    PrependShell: true
  - CmdLine:
    - ln -s /etc/apache2/conf-available/fqdn.conf /etc/apache2/conf-enabled/fqdn.conf
    Name: run
    PrependShell: true
  - CmdLine:
    - ln -s /etc/apache2/sites-available/nagios.conf /etc/apache2/sites-enabled/
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - ./default-config/default_confg.tar.gz
    - /tmp/default_confg.tar.gz
  - CmdLine:
    - tar zxvf /tmp/default_confg.tar.gz
    Name: run
    PrependShell: true
  - CmdLine:
    - rm -rf /usr/local/nagios/etc
    Name: run
    PrependShell: true
  - CmdLine:
    - mv /tmp/etc /usr/local/nagios
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get update -y --fix-missing
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get install -y libb-utils-perl libstring-random-perl python  libio-socket-ssl-perl
      libxml-simple-perl
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get install -y snmp python-axolotl python-dateutil python-setuptools
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get install -y python-dev libffi-dev libssl-dev libmonitoring-plugin-perl
    Name: run
    PrependShell: true
  - CmdLine:
    - easy_install pip
    Name: run
    PrependShell: true
  - CmdLine:
    - pip install python-axolotl
    Name: run
    PrependShell: true
  - CmdLine:
    - pip install twx.botapi
    Name: run
    PrependShell: true
  - CmdLine:
    - pip install urllib3
    Name: run
    PrependShell: true
  - CmdLine:
    - pip install pyopenssl
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get install -y make libperl-dev libparams-validate-perl libmath-calc-units-perl
      libclass-accessor-perl libconfig-tiny-perl git
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /tmp
  - CmdLine:
    - git clone https://github.com/nagios-plugins/nagios-plugin-perl.git
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /tmp/nagios-plugin-perl
  - CmdLine:
    - perl Makefile.PL
    Name: run
    PrependShell: true
  - CmdLine:
    - make
    Name: run
    PrependShell: true
  - CmdLine:
    - make test
    Name: run
    PrependShell: true
  - CmdLine:
    - make install
    Name: run
    PrependShell: true
  - CmdLine:
    - echo "alias l='ls -la'" >> /root/.bashrc
    Name: run
    PrependShell: true
  - CmdLine:
    - echo "export TERM=xterm" >> /root/.bashrc
    Name: run
    PrependShell: true
  - CmdLine:
    - wget https://www.alferez.es/nagios_logos/dockerbyalferez.png -O /usr/local/nagios/share/images/dockerbyalferez.png
    Name: run
    PrependShell: true
  - CmdLine:
    - wget https://www.alferez.es/nagios_logos/sblogo.png -O /usr/local/nagios/share/images/sblogo.png
    Name: run
    PrependShell: true
  - CmdLine:
    - wget https://www.alferez.es/nagios_logos/logofullsize.png -O /usr/local/nagios/share/images/logofullsize.png
    Name: run
    PrependShell: true
  - CmdLine:
    - wget https://www.alferez.es/nagios_logos/corelogo.gif -O /usr/local/nagios/share/images/corelogo.gif
    Name: run
    PrependShell: true
  - CmdLine:
    - sed -i '/<div class="logos">/a\                <a href="https:\/\/www.alferez.es\/"
      target="_blank"><img src="images\/dockerbyalferez.png" width="110" height="50"
      border="1" alt="Alferez.es" \/><\/a>' /usr/local/nagios/share/main.php
    Name: run
    PrependShell: true
  - CmdLine:
    - sed -i 's/sblogo.png" height="39"/sblogo.png" height="52"/g' /usr/local/nagios/share/side.php
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get remove --purge -y exim4*
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get install -y --fix-missing postfix
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get install -y --fix-missing mailutils
    Name: run
    PrependShell: true
  - CmdLine:
    - postconf -e mynetworks="0.0.0.0/0"
    Name: run
    PrependShell: true
  - Env:
    - Key: ROOT_EMAIL
      Value: nagios@nagiossystem.com
    Name: env
  - Env:
    - Key: MAILNAME
      Value: nagios.nagiossystem.com
    Name: env
  - CmdLine:
    - postconf -e myhostname=$MAILNAME
    Name: run
    PrependShell: true
  - CmdLine:
    - echo $MAILNAME > /etc/mailname
    Name: run
    PrependShell: true
  - CmdLine:
    - 'echo root: $ROOT_EMAIL >> /etc/aliases'
    Name: run
    PrependShell: true
  - CmdLine:
    - /usr/bin/newaliases
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get autoremove -y
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get clean
    Name: run
    PrependShell: true
  - CmdLine:
    - rm -rf /tmp/* /var/tmp/*
    Name: run
    PrependShell: true
  - CmdLine:
    - rm -rf /var/lib/apt/lists/*
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - ./assets/start.sh
    - /start.sh
  - CmdLine:
    - chmod +x /start.sh
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /root
  - CmdLine:
    - '"/start.sh"'
    Name: entrypoint
    PrependShell: true
  From:
    Image: debian:9
  Name: ""
  Platform: ""
  SourceCode: FROM debian:9
