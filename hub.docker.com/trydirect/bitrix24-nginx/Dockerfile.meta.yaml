MetaArgs: null
Stages:
- BaseName: nginx:1.14
  Commands:
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - conf/nginx.conf
    - /etc/nginx/
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - conf/default.conf
    - /etc/nginx/conf.d/
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - conf/upstream.conf
    - /etc/nginx/conf.d/
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - conf/push_and_pull.conf
    - /etc/nginx/conf.d/
  - CmdLine:
    - apt-get update && apt-get install apt-file -y && apt-file update && apt-get
      install vim git wget curl net-tools build-essential gcc make libpcre++-dev zlib1g-dev
      libssl-dev -y
    Name: run
    PrependShell: true
  - CmdLine:
    - git clone https://github.com/wandenberg/nginx-push-stream-module.git
    Name: run
    PrependShell: true
  - Env:
    - Key: NGINX_PUSH_STREAM_MODULE_PATH
      Value: $PWD/nginx-push-stream-module
    Name: env
  - CmdLine:
    - wget http://nginx.org/download/nginx-1.2.0.tar.gz && tar xzvf nginx-1.2.0.tar.gz
    Name: run
    PrependShell: true
  - Name: workdir
    Path: nginx-1.2.0
  - CmdLine:
    - wget http://zlib.net/zlib-1.2.11.tar.gz && tar -xf zlib-1.2.11.tar.gz
    Name: run
    PrependShell: true
  - CmdLine:
    - wget https://www.openssl.org/source/openssl-1.0.2n.tar.gz && tar -xf openssl-1.0.2n.tar.gz
    Name: run
    PrependShell: true
  - CmdLine:
    - wget https://ftp.pcre.org/pub/pcre/pcre-8.41.tar.gz && tar -xf pcre-8.41.tar.gz
    Name: run
    PrependShell: true
  - CmdLine:
    - ./configure --add-module=../nginx-push-stream-module --with-zlib=./zlib-1.2.11
      --with-openssl=./openssl-1.0.2n --with-pcre=./pcre-8.41 --with-http_ssl_module
      && make build && make install
    Name: run
    PrependShell: true
  - CmdLine:
    - mv /usr/sbin/nginx /usr/sbin/nginx_backup
    Name: run
    PrependShell: true
  - CmdLine:
    - mv /usr/local/nginx/sbin/nginx /usr/sbin/nginx
    Name: run
    PrependShell: true
  - CmdLine:
    - mv /usr/local/nginx/conf/ /usr/local/nginx/conf_del
    Name: run
    PrependShell: true
  - CmdLine:
    - ln -s /etc/nginx/ /usr/local/nginx/conf
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - conf/init-deb.sh
    - /etc/init.d/
  - CmdLine:
    - mv /etc/init.d/init-deb.sh /etc/init.d/nginx
    Name: run
    PrependShell: true
  - CmdLine:
    - chmod +x /etc/init.d/nginx
    Name: run
    PrependShell: true
  - CmdLine:
    - /usr/sbin/update-rc.d -f nginx defaults
    Name: run
    PrependShell: true
  - CmdLine:
    - usermod -u 1000 www-data
    Name: run
    PrependShell: true
  - CmdLine:
    - nginx
    Name: cmd
    PrependShell: false
  - Name: expose
    Ports:
    - "443"
    - "80"
    - "8893"
    - "8894"
    - "8895"
  From:
    Image: nginx:1.14
  Name: ""
  Platform: ""
  SourceCode: FROM nginx:1.14
