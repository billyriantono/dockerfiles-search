MetaArgs: null
Stages:
- BaseName: opensuse:42.3
  Commands:
  - Maintainer: Thomas Schulte <thomas@cupracer.de>
    Name: maintainer
  - Name: expose
    Ports:
    - "80"
  - Env:
    - Key: MONGO_HOST
      Value: mongo
    - Key: MONGO_PORT
      Value: "27017"
    - Key: MONGO_USER
      Value: thumbsniper
    - Key: MONGO_PASS
      Value: secret
    - Key: MONGO_DB
      Value: thumbsniper
    Name: env
  - CmdLine:
    - zypper --non-interactive ref     && zypper --non-interactive up     && zypper
      --non-interactive in curl
    Name: run
    PrependShell: true
  - CmdLine:
    - rpm --import http://download.opensuse.org/repositories/server:/php:/extensions/openSUSE_Leap_42.3/repodata/repomd.xml.key     &&
      zypper ar --refresh http://download.opensuse.org/repositories/server:/php:/extensions/openSUSE_Leap_42.3/server:php:extensions.repo     &&
      zypper ar --refresh --no-gpgcheck https://repo.mongodb.org/zypper/suse/12/mongodb-org/3.4/x86_64/
      mongodb     && zypper ref
    Name: run
    PrependShell: true
  - CmdLine:
    - zypper --non-interactive in     apache2-mod_php5     gcc     git     make     mongodb-org-shell     netcat-openbsd     npm     openssl-devel     php5-curl     php5-devel     php5-gd     php5-geoip     php5-intl     php5-json     php5-mbstring     php5-openssl     php5-pear     php5-phar     php5-zip     zlib-devel
    Name: run
    PrependShell: true
  - CmdLine:
    - curl -o /tmp/pecl-mongo.tgz  https://pecl.php.net/get/mongo     && mkdir /tmp/pecl-mongo     &&
      tar xf /tmp/pecl-mongo.tgz --strip 1 -C /tmp/pecl-mongo     && cd /tmp/pecl-mongo     &&
      phpize     && CFLAGS="-fno-strict-aliasing" ./configure --with-libdir=/usr/lib64
      --enable-mongo     && make     && make install     && cd /     && echo "extension=mongo.so"
      > /etc/php5/conf.d/mongo.ini     && rm -rf /tmp/pecl-mongo*
    Name: run
    PrependShell: true
  - CmdLine:
    - curl -s https://getcomposer.org/installer | php -- --install-dir /usr/local/bin
      --filename composer
    Name: run
    PrependShell: true
  - CmdLine:
    - npm install -g bower
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - etc/apache2
    - /etc/apache2
  - CmdLine:
    - a2enmod php5     && a2enmod logio     && a2enmod expires     && a2enmod headers     &&
      a2enmod remoteip     && a2enmod rewrite     && a2enflag FOREGROUND
    Name: run
    PrependShell: true
  - CmdLine:
    - git clone -b v0.9.15 https://github.com/thumbsniper/backend.git /opt/thumbsniper
    Name: run
    PrependShell: true
  - CmdLine:
    - composer --working-dir=/opt/thumbsniper update
    Name: run
    PrependShell: true
  - CmdLine:
    - echo 'always_populate_raw_post_data=-1' >> /etc/php5/apache2/php.ini     &&
      echo 'geoip.custom_directory=/usr/local/share/GeoIP' >> /etc/php5/apache2/php.ini     &&
      echo 'post_max_size=128M' >> /etc/php5/apache2/php.ini     && echo 'upload_max_filesize=128M'
      >> /etc/php5/apache2/php.ini     && echo 'include_path=.:/usr/share/php5:/usr/share/php5/PEAR:/opt/thumbsniper'
      >> /etc/php5/apache2/php.ini     && echo 'open_basedir=/opt/thumbsniper:/usr/share/php5:/tmp'
      >> /etc/php5/apache2/php.ini     && echo 'upload_tmp_dir=/tmp' >> /etc/php5/apache2/php.ini     &&
      echo 'session.save_path=/tmp' >> /etc/php5/apache2/php.ini     && echo 'sys_temp_dir=/tmp'
      >> /etc/php5/apache2/php.ini     && echo 'error_reporting=E_ALL' >> /etc/php5/apache2/php.ini     &&
      echo 'cgi.fix_pathinfo=0' >> /etc/php5/apache2/php.ini     && echo 'display_errors=Off'
      >> /etc/php5/apache2/php.ini     && echo 'expose_php=Off' >> /etc/php5/apache2/php.ini     &&
      echo 'log_errors=On' >> /etc/php5/apache2/php.ini     && echo 'date.timezone=Europe/Berlin'
      >> /etc/php5/apache2/php.ini
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /opt/thumbsniper/web_panel
  - CmdLine:
    - bower --allow-root --config.interactive=false update
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /
  - CmdLine:
    - groupmod -g 999 www     && usermod -u 999 -g 999 wwwrun     && chown -R wwwrun
      /var/cache/apache2 /var/lib/apache2 /var/lib/php5     && chown wwwrun:www /opt/thumbsniper/web_panel/templates_c
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - config/backend-config.inc.php
    - /opt/thumbsniper/config/backend-config.inc.php
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - config/panel-config.inc.php
    - /opt/thumbsniper/config/panel-config.inc.php
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - init.sh
    - /
  - CmdLine:
    - /init.sh
    Name: cmd
    PrependShell: false
  From:
    Image: opensuse:42.3
  Name: ""
  Platform: ""
  SourceCode: FROM opensuse:42.3
