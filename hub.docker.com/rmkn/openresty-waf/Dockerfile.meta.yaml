MetaArgs: null
Stages:
- BaseName: rmkn/centos7
  Commands:
  - Labels:
    - Key: maintainer
      Value: '"rmkn"'
    Name: label
  - Env:
    - Key: OPENRESTY_VERSION
      Value: 1.15.8.2
    Name: env
  - Env:
    - Key: OPENSSL_VERSION
      Value: 1.1.1d
    Name: env
  - Env:
    - Key: PCRE_VERSION
      Value: "8.43"
    Name: env
  - Env:
    - Key: ZLIB_VERSION
      Value: 1.2.11
    Name: env
  - Env:
    - Key: MODSECURITY_NGINX_VERSION
      Value: 1.0.0
    Name: env
  - Env:
    - Key: OWASP_CRS_VERSION
      Value: 3.1.0
    Name: env
  - Env:
    - Key: LUAROCKS_VERSION
      Value: 3.2.1
    Name: env
  - CmdLine:
    - yum install -y perl make gcc gcc-c++ pcre-devel ccache systemtap-sdt-devel patch
      git libtool autoconf file flex bison yajl yajl-devel curl-devel curl GeoIP-devel
      doxygen unzip
    Name: run
    PrependShell: true
  - CmdLine:
    - "curl -o /usr/local/src/zlib.tar.gz -SL https://www.zlib.net/zlib-${ZLIB_VERSION}.tar.gz
      \t&& tar zxf /usr/local/src/zlib.tar.gz -C /usr/local/src \t&& cd /usr/local/src/zlib-${ZLIB_VERSION}
      \t&& ./configure --prefix=/usr/local/openresty/zlib \t&& make CFLAGS='-O3 -D_LARGEFILE64_SOURCE=1
      -DHAVE_HIDDEN -g' SFLAGS='-O3 -fPIC -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN -g'
      \t&& make install"
    Name: run
    PrependShell: true
  - CmdLine:
    - "curl -o /usr/local/src/openssl.tar.gz -SL https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz
      \t&& tar zxf /usr/local/src/openssl.tar.gz -C /usr/local/src \t&& cd /usr/local/src/openssl-${OPENSSL_VERSION}
      \t&& curl -o sess_set_get_cb_yield.patch -SL https://raw.githubusercontent.com/openresty/openresty/master/patches/openssl-1.1.1c-sess_set_get_cb_yield.patch
      \t&& patch -p1 < sess_set_get_cb_yield.patch \t&& ./config no-threads shared
      zlib -g enable-ssl3 enable-ssl3-method --prefix=/usr/local/openresty/openssl
      --libdir=lib -I/usr/local/openresty/zlib/include -L/usr/local/openresty/zlib/lib
      -Wl,-rpath,/usr/local/openresty/zlib/lib:/usr/local/openresty/openssl/lib \t&&
      make CC='ccache gcc -fdiagnostics-color=always' \t&& make install_sw"
    Name: run
    PrependShell: true
  - CmdLine:
    - "curl -o /usr/local/src/pcre.tar.gz -SL https://ftp.pcre.org/pub/pcre/pcre-${PCRE_VERSION}.tar.gz
      \t&& tar zxf /usr/local/src/pcre.tar.gz -C /usr/local/src \t&& cd /usr/local/src/pcre-${PCRE_VERSION}
      \t&& ./configure --prefix=/usr/local/openresty/pcre --libdir=/usr/local/openresty/pcre/lib
      --disable-cpp --enable-jit --enable-utf --enable-unicode-properties \t&& make
      CC='ccache gcc -fdiagnostics-color=always' V=1 \t&& make install"
    Name: run
    PrependShell: true
  - CmdLine:
    - "cd /usr/local/src \t&& git clone https://github.com/SpiderLabs/ModSecurity
      \t&& cd /usr/local/src/ModSecurity \t&& ./build.sh \t&& git submodule init \t&&
      git submodule update \t&& ./configure  \t&& make \t&& make install"
    Name: run
    PrependShell: true
  - CmdLine:
    - "curl -o /usr/local/src/modsecurity-nginx.tar.gz -SL https://github.com/SpiderLabs/ModSecurity-nginx/archive/v${MODSECURITY_NGINX_VERSION}.tar.gz
      \t&& tar zxf /usr/local/src/modsecurity-nginx.tar.gz -C /usr/local/src"
    Name: run
    PrependShell: true
  - CmdLine:
    - "curl -o /usr/local/src/openresty.tar.gz -SL https://openresty.org/download/openresty-${OPENRESTY_VERSION}.tar.gz
      \t&& tar zxf /usr/local/src/openresty.tar.gz -C /usr/local/src \t&& cd /usr/local/src/openresty-${OPENRESTY_VERSION}
      \t&& ./configure \t\t--prefix=\"/usr/local/openresty\" \t\t--with-cc='ccache
      gcc -fdiagnostics-color=always' \t\t--with-cc-opt=\"-DNGX_LUA_ABORT_AT_PANIC
      -I/usr/local/openresty/zlib/include -I/usr/local/openresty/pcre/include -I/usr/local/openresty/openssl/include\"
      \t\t--with-ld-opt=\"-L/usr/local/openresty/zlib/lib -L/usr/local/openresty/pcre/lib
      -L/usr/local/openresty/openssl/lib -Wl,-rpath,/usr/local/openresty/zlib/lib:/usr/local/openresty/pcre/lib:/usr/local/openresty/openssl/lib\"
      \t\t--with-pcre-jit \t\t--without-http_rds_json_module \t\t--without-http_rds_csv_module
      \t\t--without-lua_rds_parser \t\t--with-stream \t\t--with-stream_ssl_module
      \t\t--with-stream_ssl_preread_module \t\t--with-http_v2_module \t\t--without-mail_pop3_module
      \t\t--without-mail_imap_module \t\t--without-mail_smtp_module \t\t--with-http_stub_status_module
      \t\t--with-http_realip_module \t\t--with-http_addition_module \t\t--with-http_auth_request_module
      \t\t--with-http_secure_link_module \t\t--with-http_random_index_module \t\t--with-http_gzip_static_module
      \t\t--with-http_sub_module \t\t--with-http_dav_module \t\t--with-http_flv_module
      \t\t--with-http_mp4_module \t\t--with-http_gunzip_module \t\t--with-threads
      \t\t--with-luajit-xcflags='-DLUAJIT_NUMMODE=2 -DLUAJIT_ENABLE_LUA52COMPAT' \t\t--with-dtrace-probes
      \t\t--add-dynamic-module=../ModSecurity-nginx-${MODSECURITY_NGINX_VERSION} \t&&
      gmake \t&& gmake install"
    Name: run
    PrependShell: true
  - CmdLine:
    - ln -sf /usr/local/openresty/nginx/sbin/nginx /usr/bin/openresty
    Name: run
    PrependShell: true
  - CmdLine:
    - "curl -o /usr/local/src/owasp-modsecurity-crs.tar.gz -SL https://github.com/SpiderLabs/owasp-modsecurity-crs/archive/v${OWASP_CRS_VERSION}.tar.gz
      \t&& tar zxf /usr/local/src/owasp-modsecurity-crs.tar.gz -C /usr/local \t&&
      cd /usr/local \t&& ln -sf owasp-modsecurity-crs-${OWASP_CRS_VERSION} owasp-modsecurity-crs
      \t&& mv /usr/local/owasp-modsecurity-crs/crs-setup.conf.example /usr/local/owasp-modsecurity-crs/crs-setup.conf"
    Name: run
    PrependShell: true
  - CmdLine:
    - "curl -o /usr/local/src/luarocks.tar.gz -SL https://luarocks.org/releases/luarocks-${LUAROCKS_VERSION}.tar.gz
      \t&& tar zxf /usr/local/src/luarocks.tar.gz  -C /usr/local/src \t&& cd /usr/local/src/luarocks-${LUAROCKS_VERSION}
      \t&& ./configure --with-lua=/usr/local/openresty/luajit/ \t&& make \t&& make
      install"
    Name: run
    PrependShell: true
  - CmdLine:
    - "rm -rf /usr/local/openresty/zlib/share \t&& rm -f  /usr/local/openresty/zlib/lib/*.la
      \t&& rm -rf /usr/local/openresty/zlib/lib/pkgconfig \t&& rm -f  /usr/local/openresty/zlib/lib/*.a
      \t&& rm -rf /usr/local/openresty/zlib/include \t&& rm -rf /usr/local/openresty/openssl/bin/c_rehash
      \t&& rm -rf /usr/local/openresty/openssl/lib/pkgconfig \t&& rm -rf /usr/local/openresty/openssl/misc
      \t&& rm -f  /usr/local/openresty/openssl/lib/*.a \t&& rm -rf /usr/local/openresty/openssl/include
      \t&& rm -rf /usr/local/openresty/pcre/bin \t&& rm -rf /usr/local/openresty/pcre/share
      \t&& rm -f  /usr/local/openresty/pcre/lib/*.la \t&& rm -f  /usr/local/openresty/pcre/lib/*pcrecpp*
      \t&& rm -f  /usr/local/openresty/pcre/lib/*pcreposix* \t&& rm -rf /usr/local/openresty/pcre/lib/pkgconfig
      \t&& rm -f  /usr/local/openresty/pcre/lib/*.a \t&& rm -rf /usr/local/openresty/pcre/include
      \t&& rm -rf /usr/local/openresty/luajit/share/man \t&& rm -rf /usr/local/openresty/luajit/lib/libluajit-5.1.a
      \t&& rm -f  /usr/local/openresty/bin/resty \t&& rm -f  /usr/local/openresty/bin/restydoc
      \t&& rm -f  /usr/local/openresty/bin/restydoc-index \t&& rm -f  /usr/local/openresty/bin/md2pod.pl
      \t&& rm -f  /usr/local/openresty/bin/nginx-xml2pod \t&& rm -f  /usr/local/openresty/resty.index
      \t&& rm -rf /usr/local/openresty/pod \t&& rm -rf /usr/local/openresty/bin/opm
      \t&& rm -rf /usr/local/openresty/site/manifest \t&& rm -rf /usr/local/openresty/site/pod
      \t&& rm -rf /usr/local/src/zlib-${ZLIB_VERSION} \t&& rm -rf /usr/local/src/openssl-${OPENSSL_VERSION}
      \t&& rm -rf /usr/local/src/pcre-${PCRE_VERSION} \t&& rm -rf /usr/local/src/openresty-${OPENRESTY_VERSION}
      \t&& rm -f  /usr/local/src/zlib.tar.gz \t&& rm -f  /usr/local/src/openssl.tar.gz
      \t&& rm -f  /usr/local/src/pcre.tar.gz \t&& rm -f  /usr/local/src/openresty.tar.gz"
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - nginx.conf
    - /usr/local/openresty/nginx/conf/
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - default.conf
    - security.conf
    - /usr/local/openresty/nginx/conf/conf.d/
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - main.conf
    - /usr/local/openresty/nginx/modsec/
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - openssl.cnf
    - /usr/local/openresty/openssl/ssl/
  - CmdLine:
    - cp /usr/local/src/ModSecurity/modsecurity.conf-recommended /usr/local/openresty/nginx/modsec/modsecurity.conf
    Name: run
    PrependShell: true
  - CmdLine:
    - cp /usr/local/src/ModSecurity/unicode.mapping /usr/local/openresty/nginx/modsec/
    Name: run
    PrependShell: true
  - Name: expose
    Ports:
    - "443"
    - "80"
  - CmdLine:
    - /usr/bin/openresty
    - -g
    - daemon off;
    Name: cmd
    PrependShell: false
  From:
    Image: rmkn/centos7
  Name: ""
  Platform: ""
  SourceCode: FROM rmkn/centos7
