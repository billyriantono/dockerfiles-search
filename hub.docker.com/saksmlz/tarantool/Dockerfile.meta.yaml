MetaArgs: null
Stages:
- BaseName: debian:stable
  Commands:
  - Maintainer: mail@racktear.com
    Name: maintainer
  - CmdLine:
    - groupadd -r tarantool && useradd -r -g tarantool tarantool
    Name: run
    PrependShell: true
  - Env:
    - Key: GOSU_VERSION
      Value: "1.7"
    Name: env
  - CmdLine:
    - "set -x     && apt-get update && apt-get install -y --no-install-recommends
      \t\tca-certificates \t\twget \t&& wget -O /usr/local/bin/gosu \"https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$(dpkg
      --print-architecture)\" \t&& wget -O /usr/local/bin/gosu.asc \"https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$(dpkg
      --print-architecture).asc\" \t&& export GNUPGHOME=\"$(mktemp -d)\" \t&& gpg
      --keyserver ha.pool.sks-keyservers.net --recv-keys B42F6819007F00F88E364FD4036A9C25BF357DD4
      \t&& gpg --batch --verify /usr/local/bin/gosu.asc /usr/local/bin/gosu \t&& rm
      -r \"$GNUPGHOME\" /usr/local/bin/gosu.asc \t&& chmod +x /usr/local/bin/gosu
      \t&& gosu nobody true     && apt-get purge -y ca-certificates wget     && apt-get
      autoremove -y \t&& rm -rf /var/lib/apt/lists/*"
    Name: run
    PrependShell: true
  - Env:
    - Key: TARANTOOL_VERSION
      Value: 1.7.4-0-g927bd9c24
    - Key: TARANTOOL_DOWNLOAD_URL
      Value: https://github.com/tarantool/tarantool.git
    - Key: TARANTOOL_INSTALL_LUADIR
      Value: /usr/local/share/tarantool
    - Key: LUAROCKS_URL
      Value: http://keplerproject.github.io/luarocks/releases/luarocks-2.3.0.tar.gz
    - Key: LUAROCK_AVRO_SCHEMA_REPO
      Value: https://github.com/tarantool/avro-schema.git
    - Key: LUAROCK_AVRO_SCHEMA_TAG
      Value: b49efa8
    - Key: LUAROCK_EXPIRATIOND_REPO
      Value: https://github.com/tarantool/expirationd.git
    - Key: LUAROCK_EXPIRATIOND_TAG
      Value: 9ec22b6
    - Key: LUAROCK_QUEUE_REPO
      Value: https://github.com/tarantool/queue.git
    - Key: LUAROCK_QUEUE_TAG
      Value: 24d730c
    - Key: LUAROCK_CONNPOOL_REPO
      Value: https://github.com/tarantool/connpool.git
    - Key: LUAROCK_CONNPOOL_TAG
      Value: 685af44
    - Key: LUAROCK_SHARD_REPO
      Value: https://github.com/tarantool/shard.git
    - Key: LUAROCK_SHARD_TAG
      Value: 278b906
    - Key: LUAROCK_HTTP_REPO
      Value: https://github.com/tarantool/http.git
    - Key: LUAROCK_HTTP_TAG
      Value: 4486de9
    - Key: LUAROCK_TARANTOOL_PROMETHEUS_REPO
      Value: https://github.com/tarantool/prometheus.git
    - Key: LUAROCK_TARANTOOL_PROMETHEUS_TAG
      Value: "0654304"
    - Key: LUAROCK_TARANTOOL_CURL_REPO
      Value: https://github.com/tarantool/curl.git
    - Key: LUAROCK_TARANTOOL_CURL_TAG
      Value: 2.2.7
    Name: env
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - luarocks-config.lua
    - /usr/local/etc/luarocks/config-5.1.lua
  - CmdLine:
    - "BUILD_PACKAGES='         devscripts         equivs         git         build-essential
      \        ca-certificates         wget         make         cmake         cdbs
      \        gcc         g++         unzip         libreadline-dev         libncurses5-dev
      \        binutils-dev         libiberty-dev         libbfd-dev         uuid-dev
      \        liblua5.1-0-dev         libev-dev         libcurl4-openssl-dev';     set
      -ex     && apt-get update     && apt-get upgrade --yes     && apt-get install
      --yes --no-install-recommends         $BUILD_PACKAGES         lua5.1         libyaml-dev
      \        libssl-dev         libgomp1         libev4     && : \"---------- tarantool
      ----------\"     && mkdir -p /usr/src/tarantool     && git clone \"$TARANTOOL_DOWNLOAD_URL\"
      /usr/src/tarantool     && git -C /usr/src/tarantool checkout \"$TARANTOOL_VERSION\"
      \    && git -C /usr/src/tarantool submodule update --init --recursive     &&
      (cd /usr/src/tarantool;        cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo             -DENABLE_BUNDLED_LIBYAML:BOOL=OFF
      \            -DENABLE_BACKTRACE:BOOL=ON             -DENABLE_DIST:BOOL=ON             .)
      \    && make -C /usr/src/tarantool -j    && make -C /usr/src/tarantool install
      \    && make -C /usr/src/tarantool clean     && : \"---------- small ----------\"
      \    && (cd /usr/src/tarantool/src/lib/small;         cmake -DCMAKE_INSTALL_PREFIX=/usr
      \              -DCMAKE_INSTALL_LIBDIR=lib               -DCMAKE_BUILD_TYPE=RelWithDebInfo
      \              .)     && make -C /usr/src/tarantool/src/lib/small     && make
      -C /usr/src/tarantool/src/lib/small install     && make -C /usr/src/tarantool/src/lib/small
      clean     && : \"---------- msgpuck ----------\"     && (cd /usr/src/tarantool/src/lib/msgpuck;
      \        cmake -DCMAKE_INSTALL_PREFIX=/usr               -DCMAKE_INSTALL_LIBDIR=lib
      \              -DCMAKE_BUILD_TYPE=RelWithDebInfo               .)     && make
      -C /usr/src/tarantool/src/lib/msgpuck     && make -C /usr/src/tarantool/src/lib/msgpuck
      install     && make -C /usr/src/tarantool/src/lib/msgpuck clean     && : \"----------
      luarocks ----------\"     && wget -O luarocks.tar.gz \"$LUAROCKS_URL\"     &&
      mkdir -p /usr/src/luarocks     && tar -xzf luarocks.tar.gz -C /usr/src/luarocks
      --strip-components=1     && (cd /usr/src/luarocks;         ./configure;         make
      build;         make install)     && rm -r /usr/src/luarocks     && rm -rf /usr/src/tarantool
      \    && mkdir -p /rocks     && luarocks install lua-term     && : \"avro\"     &&
      git clone $LUAROCK_AVRO_SCHEMA_REPO /rocks/avro     && git -C /rocks/avro checkout
      $LUAROCK_AVRO_SCHEMA_TAG     && (cd /rocks/avro && luarocks make *rockspec)
      \    && : \"expirationd\"     && git clone $LUAROCK_EXPIRATIOND_REPO /rocks/expirationd
      \    && git -C /rocks/expirationd checkout $LUAROCK_EXPIRATIOND_TAG     && (cd
      /rocks/expirationd && luarocks make *rockspec)     && : \"queue\"     && git
      clone $LUAROCK_QUEUE_REPO /rocks/queue     && git -C /rocks/queue checkout $LUAROCK_QUEUE_TAG
      \    && (cd /rocks/queue && luarocks make *rockspec)     && : \"connpool\"     &&
      git clone $LUAROCK_CONNPOOL_REPO /rocks/connpool     && git -C /rocks/connpool
      checkout $LUAROCK_CONNPOOL_TAG     && (cd /rocks/connpool && luarocks make *rockspec)
      \    && : \"shard\"     && git clone $LUAROCK_SHARD_REPO /rocks/shard     &&
      git -C /rocks/shard checkout $LUAROCK_SHARD_TAG     && (cd /rocks/shard && luarocks
      make *rockspec)     && : \"http\"     && git clone $LUAROCK_HTTP_REPO /rocks/http
      \    && git -C /rocks/http checkout $LUAROCK_HTTP_TAG     && (cd /rocks/http
      && luarocks make *rockspec)     && : \"prometheus\"     && git clone $LUAROCK_TARANTOOL_PROMETHEUS_REPO
      /rocks/prometheus     && git -C /rocks/prometheus checkout $LUAROCK_TARANTOOL_PROMETHEUS_TAG
      \    && (cd /rocks/prometheus && luarocks make *rockspec)     && : \"curl\"
      \    && git clone $LUAROCK_TARANTOOL_CURL_REPO /rocks/curl     && git -C /rocks/curl
      checkout $LUAROCK_TARANTOOL_CURL_TAG     && (cd /rocks/curl && luarocks make
      *rockspec)     && : \"---------- remove build deps ----------\"     && apt-get
      purge -y $BUILD_PACKAGES     && apt-get autoremove -y \t&& rm -rf /var/lib/apt/lists/*"
    Name: run
    PrependShell: true
  - CmdLine:
    - mkdir -p /var/lib/tarantool     && chown tarantool:tarantool /var/lib/tarantool     &&
      mkdir -p /opt/tarantool     && chown tarantool:tarantool /opt/tarantool     &&
      mkdir -p /var/run/tarantool     && chown tarantool:tarantool /var/run/tarantool     &&
      mkdir /etc/tarantool     && chown tarantool:tarantool /etc/tarantool
    Name: run
    PrependShell: true
  - Name: volume
    Volumes:
    - /var/lib/tarantool
  - Name: workdir
    Path: /opt/tarantool
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - tarantool-entrypoint.lua
    - /usr/local/bin/
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - tarantool_set_config.lua
    - /usr/local/bin/
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - docker-entrypoint.sh
    - /usr/local/bin/
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - console
    - /usr/local/bin/
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - tarantool_is_up
    - /usr/local/bin/
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - tarantool.default
    - /usr/local/etc/default/tarantool
  - CmdLine:
    - 'ln -s usr/local/bin/docker-entrypoint.sh /entrypoint.sh # backwards compat'
    Name: run
    PrependShell: true
  - CmdLine:
    - docker-entrypoint.sh
    Name: entrypoint
    PrependShell: false
  - Name: expose
    Ports:
    - "3301"
  - CmdLine:
    - tarantool
    Name: cmd
    PrependShell: false
  From:
    Image: debian:stable
  Name: ""
  Platform: ""
  SourceCode: FROM debian:stable
