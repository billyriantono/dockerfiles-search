{
  "MetaArgs": null,
  "Stages": [
    {
      "Name": "",
      "BaseName": "centos:7",
      "SourceCode": "FROM centos:7",
      "Platform": "",
      "From": {
        "Image": "centos:7"
      },
      "Commands": [
        {
          "Labels": [
            {
              "Key": "maintainer",
              "Value": "\"MiaoWoo(admin@yumc.pw)\""
            }
          ],
          "Name": "label"
        },
        {
          "Name": "workdir",
          "Path": "/opt"
        },
        {
          "Env": [
            {
              "Key": "VERSION",
              "Value": "1.5.5"
            },
            {
              "Key": "GUAC_VER",
              "Value": "1.0.0"
            },
            {
              "Key": "TOMCAT_VER",
              "Value": "9.0.29"
            }
          ],
          "Name": "env"
        },
        {
          "CmdLine": [
            "set -ex     \u0026\u0026 ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime     \u0026\u0026 yum -y localinstall --nogpgcheck https://mirrors.aliyun.com/rpmfusion/free/el/rpmfusion-free-release-7.noarch.rpm https://mirrors.aliyun.com/rpmfusion/nonfree/el/rpmfusion-nonfree-release-7.noarch.rpm     \u0026\u0026 rpm --import http://li.nux.ro/download/nux/RPM-GPG-KEY-nux.ro     \u0026\u0026 rpm -Uvh http://li.nux.ro/download/nux/dextop/el7/x86_64/nux-dextop-release-0-1.el7.nux.noarch.rpm     \u0026\u0026 yum -y install kde-l10n-Chinese glibc-common     \u0026\u0026 localedef -c -f UTF-8 -i zh_CN zh_CN.UTF-8 \u0026\u0026 export LC_ALL=zh_CN.UTF-8 \u0026\u0026 echo 'LANG=\"zh_CN.UTF-8\"' \u003e /etc/locale.conf     \u0026\u0026 yum -y install wget gcc epel-release git yum-utils python36 python36-devel java-1.8.0-openjdk libtool     \u0026\u0026 mkdir /usr/local/lib/freerdp/     \u0026\u0026 ln -s /usr/local/lib/freerdp /usr/lib64/freerdp     \u0026\u0026 yum install -y cairo-devel libjpeg-turbo-devel libpng-devel uuid-devel     \u0026\u0026 yum install -y ffmpeg-devel freerdp1.2-devel libvncserver-devel pulseaudio-libs-devel openssl-devel libvorbis-devel libwebp-devel     \u0026\u0026 echo -e \"[nginx-stable]\\nname=nginx stable repo\\nbaseurl=http://nginx.org/packages/centos/\\$releasever/\\$basearch/\\ngpgcheck=1\\nenabled=1\\ngpgkey=https://nginx.org/keys/nginx_signing.key\" \u003e /etc/yum.repos.d/nginx.repo     \u0026\u0026 rpm --import https://nginx.org/keys/nginx_signing.key     \u0026\u0026 yum -y install nginx     \u0026\u0026 rm -rf /etc/nginx/conf.d/default.conf     \u0026\u0026 mkdir -p /config/guacamole /config/guacamole/lib /config/guacamole/extensions     \u0026\u0026 wget https://www-eu.apache.org/dist/tomcat/tomcat-9/v${TOMCAT_VER}/bin/apache-tomcat-${TOMCAT_VER}.tar.gz     \u0026\u0026 tar xf apache-tomcat-${TOMCAT_VER}.tar.gz -C /config     \u0026\u0026 rm -rf apache-tomcat-${TOMCAT_VER}.tar.gz     \u0026\u0026 mv /config/apache-tomcat-${TOMCAT_VER} /config/tomcat9     \u0026\u0026 rm -rf /config/tomcat9/webapps/*     \u0026\u0026 sed -i 's/Connector port=\"8080\"/Connector port=\"8081\"/g' /config/tomcat9/conf/server.xml     \u0026\u0026 sed -i 's/level = FINE/level = OFF/g' /config/tomcat9/conf/logging.properties     \u0026\u0026 sed -i 's/level = INFO/level = OFF/g' /config/tomcat9/conf/logging.properties     \u0026\u0026 sed -i 's@CATALINA_OUT=\"$CATALINA_BASE\"/logs/catalina.out@CATALINA_OUT=/dev/null@g' /config/tomcat9/bin/catalina.sh     \u0026\u0026 echo \"java.util.logging.ConsoleHandler.encoding = UTF-8\" \u003e\u003e /config/tomcat9/conf/logging.properties     \u0026\u0026 yum clean all     \u0026\u0026 rm -rf /var/cache/yum/*"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "CmdLine": [
            "set -ex     \u0026\u0026 git clone --depth=1 https://github.com/jumpserver/jumpserver.git     \u0026\u0026 git clone --depth=1 https://github.com/jumpserver/docker-guacamole.git     \u0026\u0026 wget https://github.com/jumpserver/koko/releases/download/${VERSION}/koko-master-linux-amd64.tar.gz     \u0026\u0026 tar xf koko-master-linux-amd64.tar.gz     \u0026\u0026 mv kokodir koko     \u0026\u0026 chown -R root:root koko     \u0026\u0026 wget https://github.com/jumpserver/luna/releases/download/${VERSION}/luna.tar.gz     \u0026\u0026 tar xf luna.tar.gz     \u0026\u0026 chown -R root:root luna     \u0026\u0026 yum -y install $(cat /opt/jumpserver/requirements/rpm_requirements.txt)     \u0026\u0026 python3.6 -m venv /opt/py3     \u0026\u0026 source /opt/py3/bin/activate     \u0026\u0026 pip install wheel     \u0026\u0026 pip install --upgrade pip setuptools     \u0026\u0026 pip install -r /opt/jumpserver/requirements/requirements.txt     \u0026\u0026 cd docker-guacamole     \u0026\u0026 tar xf guacamole-server-${GUAC_VER}.tar.gz     \u0026\u0026 cd guacamole-server-${GUAC_VER}     \u0026\u0026 autoreconf -fi     \u0026\u0026 ./configure --with-init-dir=/etc/init.d     \u0026\u0026 make     \u0026\u0026 make install     \u0026\u0026 cd ..     \u0026\u0026 ln -sf /opt/docker-guacamole/guacamole-${GUAC_VER}.war /config/tomcat9/webapps/ROOT.war     \u0026\u0026 ln -sf /opt/docker-guacamole/guacamole-auth-jumpserver-${GUAC_VER}.jar /config/guacamole/extensions/guacamole-auth-jumpserver-${GUAC_VER}.jar     \u0026\u0026 ln -sf /opt/docker-guacamole/root/app/guacamole/guacamole.properties /config/guacamole/guacamole.properties     \u0026\u0026 rm -rf guacamole-server-${GUAC_VER}     \u0026\u0026 ldconfig     \u0026\u0026 cd /opt     \u0026\u0026 wget https://github.com/ibuler/ssh-forward/releases/download/v0.0.5/linux-amd64.tar.gz     \u0026\u0026 tar xf linux-amd64.tar.gz -C /bin/     \u0026\u0026 chmod +x /bin/ssh-forward     \u0026\u0026 wget -O /etc/nginx/conf.d/jumpserver.conf https://demo.jumpserver.org/download/nginx/conf.d/jumpserver.conf     \u0026\u0026 yum clean all     \u0026\u0026 rm -rf /var/cache/yum/*     \u0026\u0026 rm -rf /opt/*.tar.gz     \u0026\u0026 rm -rf ~/.cache/pip"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "Chown": "",
          "From": "",
          "Name": "copy",
          "SourcesAndDest": [
            "entrypoint.sh",
            "/bin/entrypoint.sh"
          ]
        },
        {
          "CmdLine": [
            "chmod +x /bin/entrypoint.sh"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "Name": "volume",
          "Volumes": [
            "/opt/jumpserver/data/media"
          ]
        },
        {
          "Env": [
            {
              "Key": "SECRET_KEY",
              "Value": "kWQdmdCQKjaWlHYpPhkNQDkfaRulM6YnHctsHLlSPs8287o2kW"
            },
            {
              "Key": "BOOTSTRAP_TOKEN",
              "Value": "KXOeyNgDeTdpeu9q"
            }
          ],
          "Name": "env"
        },
        {
          "Env": [
            {
              "Key": "DB_ENGINE",
              "Value": "mysql"
            },
            {
              "Key": "DB_HOST",
              "Value": "127.0.0.1"
            },
            {
              "Key": "DB_PORT",
              "Value": "3306"
            },
            {
              "Key": "DB_USER",
              "Value": "jumpserver"
            },
            {
              "Key": "DB_PASSWORD",
              "Value": "weakPassword"
            },
            {
              "Key": "DB_NAME",
              "Value": "jumpserver"
            }
          ],
          "Name": "env"
        },
        {
          "Env": [
            {
              "Key": "REDIS_HOST",
              "Value": "127.0.0.1"
            },
            {
              "Key": "REDIS_PORT",
              "Value": "6379"
            },
            {
              "Key": "REDIS_PASSWORD",
              "Value": ""
            }
          ],
          "Name": "env"
        },
        {
          "Env": [
            {
              "Key": "JUMPSERVER_KEY_DIR",
              "Value": "/config/guacamole/keys"
            },
            {
              "Key": "GUACAMOLE_HOME",
              "Value": "/config/guacamole"
            },
            {
              "Key": "GUACAMOLE_LOG_LEVEL",
              "Value": "ERROR"
            },
            {
              "Key": "JUMPSERVER_CLEAR_DRIVE_SESSION",
              "Value": "true"
            },
            {
              "Key": "JUMPSERVER_ENABLE_DRIVE",
              "Value": "true"
            },
            {
              "Key": "JUMPSERVER_SERVER",
              "Value": "http://127.0.0.1:8080"
            }
          ],
          "Name": "env"
        },
        {
          "Name": "expose",
          "Ports": [
            "80"
          ]
        },
        {
          "CmdLine": [
            "entrypoint.sh"
          ],
          "Name": "entrypoint",
          "PrependShell": false
        }
      ]
    }
  ]
}