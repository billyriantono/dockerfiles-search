MetaArgs: null
Stages:
- BaseName: ubuntu:18.04
  Commands:
  - Maintainer: rb@egroupware.org
    Name: maintainer
  - Key: VERSION
    Name: arg
    Value: 19.1.x-dev
  - CmdLine:
    - "apt-get update \t&& apt-get install -y software-properties-common \t&& LC_ALL=C.UTF-8
      add-apt-repository -y ppa:ondrej/php \t&& apt-get update \t&& bash -c \"apt-get
      install -y php7.3-{cli,mysql,json,gd,xsl,bz2,opcache,apcu,tidy,zip,bcmath,mbstring,smbclient,ldap,curl,fpm,pgsql,gmp}\"
      \t&& sed -e 's/^;\\?listen \\?=.*/listen = 9000/g' \t\t-e '/allowed_clients/d'
      \t\t-e '/pm.max_children/s/=.*/= 80/' \t\t-e '/catch_workers_output/s/^;/;/'
      \t\t-e '/error_log/d' \t\t-e 's/^;\\?pm.max_requests =.*/pm.max_requests = 30/'
      \t\t-e 's/^;\\?php_admin_value\\[memory_limit\\].*/php_admin_value[memory_limit]
      = 172M/' \t\t-e 's/^;\\?request_terminate_timeout.*/request_terminate_timeout
      = 70m/' \t\t-i /etc/php/7.3/fpm/pool.d/www.conf \t&& sed \t-e 's/^;\\?session.gc_maxlifetime.*/session.gc_maxlifetime=14400/g'
      \t\t-e 's|^;\\?date.timezone.*|date.timezone = UTC|g' \t\t-e 's|^;\\?sys_temp_dir.*|sys_temp_dir
      = /tmp|g' \t\t-e 's|^;\\?disable_functions.*|disable_functions = exec,passthru,shell_exec,system,proc_open,popen|g'
      \t\t-e 's|^;\\?max_execution_time \\?=.*|max_execution_time = 90|g' \t\t-e 's|^;\\?upload_max_filesize
      \\?=.*|upload_max_filesize = 64M|g' \t\t-e 's|^;\\?post_max_size \\?=.*|post_max_size
      = 65M|g' \t\t-e 's|^;\\?max_input_vars \\?=.*|max_input_vars = 2000|g' \t\t-e
      's|^;\\?zlib.output_compression \\?=.*|zlib.output_compression = On|g' \t\t-e
      's|^;\\?opcache.validate_timestamps \\?=.*|opcache.validate_timestamps=0|g'
      \t\t-i /etc/php/7.3/fpm/php.ini \t&& sed \t-e 's|^;\\?date.timezone.*|date.timezone
      = UTC|g' \t\t-e 's|^;\\?sys_temp_dir.*|sys_temp_dir = /tmp|g' \t\t-i /etc/php/7.3/cli/php.ini
      \t&& mkdir -p /run/php \t&& ln -s /dev/stderr /var/log/php7.3-fpm.log \t&& apt-get
      install -y rsync npm zip curl sudo cron patch \t&& npm install -g grunt-cli
      \t&& bash -c 'EXPECTED_SIGNATURE=$(curl https://composer.github.io/installer.sig);
      curl https://getcomposer.org/installer > composer-setup.php; ACTUAL_SIGNATURE=$(php
      -r \"echo hash_file(\\\"sha384\\\", \\\"composer-setup.php\\\");\"); if [ \"$EXPECTED_SIGNATURE\"
      != \"$ACTUAL_SIGNATURE\" ]; then     >&2 echo \"ERROR: Invalid Composer installer
      signature\";     RESULT=1; else \tphp composer-setup.php --quiet --install-dir
      /usr/local/bin; \tRESULT=$?; fi; rm composer-setup.php; exit $RESULT' \t&& cd
      /usr/share \t&& composer.phar create-project --prefer-dist --no-scripts egroupware/egroupware:$VERSION
      \t&& cd egroupware \t&& npm install \t&& grunt \t&& composer.phar clear-cache
      \t&& rm -f /usr/local/bin/composer.phar \t&& npm uninstall -g grunt-cli \t&&
      npm cache clear \t&& apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false
      npm zip \t&& apt-get clean \t&& mkdir -p /var/lib/egroupware/default/files/sqlfs
      \t&& mkdir -p /var/lib/egroupware/default/backup \t&& chown -R www-data:www-data
      /var/lib/egroupware \t&& chmod 700 /var/lib/egroupware/ \t&& ln -s /var/lib/egroupware/header.inc.php
      /usr/share/egroupware \t&& sed 's/apache/www-data/' doc/rpm-build/egroupware.cron
      > /etc/cron.d/egroupware \t&& patch -p1 < doc/rpm-build/asyncservice.patch \t&&
      echo \"TLS_REQCERT never\" >> /etc/ldap/ldap.conf \t&& mv /usr/share/egroupware
      /usr/share/egroupware-sources"
    Name: run
    PrependShell: true
  - Name: volume
    Volumes:
    - /usr/share/egroupware
  - Name: volume
    Volumes:
    - /var/lib/egroupware
  - Name: expose
    Ports:
    - "9000"
  - Chown: ""
    Name: add
    SourcesAndDest:
    - entrypoint.sh
    - /
  - CmdLine:
    - php-fpm7.3
    - --nodaemonize
    Name: cmd
    PrependShell: false
  - CmdLine:
    - /entrypoint.sh
    Name: entrypoint
    PrependShell: false
  From:
    Image: ubuntu:18.04
  Name: ""
  Platform: ""
  SourceCode: FROM ubuntu:18.04
