MetaArgs: null
Stages:
- BaseName: ubuntu:xenial
  Commands:
  - Maintainer: Miguel Moquillon "miguel.moquillon@silverpeas.org"
    Name: maintainer
  - Env:
    - Key: TERM
      Value: xterm
    Name: env
  - CmdLine:
    - apt-get update && apt-get install -y     wget     locales     procps     net-tools     zip     unzip     openjdk-8-jdk     ffmpeg     imagemagick     ghostscript     libreoffice     ure     gpgv   &&
      rm -rf /var/lib/apt/lists/*   && update-ca-certificates -f
    Name: run
    PrependShell: true
  - CmdLine:
    - wget -nc https://www.silverpeas.org/files/swftools-bin-0.9.2.zip   && echo 'd40bd091c84bde2872f2733a3c767b3a686c8e8477a3af3a96ef347cf05c5e43
      *swftools-bin-0.9.2.zip' | sha256sum -   && unzip swftools-bin-0.9.2.zip -d
      /   && rm swftools-bin-0.9.2.zip
    Name: run
    PrependShell: true
  - CmdLine:
    - wget -nc https://www.silverpeas.org/files/pdf2json-bin-0.68.zip   && echo 'eec849cdd75224f9d44c0999ed1fbe8764a773d8ab0cf7fff4bf922ab81c9f84
      *pdf2json-bin-0.68.zip' | sha256sum -   && unzip pdf2json-bin-0.68.zip -d /   &&
      rm pdf2json-bin-0.68.zip
    Name: run
    PrependShell: true
  - Key: DEFAULT_LOCALE
    Name: arg
    Value: en_US.UTF-8
  - CmdLine:
    - echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen   && echo "fr_FR.UTF-8 UTF-8" >>
      /etc/locale.gen   && echo "de_DE.UTF-8 UTF-8" >> /etc/locale.gen   && locale-gen   &&
      update-locale LANG=${DEFAULT_LOCALE} LANGUAGE=${DEFAULT_LOCALE} LC_ALL=${DEFAULT_LOCALE}
    Name: run
    PrependShell: true
  - Env:
    - Key: LANG
      Value: ${DEFAULT_LOCALE}
    Name: env
  - Env:
    - Key: LANGUAGE
      Value: ${DEFAULT_LOCALE}
    Name: env
  - Env:
    - Key: LC_ALL
      Value: ${DEFAULT_LOCALE}
    Name: env
  - Env:
    - Key: JAVA_HOME
      Value: /usr/lib/jvm/java-8-openjdk-amd64
    Name: env
  - Env:
    - Key: SILVERPEAS_HOME
      Value: /opt/silverpeas
    Name: env
  - Env:
    - Key: JBOSS_HOME
      Value: /opt/wildfly
    Name: env
  - Key: SILVERPEAS_VERSION
    Name: arg
    Value: 6.0.1
  - Key: WILDFLY_VERSION
    Name: arg
    Value: 10.1.0
  - Labels:
    - Key: name
      Value: '"Silverpeas 6"'
    - Key: description
      Value: '"An all-to-one image to run Silverpeas 6 for testing purpose"'
    - Key: vendor
      Value: '"Silverpeas"'
    - Key: version
      Value: ${SILVERPEAS_VERSION}
    - Key: build
      Value: "1"
    Name: label
  - CmdLine:
    - wget -nc https://www.silverpeas.org/files/silverpeas-${SILVERPEAS_VERSION}-wildfly${WILDFLY_VERSION%.?.?}.zip   &&
      wget -nc https://www.silverpeas.org/files/silverpeas-${SILVERPEAS_VERSION}-wildfly${WILDFLY_VERSION%.?.?}.zip.asc   &&
      gpg --keyserver ha.pool.sks-keyservers.net --recv-keys 3F4657EF9C591F2FEA458FEBC19391EB3DF442B6   &&
      gpg --batch --verify silverpeas-${SILVERPEAS_VERSION}-wildfly${WILDFLY_VERSION%.?.?}.zip.asc
      silverpeas-${SILVERPEAS_VERSION}-wildfly${WILDFLY_VERSION%.?.?}.zip   && wget
      -nc http://download.jboss.org/wildfly/${WILDFLY_VERSION}.Final/wildfly-${WILDFLY_VERSION}.Final.zip   &&
      unzip silverpeas-${SILVERPEAS_VERSION}-wildfly${WILDFLY_VERSION%.?.?}.zip -d
      /opt   && unzip wildfly-${WILDFLY_VERSION}.Final.zip -d /opt   && mv /opt/silverpeas-${SILVERPEAS_VERSION}-wildfly${WILDFLY_VERSION%.?.?}
      /opt/silverpeas   && mv /opt/wildfly-${WILDFLY_VERSION}.Final /opt/wildfly   &&
      rm *.zip   && mkdir -p /root/.m2
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - src/repository
    - /root/.m2/repository
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - src/settings.xml
    - /root/.m2/
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - src/config.properties
    - /opt/silverpeas/configuration/
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - src/CustomerSettings.xml
    - /opt/silverpeas/configuration/silverpeas/
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - src/99-confAuroraLooks.groovy
    - /opt/silverpeas/configuration/silverpeas/
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - src/h2
    - /opt/silverpeas/h2
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - src/data
    - /opt/silverpeas/data
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - src/silverpeas.gradle
    - /opt/silverpeas/bin/
  - CmdLine:
    - sed -i -e "s/APP_VER/${SILVERPEAS_VERSION}/g" /opt/silverpeas/bin/silverpeas.gradle
    Name: run
    PrependShell: true
  - Name: workdir
    Path: ${SILVERPEAS_HOME}/bin
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - src/run.sh
    - /opt/
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - src/ooserver
    - /opt/
  - CmdLine:
    - ./silverpeas clean install   && rm ../log/build-*   && touch .install
    Name: run
    PrependShell: true
  - Name: expose
    Ports:
    - "8000"
    - "9990"
  - Name: volume
    Volumes:
    - /opt/silverpeas/log
    - /opt/silverpeas/data
    - /opt/silverpeas/h2
  - CmdLine:
    - /opt/run.sh
    Name: cmd
    PrependShell: false
  From:
    Image: ubuntu:xenial
  Name: ""
  Platform: ""
  SourceCode: FROM ubuntu:xenial
