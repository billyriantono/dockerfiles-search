MetaArgs: null
Stages:
- BaseName: centos:6
  Commands:
  - Maintainer: nattapon <lordhackalot@gmail.com>
    Name: maintainer
  - Env:
    - Key: fileshared
      Value: 52.74.40.153
    Name: env
  - CmdLine:
    - rpm -i http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
    Name: run
    PrependShell: true
  - CmdLine:
    - rpm -i http://${fileshared}/python/ius-release-1.0-11.ius.centos6.noarch.rpm
    Name: run
    PrependShell: true
  - CmdLine:
    - yum groupinstall -y "Development tools"
    Name: run
    PrependShell: true
  - CmdLine:
    - yum install -y sudo tar libcurl-devel GeoIP GeoIP-devel python-devel postgresql-devel
    Name: run
    PrependShell: true
  - CmdLine:
    - 'sed -i -e "s/Defaults    requiretty.*/ #Defaults    requiretty/g" /etc/sudoers'
    Name: run
    PrependShell: true
  - CmdLine:
    - ulimit -n 65536
    Name: run
    PrependShell: true
  - Env:
    - Key: root_tmp
      Value: /root/tmp
    Name: env
  - CmdLine:
    - mkdir -p $root_tmp && curl -o ${root_tmp}/td-agent.conf -SL http://${fileshared}/fluentd/td-agent.conf
    Name: run
    PrependShell: true
  - CmdLine:
    - curl -o ${root_tmp}/Python-2.7.6.tar.xz -SL http://${fileshared}/fluentd/Python-2.7.6.tar.xz
    Name: run
    PrependShell: true
  - CmdLine:
    - curl -o ${root_tmp}/run.sh -SL http://${fileshared}/fluentd/run.sh
    Name: run
    PrependShell: true
  - CmdLine:
    - curl -o ${root_tmp}/td-agent-2.1.5-1.x86_64.rpm -SL http://${fileshared}/fluentd/td-agent-2.1.5-1.x86_64.rpm
      &&   yum localinstall -y ${root_tmp}/td-agent-2.1.5-1.x86_64.rpm
    Name: run
    PrependShell: true
  - CmdLine:
    - ls -l  ${root_tmp}/td-agent-2.1.5-1.x86_64.rpm
    Name: run
    PrependShell: true
  - CmdLine:
    - cp /etc/td-agent/td-agent.conf /etc/td-agent/td-agent.conf.orig && cp -f ${root_tmp}/td-agent.conf
      /etc/td-agent/
    Name: run
    PrependShell: true
  - CmdLine:
    - ln -s /usr/bin/gcc /usr/bin/gcc44
    Name: run
    PrependShell: true
  - CmdLine:
    - /usr/sbin/td-agent-gem install fluent-plugin-elasticsearch
    Name: run
    PrependShell: true
  - CmdLine:
    - /usr/sbin/td-agent-gem install fluent-plugin-format
    Name: run
    PrependShell: true
  - CmdLine:
    - /usr/sbin/td-agent-gem install  fluent-plugin-woothee
    Name: run
    PrependShell: true
  - CmdLine:
    - /usr/sbin/td-agent-gem install fluent-plugin-forest
    Name: run
    PrependShell: true
  - CmdLine:
    - /usr/sbin/td-agent-gem install fluent-plugin-record-reformer
    Name: run
    PrependShell: true
  - CmdLine:
    - /usr/sbin/td-agent-gem install fluent-plugin-geoip -v 0.4.0
    Name: run
    PrependShell: true
  - CmdLine:
    - yum install -y python27  python27-devel  python27-setuptools python27-mod_wsgi
    Name: run
    PrependShell: true
  - CmdLine:
    - curl -o ${root_tmp}/get-pip.py -sSL http://${fileshared}/python/get-pip.py
    Name: run
    PrependShell: true
  - CmdLine:
    - cd ${root_tmp} && python get-pip.py
    Name: run
    PrependShell: true
  - CmdLine:
    - pip install virtualenv
    Name: run
    PrependShell: true
  - CmdLine:
    - curl -o ${root_tmp}/requirements.txt -sSL http://${fileshared}/python/requirements.txt
    Name: run
    PrependShell: true
  - CmdLine:
    - curl -o ${root_tmp}/logger.tgz -sSL http://${fileshared}/python/logger.tgz
    Name: run
    PrependShell: true
  - CmdLine:
    - cd /opt && gzip -dc ${root_tmp}/logger.tgz  | tar xvf -
    Name: run
    PrependShell: true
  - CmdLine:
    - virtualenv --python=/usr/bin/python2.7 /opt/venv
    Name: run
    PrependShell: true
  - CmdLine:
    - source /opt/venv/bin/activate
    Name: run
    PrependShell: true
  - CmdLine:
    - pip install -r /opt/logger/requirements.txt || echo "true"
    Name: run
    PrependShell: true
  - Name: expose
    Ports:
    - "24224"
    - "8888"
  - CmdLine:
    - /bin/bash
    - /root/tmp/run.sh
    Name: entrypoint
    PrependShell: false
  From:
    Image: centos:6
  Name: ""
  Platform: ""
  SourceCode: FROM centos:6
