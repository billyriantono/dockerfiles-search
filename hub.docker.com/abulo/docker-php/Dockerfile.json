{
  "MetaArgs": null,
  "Stages": [
    {
      "Name": "",
      "BaseName": "ubuntu:16.04",
      "SourceCode": "FROM ubuntu:16.04",
      "Platform": "",
      "From": {
        "Image": "ubuntu:16.04"
      },
      "Commands": [
        {
          "Maintainer": "abulo.hoo@gmail.com",
          "Name": "maintainer"
        },
        {
          "Key": "LDAP_DOMAIN",
          "Name": "arg",
          "Value": "localhost"
        },
        {
          "Key": "LDAP_ORG",
          "Name": "arg",
          "Value": "ldap"
        },
        {
          "Key": "LDAP_HOSTNAME",
          "Name": "arg",
          "Value": "localhost"
        },
        {
          "Key": "LDAP_PASSWORD",
          "Name": "arg",
          "Value": "ldap"
        },
        {
          "CmdLine": [
            "sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/' /etc/apt/sources.list \u0026\u0026 \tgroupadd -r www \u0026\u0026 \tuseradd -r -g www www \u0026\u0026 \tmkdir -pv /home/www \u0026\u0026 \tapt-get -y update \u0026\u0026 \techo \"slapd slapd/root_password password ${LDAP_PASSWORD}\" | debconf-set-selections \u0026\u0026 \techo \"slapd slapd/root_password_again password ${LDAP_PASSWORD}\" | debconf-set-selections \u0026\u0026 \techo \"slapd slapd/internal/adminpw password ${LDAP_PASSWORD}\" | debconf-set-selections \u0026\u0026  \techo \"slapd slapd/internal/generated_adminpw password ${LDAP_PASSWORD}\" | debconf-set-selections \u0026\u0026 \techo \"slapd slapd/password2 password ${LDAP_PASSWORD}\" | debconf-set-selections \u0026\u0026 \techo \"slapd slapd/password1 password ${LDAP_PASSWORD}\" | debconf-set-selections \u0026\u0026 \techo \"slapd slapd/domain string ${LDAP_DOMAIN}\" | debconf-set-selections \u0026\u0026 \techo \"slapd shared/organization string ${LDAP_ORG}\" | debconf-set-selections \u0026\u0026 \techo \"slapd slapd/backend string HDB\" | debconf-set-selections \u0026\u0026 \techo \"slapd slapd/purge_database boolean true\" | debconf-set-selections \u0026\u0026 \techo \"slapd slapd/move_old_database boolean true\" | debconf-set-selections \u0026\u0026 \techo \"slapd slapd/allow_ldap_v2 boolean false\" | debconf-set-selections \u0026\u0026 \techo \"slapd slapd/no_configuration boolean false\" | debconf-set-selections \u0026\u0026 \tapt-get install --no-install-recommends -y -q  libxml2 libxml2-dev build-essential openssl libssl-dev make curl libjpeg-dev libpng-dev libmcrypt-dev libreadline6 libreadline6-dev libmhash-dev libfreetype6-dev libkrb5-dev libc-client2007e libc-client2007e-dev libbz2-dev libxslt1-dev libxslt1.1 libpq-dev libpng12-dev git autoconf automake m4 libmagickcore-dev libmagickwand-dev libcurl4-openssl-dev libltdl-dev libmhash2 libiconv-hook-dev libiconv-hook1 libpcre3-dev libgmp-dev gcc g++ ssh cmake re2c wget cron bzip2 rcconf flex vim bison mawk cpp binutils libncurses5 unzip tar libncurses5-dev libtool libpcre3 libpcrecpp0v5 zlibc libltdl3-dev slapd ldap-utils db5.3-util libldap2-dev libsasl2-dev net-tools libicu-dev libtidy-dev systemtap-sdt-dev libgmp3-dev gettext libexpat1-dev libz-dev libedit-dev libdmalloc-dev libevent-dev libyaml-dev autotools-dev pkg-config zlib1g-dev libcunit1-dev libev-dev libjansson-dev libc-ares-dev libjemalloc-dev cython python3-dev python-setuptools libreadline-dev perl  python3-pip zsh tcpdump strace gdb openbsd-inetd telnetd htop valgrind python-pip python-dev python-numpy python-scipy python3-numpy python3-scipy libopencv-dev mercurial bzr \u0026\u0026 apt-get clean \u0026\u0026 rm -rf /var/lib/apt/lists/* \u0026\u0026 ln -s /usr/include/x86_64-linux-gnu/gmp.h /usr/include/gmp.h \u0026\u0026 ln -s /usr/lib/x86_64-linux-gnu/libldap.so /usr/lib/ \u0026\u0026 ln -s /usr/lib/x86_64-linux-gnu/liblber.so /usr/lib/ \u0026\u0026 ln -s /usr/lib/libiconv_hook.so.1.0.0 /usr/lib/libiconv.so \u0026\u0026 ln -s /usr/lib/libiconv_hook.so.1.0.0 /usr/lib/libiconv.so.1"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "CmdLine": [
            "mkdir -pv /opt/soft \u0026\u0026 \tcd /opt/soft \u0026\u0026 \techo \"编译 Cmake\" \u0026\u0026 \twget -c -nv  https://cmake.org/files/v3.11/cmake-3.11.1.tar.gz \u0026\u0026 tar -zxf cmake-3.11.1.tar.gz \u0026\u0026 cd cmake-3.11.1 \u0026\u0026 ./bootstrap \u0026\u0026 make \u0026\u0026 make install  \u0026\u0026 \tcd /opt/soft \u0026\u0026 \techo \"编译 openssl\" \u0026\u0026 \twget -c -nv  https://www.openssl.org/source/openssl-1.0.2o.tar.gz  \u0026\u0026 tar -zxf openssl-1.0.2o.tar.gz  \u0026\u0026 cd openssl-1.0.2o  \u0026\u0026  ./config shared --prefix=/usr/local/openssl --openssldir=/usr/lib/openssl   \u0026\u0026 make  \u0026\u0026 make install  \u0026\u0026 \tcd /opt/soft \u0026\u0026 \techo \"编译 hiredis\" \u0026\u0026 \twget -c -nv  https://github.com/redis/hiredis/archive/v0.13.3.tar.gz \u0026\u0026 tar -xzf v0.13.3.tar.gz \u0026\u0026 cd hiredis-0.13.3 \u0026\u0026 make -j \u0026\u0026 make install \u0026\u0026 ldconfig \u0026\u0026 mkdir -pv /usr/lib/hiredis \u0026\u0026 cp libhiredis.so /usr/lib/hiredis \u0026\u0026 mkdir -pv /usr/include/hiredis \u0026\u0026  cp hiredis.h /usr/include/hiredis \u0026\u0026 \tcd /opt/soft \u0026\u0026 \techo \"编译 inotify-tools\" \u0026\u0026  \twget -c -nv  https://github.com/rvoicilas/inotify-tools/archive/3.20.1.tar.gz \u0026\u0026 tar -zxf 3.20.1.tar.gz \u0026\u0026 cd inotify-tools-3.20.1 \u0026\u0026 ./autogen.sh \u0026\u0026 ./configure \u0026\u0026 make \u0026\u0026 make install \u0026\u0026 ln -sv /usr/local/lib/libinotify* /usr/lib/ \u0026\u0026 \tcd /opt/soft \u0026\u0026 \techo \"编译 nghttp2\" \u0026\u0026 \twget -c -nv  https://github.com/nghttp2/nghttp2/releases/download/v1.31.1/nghttp2-1.31.1.tar.gz \u0026\u0026 tar -zxf nghttp2-1.31.1.tar.gz \u0026\u0026 cd nghttp2-1.31.1 \u0026\u0026 ./configure \u0026\u0026 make \u0026\u0026 make install \u0026\u0026 \tcd /opt/soft \u0026\u0026 \techo \"编译 jemalloc\" \u0026\u0026 \twget -c -nv  https://github.com/jemalloc/jemalloc/releases/download/4.0.4/jemalloc-4.0.4.tar.bz2 \u0026\u0026  tar -jxvf jemalloc-4.0.4.tar.bz2 \u0026\u0026 cd jemalloc-4.0.4/ \u0026\u0026 ./configure --with-jemalloc-prefix=je_ --prefix=/usr/local/jemalloc \u0026\u0026 make \u0026\u0026 make install \u0026\u0026 \tcd /opt/soft \u0026\u0026 \techo \"编译 libsodium\" \u0026\u0026 \twget -c -nv  https://github.com/jedisct1/libsodium/archive/1.0.16.tar.gz \u0026\u0026 tar -zxf 1.0.16.tar.gz \u0026\u0026  cd libsodium-1.0.16  \u0026\u0026 ./autogen.sh \u0026\u0026 ./configure \u0026\u0026 make \u0026\u0026 make check \u0026\u0026 make install  \u0026\u0026 \tcd /opt/soft \u0026\u0026 \techo \"敏感词过滤\" \u0026\u0026 \twget -c -nv  ftp://linux.thai.net/pub/ThaiLinux/software/libthai/libdatrie-0.2.5.tar.gz \u0026\u0026 tar -zxf libdatrie-0.2.5.tar.gz \u0026\u0026 cd  libdatrie-0.2.5 \u0026\u0026 ./configure  --prefix=/usr/local/libdatrie \u0026\u0026 make \u0026\u0026 make install \u0026\u0026 rm -rf /opt/soft"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "CmdLine": [
            "mkdir -pv /opt/soft \u0026\u0026 cd /opt/soft \u0026\u0026 wget -c -nv  http://cn2.php.net/distributions/php-7.1.16.tar.gz \u0026\u0026 tar -zxf php-7.1.16.tar.gz \u0026\u0026  cd php-7.1.16 \u0026\u0026 ./buildconf --force \u0026\u0026 ./configure --prefix=/usr/local/php --with-config-file-path=/usr/local/php/etc --with-config-file-scan-dir=/usr/local/php/etc/php.d --enable-bcmath --enable-calendar  --enable-exif --enable-ftp --enable-gd-native-ttf --enable-intl --enable-mbregex --enable-mbstring --enable-shmop --enable-soap --enable-sockets --enable-sysvmsg --enable-sysvsem --enable-sysvshm --enable-wddx --enable-dba --enable-zip --with-freetype-dir --with-gd --with-gettext --with-iconv --with-icu-dir=/usr --with-jpeg-dir --with-kerberos --with-libedit --with-mhash --with-openssl  --with-png-dir --with-xmlrpc --with-zlib --with-zlib-dir --with-bz2 --enable-fpm --with-fpm-user=www --with-fpm-group=www --with-gmp --with-curl --with-xsl --with-ldap --with-ldap-sasl=/usr --enable-pcntl --with-tidy --enable-zend-signals --enable-dtrace  --with-mysqli=mysqlnd   --with-pdo-mysql=mysqlnd  --enable-pdo  --enable-opcache --with-mcrypt --enable-gd-jis-conv --with-imap --with-imap-ssl --with-libxml-dir --enable-shared --with-pcre-regex  --with-sqlite3 --with-cdb  --enable-fileinfo --enable-filter --with-pcre-dir  --with-openssl-dir  --enable-json  --enable-mbregex-backtrack  --with-onig  --with-pdo-sqlite --with-readline --enable-session --enable-simplexml   --enable-mysqlnd-compression-support --with-pear \u0026\u0026 sed -i 's/EXTRA_LIBS.*/\u0026 -llber/g' Makefile \u0026\u0026 make \u0026\u0026 make install \u0026\u0026 cp /opt/soft/php-7.1.16/sapi/fpm/init.d.php-fpm /etc/init.d/php-fpm \u0026\u0026 chmod +x /etc/init.d/php-fpm \u0026\u0026 rm -rf /opt/soft \u0026\u0026 ln -s /usr/local/php/bin/* /usr/local/bin/"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "CmdLine": [
            "mkdir -pv /opt/soft \u0026\u0026 \tcd /opt/soft \u0026\u0026 \techo \"编译 libsodium-php\" \u0026\u0026 \tgit clone https://github.com/jedisct1/libsodium-php.git \u0026\u0026 cd libsodium-php \u0026\u0026 git checkout 2.0.10 \u0026\u0026 /usr/local/php/bin/phpize \u0026\u0026 ./configure --with-php-config=/usr/local/php/bin/php-config \u0026\u0026 make \u0026\u0026 make install \u0026\u0026 \tcd /opt/soft \u0026\u0026 \techo \"编译 php-ds\" \u0026\u0026 \tgit clone https://github.com/php-ds/extension.git \u0026\u0026 cd extension \u0026\u0026 /usr/local/php/bin/phpize \u0026\u0026 ./configure --with-php-config=/usr/local/php/bin/php-config \u0026\u0026 make \u0026\u0026 make install \u0026\u0026 \tcd /opt/soft \u0026\u0026 \techo \"编译 redis 插件\" \u0026\u0026 \twget -c -nv  http://pecl.php.net/get/redis-4.0.2.tgz \u0026\u0026 tar -zxf redis-4.0.2.tgz \u0026\u0026 cd redis-4.0.2 \u0026\u0026 /usr/local/php/bin/phpize \u0026\u0026 ./configure --with-php-config=/usr/local/php/bin/php-config \u0026\u0026 make \u0026\u0026 make install \u0026\u0026 \tcd /opt/soft \u0026\u0026 \techo \"编译 event 插件\" \u0026\u0026 \twget -c -nv  http://pecl.php.net/get/event-2.3.0.tgz \u0026\u0026 tar -zxf event-2.3.0.tgz \u0026\u0026 cd event-2.3.0 \u0026\u0026 /usr/local/php/bin/phpize \u0026\u0026 ./configure   --with-php-config=/usr/local/php/bin/php-config --with-event-core --with-event-extra \u0026\u0026 make \u0026\u0026 make install \u0026\u0026 \tcd /opt/soft \u0026\u0026 \techo \"编译 yaml 插件\" \u0026\u0026 \twget -c -nv  http://pecl.php.net/get/yaml-2.0.2.tgz \u0026\u0026 tar -zxf yaml-2.0.2.tgz \u0026\u0026 cd yaml-2.0.2 \u0026\u0026 /usr/local/php/bin/phpize \u0026\u0026 ./configure  --with-php-config=/usr/local/php/bin/php-config  \u0026\u0026 make \u0026\u0026 make install \u0026\u0026 \tcd /opt/soft \u0026\u0026 \techo \"编译 msgpack 插件\" \u0026\u0026 \twget -c -nv  http://pecl.php.net/get/msgpack-2.0.2.tgz \u0026\u0026 tar -zxf  msgpack-2.0.2.tgz \u0026\u0026 cd msgpack-2.0.2 \u0026\u0026 /usr/local/php/bin/phpize \u0026\u0026 ./configure  --with-php-config=/usr/local/php/bin/php-config  \u0026\u0026 make \u0026\u0026 make install \u0026\u0026 \tcd /opt/soft \u0026\u0026 \techo \"编译 inotify 插件\" \u0026\u0026 \twget -c -nv  http://pecl.php.net/get/inotify-2.0.0.tgz  \u0026\u0026 tar -zxf  inotify-2.0.0.tgz  \u0026\u0026 cd inotify-2.0.0 \u0026\u0026 /usr/local/php/bin/phpize \u0026\u0026 ./configure  --with-php-config=/usr/local/php/bin/php-config  \u0026\u0026 make \u0026\u0026 make install \u0026\u0026 \tcd /opt/soft \u0026\u0026 \techo \"编译 mongodb 插件\" \u0026\u0026 \twget -c -nv  http://pecl.php.net/get/mongodb-1.4.3.tgz \u0026\u0026 tar -zxf mongodb-1.4.3.tgz \u0026\u0026 cd mongodb-1.4.3 \u0026\u0026 /usr/local/php/bin/phpize \u0026\u0026 ./configure  --with-php-config=/usr/local/php/bin/php-config  \u0026\u0026 make \u0026\u0026 make install \u0026\u0026 \tcd /opt/soft \u0026\u0026 \techo \"敏感词过滤PHP 扩展\" \u0026\u0026 \twget -c -nv  https://github.com/abulo/php-ext-trie-filter/archive/v1.0.tar.gz \u0026\u0026 tar zxvf v1.0.tar.gz  \u0026\u0026 cd php-ext-trie-filter-1.0  \u0026\u0026  /usr/local/php/bin/phpize \u0026\u0026  ./configure   --with-php-config=/usr/local/php/bin/php-config  --with-trie_filter=/usr/local/libdatrie \u0026\u0026 make \u0026\u0026 make install \u0026\u0026 \tcd /opt/soft \u0026\u0026 \techo \"编译PHP-X\" \u0026\u0026 \tgit clone https://github.com/swoole/PHP-X.git \u0026\u0026 cd PHP-X \u0026\u0026 cmake . -DPHP_CONFIG_DIR=/usr/local/php/bin \u0026\u0026 cmake . \u0026\u0026 make install \u0026\u0026 \tcd /opt/soft \u0026\u0026 \techo \"编译swoole\" \u0026\u0026 \twget -c -nv  https://github.com/swoole/swoole-src/archive/v2.1.3.tar.gz \u0026\u0026 tar -zxf v2.1.3.tar.gz  \u0026\u0026 cd swoole-src-2.1.3  \u0026\u0026  /usr/local/php/bin/phpize \u0026\u0026 ./configure  --enable-swoole-debug --enable-sockets --enable-openssl --with-openssl-dir=/usr/local/openssl --enable-http2 --enable-async-redis --enable-swoole  --enable-coroutine --enable-timewheel --enable-mysqlnd --with-jemalloc-dir=/usr/local/jemalloc --enable-coroutine-postgresql --with-php-config=/usr/local/php/bin/php-config  \u0026\u0026 make \u0026\u0026 make install \u0026\u0026 \trm -rf /opt/soft"
          ],
          "Name": "run",
          "PrependShell": true
        },
        {
          "Chown": "",
          "From": "",
          "Name": "copy",
          "SourcesAndDest": [
            "php-fpm.conf",
            "/usr/local/php/etc/",
            "www.conf",
            "/usr/local/php/etc/php-fpm.d/",
            "php.ini",
            "/usr/local/php/etc/"
          ]
        },
        {
          "Name": "user",
          "User": "www"
        },
        {
          "Name": "workdir",
          "Path": "/home/www"
        }
      ]
    }
  ]
}