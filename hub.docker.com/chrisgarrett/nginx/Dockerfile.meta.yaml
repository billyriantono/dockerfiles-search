MetaArgs: null
Stages:
- As: build_modsecurity
  BaseName: nginxinc/nginx-unprivileged:1.17.6-alpine
  Commands:
  - Name: user
    User: root
  - CmdLine:
    - apk add --no-cache --virtual .build-deps         gcc         libc-dev         make         openssl-dev         pcre-dev         zlib-dev         linux-headers         curl         gnupg         libxslt-dev         gd-dev         perl-dev     &&
      apk add --no-cache --virtual .libmodsecurity-deps         pcre-dev         libxml2-dev         git         libtool         automake         autoconf         g++         flex         bison         yajl-dev     &&
      apk add --no-cache         geoip         geoip-dev         yajl         libstdc++         git         sed         libmaxminddb-dev
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /opt/ModSecurity
  - CmdLine:
    - echo "Installing ModSec Library" &&     git clone -b v3/master --single-branch
      https://github.com/SpiderLabs/ModSecurity . &&     git submodule init &&     git
      submodule update &&     ./build.sh &&     ./configure && make && make install
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /opt
  - CmdLine:
    - echo 'Installing ModSec - Nginx connector' &&     git clone --depth 1 https://github.com/SpiderLabs/ModSecurity-nginx.git
      &&     wget http://nginx.org/download/nginx-1.17.6.tar.gz &&     tar zxvf nginx-1.17.6.tar.gz
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /opt/GeoIP
  - CmdLine:
    - git clone -b master --single-branch https://github.com/leev/ngx_http_geoip2_module.git
      .
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /opt/nginx-1.17.6
  - CmdLine:
    - ./configure --with-compat --add-dynamic-module=../ModSecurity-nginx  --add-dynamic-module=../GeoIP
      &&     make modules &&     cp objs/ngx_http_modsecurity_module.so objs/ngx_http_geoip2_module.so
      /etc/nginx/modules &&     rm -f /usr/local/modsecurity/lib/libmodsecurity.a
      /usr/local/modsecurity/lib/libmodsecurity.la
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /opt
  - CmdLine:
    - echo "Begin installing ModSec OWASP Rules" &&     git clone -b v3.2/master https://github.com/SpiderLabs/owasp-modsecurity-crs
      &&     mv owasp-modsecurity-crs/ /usr/local/
    Name: run
    PrependShell: true
  - CmdLine:
    - mkdir /etc/nginx/modsec &&     rm -fr /etc/nginx/conf.d/ &&     rm -fr /etc/nginx/nginx.conf
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - conf/nginx/
    - /etc/nginx/
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - conf/modsec/
    - /etc/nginx/modsec/
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - conf/owasp/
    - /usr/local/owasp-modsecurity-crs/
  - CmdLine:
    - mkdir -p /etc/nginx/geoip &&     wget http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.tar.gz
      &&     wget http://geolite.maxmind.com/download/geoip/database/GeoLite2-Country.tar.gz
      &&     tar -xvzf GeoLite2-City.tar.gz --strip-components=1 &&     tar -xvzf
      GeoLite2-Country.tar.gz --strip-components=1 &&     mv *.mmdb /etc/nginx/geoip/
    Name: run
    PrependShell: true
  - CmdLine:
    - chown -R nginx:nginx /usr/share/nginx /etc/nginx
    Name: run
    PrependShell: true
  From:
    Image: nginxinc/nginx-unprivileged:1.17.6-alpine
  Name: build_modsecurity
  Platform: ""
  SourceCode: FROM nginxinc/nginx-unprivileged:1.17.6-alpine as build_modsecurity
- BaseName: nginxinc/nginx-unprivileged:1.17.6-alpine
  Commands:
  - Maintainer: Chris Garrett (https://github.com/chris-garrett/docker-nginx)
    Name: maintainer
  - Labels:
    - Key: description
      Value: '"Nginx image 1.17.6"'
    Name: label
  - Name: user
    User: root
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - ./vimrc
    - /home/nginx/.vimrc
  - CmdLine:
    - mkdir /etc/nginx/modsec &&     rm -fr /etc/nginx/conf.d/ &&     rm -fr /etc/nginx/nginx.conf
    Name: run
    PrependShell: true
  - Chown: ""
    From: build_modsecurity
    Name: copy
    SourcesAndDest:
    - /etc/nginx/.
    - /etc/nginx/
  - Chown: ""
    From: build_modsecurity
    Name: copy
    SourcesAndDest:
    - /usr/local/.
    - /usr/local/.
  - Chown: ""
    From: build_modsecurity
    Name: copy
    SourcesAndDest:
    - /usr/lib/nginx/modules/.
    - /usr/lib/nginx/modules/
  - CmdLine:
    - apk upgrade --no-cache   && apk --no-cache add -U     ca-certificates     openssl   &&
      update-ca-certificates   && apk --no-cache add -U     yajl     libstdc++     libmaxminddb-dev     tzdata     vim     wget     curl   &&
      wget https://github.com/jwilder/dockerize/releases/download/v0.6.1/dockerize-alpine-linux-amd64-v0.6.1.tar.gz   &&
      tar -C /usr/local/bin -xzvf dockerize-alpine-linux-amd64-v0.6.1.tar.gz   &&
      rm dockerize-alpine-linux-amd64-v0.6.1.tar.gz   && chown nginx:nginx /home/nginx/.vimrc
      /usr/share/nginx /etc/nginx   && ln -sf /usr/bin/vim /usr/bin/vi
    Name: run
    PrependShell: true
  - CmdLine:
    - chown -R 101:0 /var/cache/nginx /etc/nginx/conf.d     && chmod -R g+w /var/cache/nginx
      /etc/nginx/conf.d
    Name: run
    PrependShell: true
  - CmdLine:
    - mkdir -p /var/log/modsec   && chown -R nginx:nginx /var/log/modsec
    Name: run
    PrependShell: true
  - Name: user
    User: nginx
  - Name: workdir
    Path: /usr/share/nginx/html
  From:
    Image: nginxinc/nginx-unprivileged:1.17.6-alpine
  Name: ""
  Platform: ""
  SourceCode: FROM nginxinc/nginx-unprivileged:1.17.6-alpine
