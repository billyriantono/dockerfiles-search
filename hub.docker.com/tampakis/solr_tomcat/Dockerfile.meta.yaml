MetaArgs: null
Stages:
- BaseName: ubuntu:14.04
  Commands:
  - Maintainer: Nikitas Tampakis <nikitas.tampakis@gmail.com>
    Name: maintainer
  - Env:
    - Key: SOLR_VERSION
      Value: 4.10.0
    Name: env
  - Env:
    - Key: TOMCAT_VERSION
      Value: 7.0.59
    Name: env
  - Env:
    - Key: SOLR
      Value: solr-$SOLR_VERSION
    Name: env
  - Env:
    - Key: TOMCAT
      Value: apache-tomcat-$TOMCAT_VERSION
    Name: env
  - Env:
    - Key: SOLR_HOME
      Value: /usr/lib/solr-home
    Name: env
  - Env:
    - Key: TOMCAT_HOME
      Value: /usr/lib/$TOMCAT
    Name: env
  - Env:
    - Key: SOLR_ZK_CLI
      Value: /usr/lib/solr-zk-cli
    Name: env
  - CmdLine:
    - apt-get update && apt-get -y install         unzip         wget         default-jdk         git
    Name: run
    PrependShell: true
  - Name: workdir
    Path: /usr/lib
  - CmdLine:
    - "wget -q -nc http://archive.apache.org/dist/tomcat/tomcat-7/v$TOMCAT_VERSION/bin/$TOMCAT.zip
      && \tunzip -q /usr/lib/$TOMCAT.zip -d /usr/lib"
    Name: run
    PrependShell: true
  - CmdLine:
    - "wget -q -nc http://archive.apache.org/dist/lucene/solr/$SOLR_VERSION/$SOLR.zip
      && \tunzip -q /usr/lib/$SOLR.zip -d /usr/lib"
    Name: run
    PrependShell: true
  - CmdLine:
    - "cp /usr/lib/$SOLR/dist/$SOLR.war /usr/lib/$TOMCAT/webapps/solr.war && \tcp
      /usr/lib/$SOLR/example/lib/ext/* /usr/lib/$TOMCAT/lib/ && \tmkdir -p $SOLR_HOME"
    Name: run
    PrependShell: true
  - Chown: ""
    Name: add
    SourcesAndDest:
    - apache_tomcat_setenv.sh
    - /usr/lib/$TOMCAT/bin/setenv.sh
  - Chown: ""
    Name: add
    SourcesAndDest:
    - tomcat-users.xml
    - /usr/lib/$TOMCAT/conf/tomcat-users.xml
  - Chown: ""
    Name: add
    SourcesAndDest:
    - solr.xml
    - $SOLR_HOME/solr.xml
  - CmdLine:
    - mkdir -p $SOLR_ZK_CLI
    Name: run
    PrependShell: true
  - CmdLine:
    - unzip -q /usr/lib/$SOLR/dist/$SOLR.war -d /tmp/solr-war
    Name: run
    PrependShell: true
  - CmdLine:
    - cp  /tmp/solr-war/WEB-INF/lib/* $SOLR_ZK_CLI
    Name: run
    PrependShell: true
  - CmdLine:
    - cp /usr/lib/$SOLR/example/lib/ext/* $SOLR_ZK_CLI
    Name: run
    PrependShell: true
  - CmdLine:
    - rm -rf /tmp/solr-war
    Name: run
    PrependShell: true
  - CmdLine:
    - ln -s $SOLR_HOME /solr-home
    Name: run
    PrependShell: true
  - CmdLine:
    - ln -s $TOMCAT_HOME /tomcat-home
    Name: run
    PrependShell: true
  - CmdLine:
    - ln -s /usr/lib/$SOLR /solr-dist
    Name: run
    PrependShell: true
  - CmdLine:
    - ln -s $SOLR_ZK_CLI /solr-zk-cli
    Name: run
    PrependShell: true
  - CmdLine:
    - "git clone -b blacklight_511 https://github.com/pulibrary/orangelight.git &&
      \tmkdir $TOMCAT_HOME/conf/Catalina $TOMCAT_HOME/conf/Catalina/localhost && \techo
      '<Context docBase=\"/usr/lib/apache-tomcat-7.0.59/webapps/solr.war\" debug=\"0\"
      crossContext=\"true\" >   \t\t<Environment name=\"solr/home\" type=\"java.lang.String\"
      value=\"/solr-home\" override=\"true\" /> \t\t</Context>' > $TOMCAT_HOME/conf/Catalina/localhost/solr.xml\t&&
      \tmv /solr-dist/example/solr/collection1 /solr-home/blacklight-core && \tsed
      -i s/collection1/blacklight-core/g /solr-home/blacklight-core/core.properties
      && \tcp -r orangelight/solr_conf/conf/* /solr-home/blacklight-core/conf && \trm
      -r orangelight && \tmv /solr-home/blacklight-core/conf/lang/stopwords_en.txt
      /solr-home/blacklight-core/conf && \tmv /solr-dist/example/lib /solr-home &&
      \tmv /solr-dist/contrib /solr-home/lib"
    Name: run
    PrependShell: true
  - CmdLine:
    - chmod 755 -R $SOLR_HOME
    Name: run
    PrependShell: true
  - CmdLine:
    - chmod +x /usr/lib/$TOMCAT/bin/*.sh
    Name: run
    PrependShell: true
  - Name: expose
    Ports:
    - "8080"
  - CmdLine:
    - rm -f /usr/lib/$SOLR.zip && rm -rf /usr/lib/$TOMCAT.zip
    Name: run
    PrependShell: true
  From:
    Image: ubuntu:14.04
  Name: ""
  Platform: ""
  SourceCode: FROM ubuntu:14.04
