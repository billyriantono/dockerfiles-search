MetaArgs: null
Stages:
- BaseName: ubuntu:16.04
  Commands:
  - Maintainer: IMIM SRI <sri@imim.cat>
    Name: maintainer
  - Env:
    - Key: SLURM_VER
      Value: 16.05.11
    Name: env
  - CmdLine:
    - useradd -u 2001 -d /home/slurm slurm
    Name: run
    PrependShell: true
  - CmdLine:
    - useradd -u 6000 -ms /bin/bash ddhpc
    Name: run
    PrependShell: true
  - Chown: ""
    Name: add
    SourcesAndDest:
    - etc/sudoers.d/ddhpc
    - /etc/sudoers.d/ddhpc
  - Chown: ""
    Name: add
    SourcesAndDest:
    - home/ddhpc/ssh/config
    - /home/ddhpc/.ssh/config
  - Chown: ""
    Name: add
    SourcesAndDest:
    - home/ddhpc/ssh/id_rsa
    - /home/ddhpc/.ssh/id_rsa
  - Chown: ""
    Name: add
    SourcesAndDest:
    - home/ddhpc/ssh/id_rsa.pub
    - /home/ddhpc/.ssh/id_rsa.pub
  - Chown: ""
    Name: add
    SourcesAndDest:
    - home/ddhpc/ssh/authorized_keys
    - /home/ddhpc/.ssh/authorized_keys
  - CmdLine:
    - chown -R ddhpc:ddhpc /home/ddhpc/.ssh/
    Name: run
    PrependShell: true
  - CmdLine:
    - chmod 400 /home/ddhpc/.ssh/*
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get update && apt-get -y  dist-upgrade
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get install -y munge curl gcc make bzip2 supervisor python python-dev     libmunge-dev
      libmunge2 lua5.3 lua5.3-dev libopenmpi-dev openmpi-bin     gfortran vim python-mpi4py
      python-numpy python-psutil sudo psmisc     software-properties-common python-software-properties
      iputils-ping     openssh-server openssh-client libreadline6 libreadline6-dev
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get install -y tzdata
    Name: run
    PrependShell: true
  - Env:
    - Key: TZ
      Value: Europe/Madrid
    Name: env
  - CmdLine:
    - echo $TZ | tee /etc/timezone
    Name: run
    PrependShell: true
  - CmdLine:
    - dpkg-reconfigure --frontend noninteractive tzdata
    Name: run
    PrependShell: true
  - CmdLine:
    - curl -fsL https://download.schedmd.com/slurm/slurm-${SLURM_VER}.tar.bz2 | tar
      xfj - -C /opt/ &&     cd /opt/slurm-${SLURM_VER}/ &&     ./configure && make
      && make install
    Name: run
    PrependShell: true
  - Env:
    - Key: NOTVISIBLE
      Value: '"in users profile"'
    Name: env
  - CmdLine:
    - echo "export VISIBLE=now" >> /etc/profile
    Name: run
    PrependShell: true
  - CmdLine:
    - mkdir /var/run/sshd
    Name: run
    PrependShell: true
  - CmdLine:
    - echo 'ddhpc:ddhpc' | chpasswd
    Name: run
    PrependShell: true
  - CmdLine:
    - sed 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g'
      -i /etc/pam.d/sshd
    Name: run
    PrependShell: true
  - Chown: ""
    Name: add
    SourcesAndDest:
    - etc/supervisord.d/sshd.conf
    - /etc/supervisor/conf.d/sshd.conf
  - Chown: ""
    Name: add
    SourcesAndDest:
    - etc/munge/munge.key
    - /etc/munge/munge.key
  - CmdLine:
    - mkdir /var/run/munge &&     chown root /var/lib/munge &&     chown root /etc/munge
      && chmod 600 /var/run/munge &&     chmod 755  /run/munge &&     chmod 600 /etc/munge/munge.key
    Name: run
    PrependShell: true
  - Chown: ""
    Name: add
    SourcesAndDest:
    - etc/supervisord.d/munged.conf
    - /etc/supervisor/conf.d/munged.conf
  - Env:
    - Key: CONTAINERPILOT_VERSION
      Value: 2.7.2
    Name: env
  - Env:
    - Key: CONTAINERPILOT
      Value: file:///etc/containerpilot.json
    Name: env
  - CmdLine:
    - export CONTAINERPILOT_CHECKSUM=e886899467ced6d7c76027d58c7f7554c2fb2bcc     &&
      export archive=containerpilot-${CONTAINERPILOT_VERSION}.tar.gz     && curl -Lso
      /tmp/${archive}          "https://github.com/joyent/containerpilot/releases/download/${CONTAINERPILOT_VERSION}/${archive}"     &&
      echo "${CONTAINERPILOT_CHECKSUM}  /tmp/${archive}" | sha1sum -c     && tar zxf
      /tmp/${archive} -C /usr/local/bin     && rm /tmp/${archive}     && curl -sL
      https://github.com/sequenceiq/docker-alpine-dig/releases/download/v9.10.2/dig.tgz|tar
      -xzv -C /usr/local/bin/
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get update
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get -y install build-essential curl git sudo man vim autoconf libtool default-jdk
    Name: run
    PrependShell: true
  - CmdLine:
    - apt-get -y install python
    Name: run
    PrependShell: true
  - CmdLine:
    - git clone https://github.com/singularityware/singularity.git
    Name: run
    PrependShell: true
  - CmdLine:
    - cd singularity && ./autogen.sh && ./configure --prefix=/usr/local && make &&
      make install
    Name: run
    PrependShell: true
  - CmdLine:
    - cd /usr/local/bin && curl -fsSL get.nextflow.io | bash
    Name: run
    PrependShell: true
  - CmdLine:
    - chmod +rw /usr/local/bin/nextflow
    Name: run
    PrependShell: true
  - Chown: ""
    Name: add
    SourcesAndDest:
    - consul-template
    - /usr/local/bin/consul-template
  - CmdLine:
    - chmod +x /usr/local/bin/consul-template
    Name: run
    PrependShell: true
  - Name: expose
    Ports:
    - "22"
  From:
    Image: ubuntu:16.04
  Name: ""
  Platform: ""
  SourceCode: FROM ubuntu:16.04
