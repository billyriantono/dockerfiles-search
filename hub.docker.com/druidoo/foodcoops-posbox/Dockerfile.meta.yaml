MetaArgs: null
Stages:
- As: base
  BaseName: debian:jessie
  Commands:
  - Maintainer: Iv√°n Todorovich <ivan.todorovich@druidoo.io>
    Name: maintainer
  - Env:
    - Key: ODOO_SRC_PATH
      Value: '"/home/odoo/odoo-src"'
    Name: env
  - Env:
    - Key: ODOO_DEST
      Value: '"/home/odoo/odoo"'
    Name: env
  - Env:
    - Key: REPOSITORY_URL
      Value: '"https://github.com/AwesomeFoodCoops/odoo-production.git"'
    Name: env
  - Env:
    - Key: REPOSITORY_BRANCH
      Value: '"9.0"'
    Name: env
  - CmdLine:
    - "set -x;         apt-get update         && apt-get install -y --no-install-recommends
      \t    sudo \t    adduser \t    apache2 \t    postgresql-client \t    python
      python-dateutil \t    python-decorator \t    python-docutils \t    python-feedparser
      \t    python-imaging \t    python-jinja2 \t    python-ldap \t    python-libxslt1
      \t    python-lxml \t    python-mako \t    python-mock \t    python-openid \t
      \   python-passlib \t    python-psutil \t    python-psycopg2 \t    python-pybabel
      \t    python-pychart \t    python-pydot \t    python-pyparsing \t    python-pypdf
      \t    python-reportlab \t    python-requests \t    python-simplejson \t    python-tz
      python-unittest2 \t    python-vatnumber \t    python-vobject \t    python-werkzeug
      \t    python-xlwt \t    python-yaml \t    python-gevent \t    python-serial
      \t    python-pip \t    python-dev \t    net-tools \t    vim \t    mc \t    mg
      \t    screen \t    iw \t    hostapd \t    isc-dhcp-server \t    git \t    rsync
      \t    console-data \t    gcc \t    cron \t    usbutils"
    Name: run
    PrependShell: true
  - CmdLine:
    - "pip install pyusb==1.0b1 \t    qrcode==4.0.1 \t    evdev"
    Name: run
    PrependShell: true
  - CmdLine:
    - "apt-get install -y libyaml-dev libpython2.7-dev \t&& pip install pyyaml \t
      \   pycountry \t    pyserial"
    Name: run
    PrependShell: true
  - CmdLine:
    - "useradd --create-home --shell /bin/bash odoo \t&& groupadd usbusers \t&& usermod
      -a -G usbusers odoo \t&& usermod -a -G lp odoo"
    Name: run
    PrependShell: true
  - CmdLine:
    - echo '* * * * * rm /var/run/odoo/sessions/*' | crontab -
    Name: run
    PrependShell: true
  - CmdLine:
    - git clone -b "$REPOSITORY_BRANCH" --single-branch --depth 1 "$REPOSITORY_URL"
      "$ODOO_SRC_PATH"
    Name: run
    PrependShell: true
  - Name: workdir
    Path: '"$ODOO_SRC_PATH"'
  - CmdLine:
    - mkdir -p "$ODOO_DEST/addons"
    Name: run
    PrependShell: true
  - CmdLine:
    - cp -r "$ODOO_SRC_PATH/odoo/addons/web" $ODOO_DEST/addons/ || true
    Name: run
    PrependShell: true
  - CmdLine:
    - cp -r "$ODOO_SRC_PATH/odoo/addons/web_kanban" $ODOO_DEST/addons/ || true
    Name: run
    PrependShell: true
  - CmdLine:
    - cp -r ${ODOO_SRC_PATH}/odoo/addons/hw_* $ODOO_DEST/addons/ || true
    Name: run
    PrependShell: true
  - CmdLine:
    - mkdir -p "$ODOO_DEST/addons/point_of_sale/tools/posbox/"
    Name: run
    PrependShell: true
  - CmdLine:
    - cp -r "$ODOO_SRC_PATH/odoo/addons/point_of_sale/tools/posbox/configuration"
      $ODOO_DEST/addons/point_of_sale/tools/posbox/ || true
    Name: run
    PrependShell: true
  - CmdLine:
    - cp -r "$ODOO_SRC_PATH/odoo/openerp" $ODOO_DEST/ || true
    Name: run
    PrependShell: true
  - CmdLine:
    - cp -r "$ODOO_SRC_PATH/odoo/odoo.py" $ODOO_DEST/ || true
    Name: run
    PrependShell: true
  - CmdLine:
    - cp -r $ODOO_SRC_PATH/extra_addons/hw_* $ODOO_DEST/addons/ || true
    Name: run
    PrependShell: true
  - CmdLine:
    - cp -r $ODOO_SRC_PATH/OCA_addons/hw_* $ODOO_DEST/addons/ || true
    Name: run
    PrependShell: true
  - CmdLine:
    - cp -r $ODOO_SRC_PATH/louve_addons/hw_* $ODOO_DEST/addons/ || true
    Name: run
    PrependShell: true
  - CmdLine:
    - cp -r $ODOO_SRC_PATH/intercoop_addons/hw_* $ODOO_DEST/addons/ || true
    Name: run
    PrependShell: true
  - CmdLine:
    - chown -R odoo:odoo "$ODOO_DEST"
    Name: run
    PrependShell: true
  - CmdLine:
    - mkdir -p /var/run/odoo
    Name: run
    PrependShell: true
  - CmdLine:
    - touch /var/run/odoo/odoo.pid && chown odoo:odoo -R /var/run/odoo
    Name: run
    PrependShell: true
  - CmdLine:
    - rm -rf "$ODOO_SRC_PATH"
    Name: run
    PrependShell: true
  - Name: workdir
    Path: '"$ODOO_DEST"'
  - Name: user
    User: odoo
  - Name: volume
    Volumes:
    - /var/log/odoo
  - Name: expose
    Ports:
    - "8069"
  - Expression: ARG DB_HOST="db"
    Name: onbuild
  - Expression: ARG DB_USER="odoo"
    Name: onbuild
  - Expression: ARG DB_PASS="odoo"
    Name: onbuild
  - Expression: ARG SERVER_WIDE_MODULES="hw_proxy,hw_escpos"
    Name: onbuild
  - Expression: ENV DB_HOST="$DB_HOST"
    Name: onbuild
  - Expression: ENV DB_USER="$DB_USER"
    Name: onbuild
  - Expression: ENV DB_PASS="$DB_PASS"
    Name: onbuild
  - Expression: ENV SERVER_WIDE_MODULES="$SERVER_WIDE_MODULES"
    Name: onbuild
  - Expression: RUN echo "db_host = db" >> $ODOO_DEST/addons/point_of_sale/tools/posbox/configuration/odoo.conf  &&
      echo "db_user = odoo" >> $ODOO_DEST/addons/point_of_sale/tools/posbox/configuration/odoo.conf  &&
      echo "db_password = odoo" >> $ODOO_DEST/addons/point_of_sale/tools/posbox/configuration/odoo.conf  &&
      echo "server_wide_modules = ${SERVER_WIDE_MODULES}" >> $ODOO_DEST/addons/point_of_sale/tools/posbox/configuration/odoo.conf
    Name: onbuild
  - Expression: CMD ["/home/odoo/odoo/odoo.py", "-c", "/home/odoo/odoo/addons/point_of_sale/tools/posbox/configuration/odoo.conf"]
    Name: onbuild
  From:
    Image: debian:jessie
  Name: base
  Platform: ""
  SourceCode: FROM debian:jessie AS base
