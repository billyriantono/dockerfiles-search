MetaArgs: null
Stages:
- BaseName: alpine:3.6
  Commands:
  - Env:
    - Key: PYTHON_VERSION
      Value: 2.7.13-r1
    Name: env
  - Env:
    - Key: PY_PIP_VERSION
      Value: 9.0.1-r1
    Name: env
  - Env:
    - Key: SUPERVISOR_VERSION
      Value: 3.3.1
    Name: env
  - CmdLine:
    - echo "ipv6" >> /etc/modules
    Name: run
    PrependShell: true
  - CmdLine:
    - apk update &&     apk upgrade &&     apk add sudo &&     apk --no-cache add
      --update alpine-sdk &&     adduser -D -g '' r &&     echo '%sudo ALL=(ALL) NOPASSWD:ALL'
      >> /etc/sudoers &&     rm -rf /var/cache/apk/* &&     mkdir -p /run/php &&     apk
      --no-cache add vim &&     apk --no-cache add netcat-openbsd &&     apk --no-cache
      add ca-certificates wget &&     apk --no-cache add bash bash-doc bash-completion
      &&     apk --no-cache add openssl &&     apk --no-cache add openrc &&     rm
      -rf /var/cache/apk/*
    Name: run
    PrependShell: true
  - CmdLine:
    - addgroup -g 10001 -S www-data  && adduser -u 10001 -D -S -G www-data www-data
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - entry.sh
    - /entry.sh
  - CmdLine:
    - chmod +x /entry.sh
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - before-entry.sh
    - /before-entry.sh
  - CmdLine:
    - chmod +x /before-entry.sh
    Name: run
    PrependShell: true
  - CmdLine:
    - mkdir -p /usr/share/GeoIP
    Name: run
    PrependShell: true
  - CmdLine:
    - wget -q -O- http://geolite.maxmind.com/download/geoip/database/GeoLiteCountry/GeoIP.dat.gz
      | gunzip > /usr/share/GeoIP/GeoIP.dat
    Name: run
    PrependShell: true
  - CmdLine:
    - wget -q -O- http://geolite.maxmind.com/download/geoip/database/GeoLiteCity.dat.gz
      | gunzip > /usr/share/GeoIP/GeoLiteCity.dat
    Name: run
    PrependShell: true
  - CmdLine:
    - echo "@latest-stable http://dl-cdn.alpinelinux.org/alpine/latest-stable/main"
      >> /etc/apk/repositories
    Name: run
    PrependShell: true
  - CmdLine:
    - apk update &&     apk add nginx@latest-stable nginx-mod-http-geoip@latest-stable
      &&     rm -rf /var/cache/apk/*
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - nginx_geoip_params
    - /etc/nginx/geoip_params
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - nginx_log_format.conf
    - /etc/nginx/conf.d/10-nginx_log_format.conf
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - nginx_real_ip.conf
    - /etc/nginx/conf.d/10-nginx_real_ip.conf
  - CmdLine:
    - rm -rf /etc/nginx/conf.d/default.conf
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - vhost.conf
    - /etc/nginx/vhost.conf
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - _main-location-ip-rules.conf
    - /etc/nginx/conf/_main-location-ip-rules.conf
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - _more.conf
    - /etc/nginx/conf/_more.conf
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - _http-basic-auth.conf
    - /etc/nginx/conf/_http-basic-auth.conf
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - _htpasswd
    - /etc/nginx/conf/_htpasswd
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - nginx.conf
    - /etc/nginx/nginx.conf
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - entry.sh
    - /entry.sh
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - phpcheck.sh
    - /opt/docker/phpcheck.sh
  - CmdLine:
    - rm -rf /etc/nginx/sites-available && rm -rf /etc/nginx/sites-enabled
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - supervisor.conf
    - /opt/docker/etc/supervisor.conf
  - CmdLine:
    - apk update &&     apk upgrade &&     apk --no-cache add -u python2=$PYTHON_VERSION
      py-pip=$PY_PIP_VERSION &&     apk add --no-cache autoconf &&     pip install
      supervisor==$SUPERVISOR_VERSION &&     rm -rf /var/cache/apk/*
    Name: run
    PrependShell: true
  - CmdLine:
    - "echo 'http://dl-cdn.alpinelinux.org/alpine/3.6/main' >> /etc/apk/repositories
      &&     apk --update add         php7=7.1.9-r0         php7-bcmath         php7-dom
      \        php7-ctype         php7-curl         php7-fileinfo         php7-fpm
      \        php7-gd         php7-gmp         php7-iconv         php7-imagick         php7-intl
      \        php7-json         php7-mbstring         php7-mcrypt \tphp7-mysqli \tphp7-opcache
      \        php7-openssl \tphp7-redis         php7-pdo         php7-pdo_mysql         php7-pdo_pgsql
      \        php7-pdo_sqlite         php7-phar         php7-posix         php7-session
      \        php7-soap         php7-xml         php7-xmlreader         php7-xmlwriter
      \        php7-zip         php7-dev         php7-pear         php7-simplexml
      \        php7-tokenizer     && apk add --no-cache pcre-dev@latest-stable &&
      \    apk add --no-cache --virtual .mongodb-ext-build-deps openssl-dev &&     pecl
      install mongodb &&     pecl clear-cache &&     apk del .mongodb-ext-build-deps
      &&     rm -rf /var/cache/apk/*"
    Name: run
    PrependShell: true
  - CmdLine:
    - "set -x \t&& addgroup -g 82 -S application \t&& adduser -u 82 -D -S -G application
      application"
    Name: run
    PrependShell: true
  - CmdLine:
    - sed -i "s/nobody/application/g" /etc/php7/php-fpm.d/www.conf
    Name: run
    PrependShell: true
  - CmdLine:
    - sed -i "s/pm.max_children = 5/pm.max_children = 64/g" /etc/php7/php-fpm.d/www.conf
    Name: run
    PrependShell: true
  - CmdLine:
    - sed -i "s/pm.start_servers = 2/pm.start_servers = 12/g" /etc/php7/php-fpm.d/www.conf
    Name: run
    PrependShell: true
  - CmdLine:
    - sed -i "s/pm.min_spare_servers = 1/pm.min_spare_servers = 8/g" /etc/php7/php-fpm.d/www.conf
    Name: run
    PrependShell: true
  - CmdLine:
    - sed -i "s/pm.max_spare_servers = 3/pm.max_spare_servers = 16/g" /etc/php7/php-fpm.d/www.conf
    Name: run
    PrependShell: true
  - CmdLine:
    - sed -i "s/;pm.max_requests/pm.max_requests/g" /etc/php7/php-fpm.d/www.conf
    Name: run
    PrependShell: true
  - CmdLine:
    - sed -i "s/;pm.status_path = \/status/pm.status_path = \/fpm_status/g" /etc/php7/php-fpm.d/www.conf
    Name: run
    PrependShell: true
  - Chown: ""
    From: ""
    Name: copy
    SourcesAndDest:
    - 00_mongo.ini
    - /etc/php7/conf.d/
  - CmdLine:
    - php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
    Name: run
    PrependShell: true
  - CmdLine:
    - php -r "if (hash_file('SHA384', 'composer-setup.php') === '544e09ee996cdf60ece3804abc52599c22b1f40f4323403c44d44fdfdd586475ca9813a858088ffbc1f233e9b180f061')
      { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php');
      } echo PHP_EOL;"
    Name: run
    PrependShell: true
  - CmdLine:
    - php composer-setup.php --install-dir=/usr/local/bin --filename=composer
    Name: run
    PrependShell: true
  - CmdLine:
    - php -r "unlink('composer-setup.php');"
    Name: run
    PrependShell: true
  - Name: expose
    Ports:
    - "443"
    - "80"
  - CmdLine:
    - dos2unix /entry.sh
    Name: run
    PrependShell: true
  - CmdLine:
    - /entry.sh
    Name: cmd
    PrependShell: false
  From:
    Image: alpine:3.6
  Name: ""
  Platform: ""
  SourceCode: FROM alpine:3.6
